<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation & Check-In System | Vilu Lounge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <style>
        :root {
            --primary-color: #2c5282;
            --secondary-color: #38b2ac;
            --accent-color: #ed8936;
            --light-bg: #f7fafc;
            --dark-bg: #2d3748;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --info-color: #4299e1;
            --danger-color: #f56565;
            --foc-color: #9f7aea;
            --noshow-color: #718096;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body { 
            background-color: var(--light-bg); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #2d3748;
        }
        
        .dashboard-card { 
            transition: var(--transition); 
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            background: white;
            overflow: hidden;
        }
        
        .dashboard-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .login-container { 
            max-width: 400px; 
            margin: 100px auto; 
        }
        
        .nav-link { 
            color: #4a5568;
            font-weight: 500;
            border-radius: 0;
            padding: 12px 20px;
            transition: var(--transition);
        }
        
        .nav-link.active { 
            color: var(--primary-color);
            font-weight: 600;
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .nav-link:hover {
            color: var(--primary-color);
            background-color: rgba(44, 82, 130, 0.05);
        }
        
        .table-responsive { 
            max-height: 500px; 
            overflow-y: auto; 
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
        }
        
        /* Autocomplete Styles */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--box-shadow);
            width: 100%;
            margin-top: 2px;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
            color: #4a5568;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Status badges */
        .status-badge {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .status-reserved { 
            background-color: #feebc8; 
            color: #9c4221;
            border: 1px solid #fed7aa;
        }
        
        .status-checkedin { 
            background-color: #c6f6d5; 
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status-checkedout { 
            background-color: #bee3f8; 
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        
        .status-foc { 
            background-color: #e9d8fd; 
            color: #553c9a;
            border: 1px solid #d6bcfa;
        }
        
        .status-noshow { 
            background-color: #e2e8f0; 
            color: #2d3748;
            border: 1px solid #cbd5e0;
        }
        
        .status-cancelled { 
            background-color: #fed7d7; 
            color: #9b2c2c;
            border: 1px solid #fc8181;
        }
        
        /* Filter section */
        .filter-section {
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
        }
        
        /* Custom card headers */
        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2c5282 100%);
            border-bottom: none;
            color: white;
            font-weight: 600;
            padding: 15px 20px;
        }
        
        .card-header-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #38a169 100%);
        }
        
        .card-header-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #3182ce 100%);
        }
        
        .card-header-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #dd6b20 100%);
        }
        
        .card-header-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #e53e3e 100%);
        }
        
        .card-header-foc {
            background: linear-gradient(135deg, var(--foc-color) 0%, #805ad5 100%);
        }
        
        /* Form styles */
        .form-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }
        
        .form-control, .form-select {
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            padding: 10px 12px;
            transition: var(--transition);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
        }
        
        /* Button styles */
        .btn {
            border-radius: var(--border-radius);
            padding: 10px 20px;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #2a4365;
            border-color: #2a4365;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .btn-info {
            background-color: var(--info-color);
            border-color: var(--info-color);
        }
        
        .btn-foc {
            background-color: var(--foc-color);
            border-color: var(--foc-color);
            color: white;
        }
        
        .btn-foc:hover {
            background-color: #805ad5;
            border-color: #805ad5;
        }
        
        /* Navigation bar */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2c5282 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        /* Quick stats */
        .stats-card {
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
            color: white;
            border: none;
        }
        
        .stats-icon {
            font-size: 2.5rem;
            opacity: 0.9;
        }
        
        /* Report styles */
        .report-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        .company-info {
            flex: 1;
        }
        
        .company-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .company-address {
            color: #4a5568;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        /* Excel Upload Styles */
        .excel-upload-container {
            border: 2px dashed #cbd5e0;
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .excel-upload-container:hover {
            border-color: var(--primary-color);
            background: #edf2f7;
        }
        
        .excel-upload-container.dragover {
            border-color: var(--success-color);
            background: #f0fff4;
        }
        
        .excel-preview {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.875rem;
        }
        
        /* Passenger Type Colors */
        .passenger-reserved {
            border-left: 4px solid var(--warning-color);
        }
        
        .passenger-checkedin {
            border-left: 4px solid var(--success-color);
        }
        
        .passenger-checkedout {
            border-left: 4px solid var(--info-color);
        }
        
        .passenger-foc {
            border-left: 4px solid var(--foc-color);
        }
        
        .passenger-noshow {
            border-left: 4px solid var(--noshow-color);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .logo-container {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .stats-card {
                margin-bottom: 15px;
            }
            
            .nav-link {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
        
        /* Loading animation */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Table styles */
        .table {
            margin-bottom: 0;
        }
        
        .table thead th {
            background-color: #f8fafc;
            color: #4a5568;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            padding: 12px 15px;
        }
        
        .table tbody td {
            padding: 12px 15px;
            border-color: #e2e8f0;
            vertical-align: middle;
        }
        
        .table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        /* Alert styles */
        .alert {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: var(--box-shadow);
        }
        
        /* Modal styles */
        .modal-content {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* Tab content */
        .tab-content {
            padding: 20px 0;
        }
        
        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            .print-section { display: block !important; }
            body { background: white !important; }
        }
        
        /* Excel template download */
        .template-download {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .template-download:hover {
            color: #2a4365;
            text-decoration: underline;
        }
        
        /* Overview page styles */
        .overview-section {
            margin-bottom: 25px;
        }
        
        .overview-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .overview-card {
            height: 100%;
            transition: var(--transition);
        }
        
        .overview-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        /* Status filter buttons */
        .status-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .status-filter-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .status-filter-btn.active {
            color: white;
        }
        
        .status-filter-btn.reserved.active {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .status-filter-btn.checkedin.active {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .status-filter-btn.checkedout.active {
            background-color: var(--info-color);
            border-color: var(--info-color);
        }
        
        .status-filter-btn.foc.active {
            background-color: var(--foc-color);
            border-color: var(--foc-color);
        }
        
        .status-filter-btn.noshow.active {
            background-color: var(--noshow-color);
            border-color: var(--noshow-color);
        }
        
        /* Switch for FOC */
        .form-check-input:checked {
            background-color: var(--foc-color);
            border-color: var(--foc-color);
        }
        
        /* No-Show button */
        .btn-noshow {
            background-color: var(--noshow-color);
            border-color: var(--noshow-color);
            color: white;
        }
        
        .btn-noshow:hover {
            background-color: #4a5568;
            border-color: #4a5568;
        }

                /* Overview Card Scrollbars */
        .recent-reservations-scroll {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }

        .recent-reservations-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .recent-reservations-scroll::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 3px;
        }

        .recent-reservations-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 3px;
            border: 2px solid #f7fafc;
        }

        .recent-reservations-scroll::-webkit-scrollbar-thumb:hover {
            background-color: #a0aec0;
        }

        /* Fix table layout for scrollable cards */
        .overview-card .table {
            width: 100%;
            margin-bottom: 0;
        }

        .overview-card .table th {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
            box-shadow: 0 1px 0 #e2e8f0;
        }

        .overview-card .table tbody tr:last-child td {
            border-bottom: none;
        }

        .overview-card .table-sm th,
        .overview-card .table-sm td {
            padding: 8px 10px;
            white-space: nowrap;
        }

        .overview-card .table-sm th {
            font-size: 0.8rem;
            background-color: #f8fafc;
        }

        .overview-card .table-sm td {
            font-size: 0.85rem;
        }

        /* Hover effect for table rows */
        .overview-card .table tbody tr:hover {
            background-color: rgba(44, 82, 130, 0.05);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="card dashboard-card">
            <div class="card-header text-center py-4">
                <i class="fas fa-hotel fa-3x mb-3"></i>
                <h3 class="mb-2">Vilu Business Lounge</h3>
                <p class="mb-0 opacity-75">Reservation & Check-In System</p>
            </div>
            <div class="card-body p-4">
                <div class="mb-4">
                    <label class="form-label fw-bold">Username</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="fas fa-user text-primary"></i></span>
                        <input type="text" id="username" class="form-control border-start-0" placeholder="Enter username" autocomplete="username">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold">Password</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="fas fa-lock text-primary"></i></span>
                        <input type="password" id="password" class="form-control border-start-0" placeholder="Enter password" autocomplete="current-password">
                    </div>
                </div>
                <button id="loginBtn" class="btn btn-primary w-100 py-3">
                    <i class="fas fa-sign-in-alt me-2"></i> Login
                </button>
                <div id="loginError" class="alert alert-danger mt-3 d-none text-center"></div>
                <div class="text-center mt-3 text-muted small">
                    <i class="fas fa-info-circle me-1"></i>
                    Use your assigned credentials
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard (Initially Hidden) -->
    <div id="dashboard" class="d-none">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <i class="fas fa-hotel fa-lg me-2"></i>
                    <div>
                        <div class="fw-bold">Vilu Lounge</div>
                        <small class="opacity-75">Reservation System</small>
                    </div>
                </a>
                <div class="navbar-text text-white d-none d-lg-block">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <small>Welcome,</small>
                            <div class="fw-bold" id="userName"></div>
                        </div>
                        <div class="me-3">
                            <span id="userLevel" class="badge bg-light text-dark"></span>
                        </div>
                        <div>
                            <small>RC:</small>
                            <div class="fw-bold" id="userRC"></div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-light d-flex align-items-center" id="logoutBtn">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </button>
            </div>
        </nav>

        <!-- Quick Stats -->
        <div class="container-fluid mt-4 d-none" id="quickStats">
            <div class="row g-3">
                <div class="col-md-2">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 opacity-90">Reserved</h6>
                                    <h3 class="card-title mb-0" id="statReservations">0</h3>
                                    <small>Today</small>
                                </div>
                                <i class="fas fa-calendar-alt stats-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 opacity-90">Check-Ins</h6>
                                    <h3 class="card-title mb-0" id="statCheckins">0</h3>
                                    <small>Today</small>
                                </div>
                                <i class="fas fa-sign-in-alt stats-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 opacity-90">Check-Outs</h6>
                                    <h3 class="card-title mb-0" id="statCheckouts">0</h3>
                                    <small>Today</small>
                                </div>
                                <i class="fas fa-sign-out-alt stats-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 opacity-90">FOC</h6>
                                    <h3 class="card-title mb-0" id="statFOC">0</h3>
                                    <small>Today</small>
                                </div>
                                <i class="fas fa-gift stats-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #718096 0%, #4a5568 100%);">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 opacity-90">No-Show</h6>
                                    <h3 class="card-title mb-0" id="statNoshow">0</h3>
                                    <small>Today</small>
                                </div>
                                <i class="fas fa-times-circle stats-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 opacity-90">Cancelled</h6>
                                    <h3 class="card-title mb-0" id="statCancelled">0</h3>
                                    <small>Today</small>
                                </div>
                                <i class="fas fa-ban stats-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="container-fluid mt-4">
            <ul class="nav nav-tabs" id="mainTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#reservationTab">
                        <i class="fas fa-calendar-plus me-2"></i> New Reservation
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#checkinTab">
                        <i class="fas fa-sign-in-alt me-2"></i> Check-In
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#checkoutTab">
                        <i class="fas fa-sign-out-alt me-2"></i> Check-Out
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#overviewTab">
                        <i class="fas fa-eye me-2"></i> Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#reportTab">
                        <i class="fas fa-file-alt me-2"></i> Reports
                    </a>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content mt-3">
                <!-- Reservation Tab -->
                <div class="tab-pane fade show active" id="reservationTab">
                    <div class="row">
                        <!-- Left Column: Reservation Form and Excel Upload -->
                        <div class="col-lg-12">
                            <div class="card dashboard-card mb-4">
                                <div class="card-header card-header-success">
                                    <h5 class="mb-0"><i class="fas fa-calendar-plus me-2"></i> Single Reservation</h5>
                                </div>
                                <div class="card-body">
                                    <form id="reservationForm" novalidate>
                                        <div class="row">
                                            <div class="col-md-4 mb-3 autocomplete-container">
                                                <label class="form-label fw-bold">Customer</label>
                                                <input type="text" id="customer" class="form-control" required>
                                                <div class="invalid-feedback">Please enter a customer name.</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label fw-bold">Date</label>
                                                <input type="date" id="reservationDate" class="form-control" required>
                                                <div class="invalid-feedback">Please select a date.</div>
                                            </div>
                                            <div class="col-md-4 mb-3 autocomplete-container">
                                                <label class="form-label fw-bold">Flight/Hotel</label>
                                                <input type="text" id="flightHotel" class="form-control" required>
                                                <div class="invalid-feedback">Please enter flight/hotel details.</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label fw-bold">ETA</label>
                                                <input type="time" id="eta" class="form-control" required>
                                                <div class="invalid-feedback">Please select ETA.</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label fw-bold">Direction</label>
                                                <select id="direction" class="form-select" required>
                                                    <option value="">Select Direction</option>
                                                    <option value="Arrival">Arrival</option>
                                                    <option value="Departure">Departure</option>
                                                    <option value="Transit">Transit</option>
                                                    <option value="Local">Local</option>
                                                </select>
                                                <div class="invalid-feedback">Please select a direction.</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label fw-bold">Guest Name</label>
                                                <input type="text" id="guestName" class="form-control" required>
                                                <div class="invalid-feedback">Please enter guest name.</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label fw-bold">Nationality</label>
                                                <input type="text" id="nationality" class="form-control" required>
                                                <div class="invalid-feedback">Please enter nationality.</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label fw-bold">Guest Type</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="isFOC">
                                                    <label class="form-check-label" for="isFOC">
                                                        Free of Charge (FOC)
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label fw-bold">Remarks</label>
                                                <textarea id="remarks" class="form-control" rows="1" placeholder="Any special requirements or notes..."></textarea>
                                            </div>
                                            <div class="col-12 mb-3">
                                                <div class="d-flex gap-2">
                                                    <button type="submit" class="btn btn-success px-4">
                                                        <i class="fas fa-save me-2"></i> Save Reservation
                                                    </button>
                                                    <button type="reset" class="btn btn-outline-secondary">
                                                        <i class="fas fa-times me-2"></i> Clear Form
                                                    </button>
                                                    <button type="button" class="btn btn-foc" onclick="app.saveFOCReservation()">
                                                        <i class="fas fa-gift me-2"></i> Save as FOC
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Excel Upload Section -->
                            <div class="card dashboard-card">
                                <div class="card-header card-header-info">
                                    <h5 class="mb-0"><i class="fas fa-file-excel me-2"></i> Bulk Upload from Excel</h5>
                                </div>
                                <div class="card-body">
                                    <div class="excel-upload-container" id="excelUploadArea">
                                        <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                                        <h5 class="mb-3">Upload Excel File</h5>
                                        <p class="text-muted mb-3">Drag & drop your Excel file here or click to browse</p>
                                        <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" class="d-none">
                                        <button class="btn btn-outline-primary" onclick="document.getElementById('excelFileInput').click()">
                                            <i class="fas fa-folder-open me-2"></i> Browse Files
                                        </button>
                                        <div class="mt-3">
                                            <a href="#" class="template-download" onclick="app.downloadExcelTemplate()">
                                                <i class="fas fa-download me-1"></i> Download Excel Template
                                            </a>
                                        </div>
                                    </div>
                                    <div id="excelPreview" class="d-none mt-4">
                                        <h6 class="mb-3">Preview (<span id="previewCount">0</span> records)</h6>
                                        <div class="excel-preview">
                                            <table class="table table-sm table-bordered">
                                                <thead id="excelPreviewHeader">
                                                    <!-- Headers will be loaded here -->
                                                </thead>
                                                <tbody id="excelPreviewBody">
                                                    <!-- Data will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="d-flex gap-2 mt-3">
                                            <button class="btn btn-success" id="uploadExcelBtn">
                                                <i class="fas fa-upload me-2"></i> Upload to Database
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="app.clearExcelPreview()">
                                                <i class="fas fa-times me-2"></i> Clear Preview
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Check-In Tab -->
                <div class="tab-pane fade" id="checkinTab">
                    <div class="card dashboard-card">
                        <div class="card-header card-header-info">
                            <h5 class="mb-0"><i class="fas fa-sign-in-alt me-2"></i> Check-In Guests</h5>
                        </div>
                        <div class="card-body">
                            <div class="filter-section">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Reservation Date</label>
                                        <input type="date" id="checkinDateFilter" class="form-control">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Flight/Hotel</label>
                                        <select id="checkinFlightFilter" class="form-select">
                                            <option value="">All Flights/Hotels</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Customer</label>
                                        <select id="checkinCustomerFilter" class="form-select">
                                            <option value="">All Customers</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Status</label>
                                        <select id="checkinStatusFilter" class="form-select">
                                            <option value="reserved">Reserved</option>
                                            <option value="checked-in">Checked-In</option>
                                            <option value="foc-reserved">FOC Reserved</option>
                                            <option value="foc-checkedin">FOC Checked-In</option>
                                            <option value="">All</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary" onclick="app.loadCheckinData()">
                                                <i class="fas fa-sync me-2"></i> Refresh
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="app.clearCheckinFilters()">
                                                <i class="fas fa-filter-circle-xmark me-2"></i> Clear Filters
                                            </button>
                                            <button class="btn btn-noshow" onclick="app.bulkMarkNoShow()">
                                                <i class="fas fa-times-circle me-2"></i> Bulk No-Show
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th><input type="checkbox" id="selectAllCheckin" onchange="app.toggleSelectAllCheckin(this)"></th>
                                            <th>Guest Name</th>
                                            <th>Customer</th>
                                            <th>Flight/Hotel</th>
                                            <th>ETA</th>
                                            <th>Direction</th>
                                            <th>Nationality</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="checkinTable">
                                        <tr>
                                            <td colspan="9" class="text-center text-muted py-4">
                                                <div class="spinner"></div>
                                                <p class="mt-2">Loading data...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Check-Out Tab -->
                <div class="tab-pane fade" id="checkoutTab">
                    <div class="card dashboard-card">
                        <div class="card-header card-header-warning">
                            <h5 class="mb-0"><i class="fas fa-sign-out-alt me-2"></i> Check-Out Guests</h5>
                        </div>
                        <div class="card-body">
                            <div class="filter-section">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Check-In Date</label>
                                        <input type="date" id="checkoutDateFilter" class="form-control">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Flight/Hotel</label>
                                        <select id="checkoutFlightFilter" class="form-select">
                                            <option value="">All Flights/Hotels</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Customer</label>
                                        <select id="checkoutCustomerFilter" class="form-select">
                                            <option value="">All Customers</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Status</label>
                                        <select id="checkoutStatusFilter" class="form-select">
                                            <option value="checked-in">Checked-In</option>
                                            <option value="checked-out">Checked-Out</option>
                                            <option value="foc-checkedin">FOC Checked-In</option>
                                            <option value="foc-checkedout">FOC Checked-Out</option>
                                            <option value="">All</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary" onclick="app.loadCheckoutData()">
                                                <i class="fas fa-sync me-2"></i> Refresh
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="app.clearCheckoutFilters()">
                                                <i class="fas fa-filter-circle-xmark me-2"></i> Clear Filters
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Guest Name</th>
                                            <th>Customer</th>
                                            <th>Flight/Hotel</th>
                                            <th>ETA</th>
                                            <th>Direction</th>
                                            <th>Check-In Time</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="checkoutTable">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <div class="spinner"></div>
                                                <p class="mt-2">Loading data...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overview Tab -->
                <!-- Overview Tab -->
                <div class="tab-pane fade" id="overviewTab">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card dashboard-card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Dashboard Overview</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="fas fa-calendar-check fa-2x text-warning"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">Reserved</h6>
                                                    <h3 id="overviewReserved" class="mb-0">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="fas fa-sign-in-alt fa-2x text-success"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">Checked-In</h6>
                                                    <h3 id="overviewCheckedIn" class="mb-0">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="fas fa-sign-out-alt fa-2x text-info"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">Checked-Out</h6>
                                                    <h3 id="overviewCheckedOut" class="mb-0">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="fas fa-gift fa-2x text-foc"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">FOC Guests</h6>
                                                    <h3 id="overviewFOC" class="mb-0">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="fas fa-times-circle fa-2x text-noshow"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">No-Show</h6>
                                                    <h3 id="overviewNoShow" class="mb-0">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="fas fa-ban fa-2x text-danger"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">Cancelled</h6>
                                                    <h3 id="overviewCancelled" class="mb-0">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="fas fa-users fa-2x text-primary"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">Total Today</h6>
                                                    <h3 id="overviewTotalToday" class="mb-0">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="fas fa-user-check fa-2x text-success"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">Active Now</h6>
                                                    <h3 id="overviewActiveNow" class="mb-0">0</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card dashboard-card overview-card passenger-reserved">
                                <div class="card-header" style="background: var(--warning-color);">
                                    <h6 class="mb-0"><i class="fas fa-calendar me-2"></i> Reserved Passengers</h6>
                                    <small class="opacity-75" id="reservedCount">0 guests</small>
                                </div>
                                <div class="card-body p-0">
                                    <div class="recent-reservations-scroll">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Guest</th>
                                                    <th>Flight</th>
                                                    <th>ETA</th>
                                                </tr>
                                            </thead>
                                            <tbody id="overviewReservedList">
                                                <!-- Reserved passengers will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card dashboard-card overview-card passenger-checkedin">
                                <div class="card-header" style="background: var(--success-color);">
                                    <h6 class="mb-0"><i class="fas fa-sign-in-alt me-2"></i> Checked-In Passengers</h6>
                                    <small class="opacity-75" id="checkedinCount">0 guests</small>
                                </div>
                                <div class="card-body p-0">
                                    <div class="recent-reservations-scroll">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Guest</th>
                                                    <th>Flight</th>
                                                    <th>Time</th>
                                                </tr>
                                            </thead>
                                            <tbody id="overviewCheckedInList">
                                                <!-- Checked-in passengers will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card dashboard-card overview-card passenger-foc">
                                <div class="card-header" style="background: var(--foc-color);">
                                    <h6 class="mb-0"><i class="fas fa-gift me-2"></i> FOC Passengers</h6>
                                    <small class="opacity-75" id="focCount">0 guests</small>
                                </div>
                                <div class="card-body p-0">
                                    <div class="recent-reservations-scroll">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Guest</th>
                                                    <th>Flight</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="overviewFOCList">
                                                <!-- FOC passengers will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mt-4">
                            <div class="card dashboard-card overview-card passenger-checkedout">
                                <div class="card-header" style="background: var(--info-color);">
                                    <h6 class="mb-0"><i class="fas fa-sign-out-alt me-2"></i> Checked-Out Passengers</h6>
                                    <small class="opacity-75" id="checkedoutCount">0 guests</small>
                                </div>
                                <div class="card-body p-0">
                                    <div class="recent-reservations-scroll">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Guest</th>
                                                    <th>Flight</th>
                                                    <th>Check-Out</th>
                                                </tr>
                                            </thead>
                                            <tbody id="overviewCheckedOutList">
                                                <!-- Checked-out passengers will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mt-4">
                            <div class="card dashboard-card overview-card passenger-noshow">
                                <div class="card-header" style="background: var(--noshow-color);">
                                    <h6 class="mb-0"><i class="fas fa-times-circle me-2"></i> No-Show Passengers</h6>
                                    <small class="opacity-75" id="noshowCount">0 guests</small>
                                </div>
                                <div class="card-body p-0">
                                    <div class="recent-reservations-scroll">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Guest</th>
                                                    <th>Flight</th>
                                                    <th>ETA</th>
                                                </tr>
                                            </thead>
                                            <tbody id="overviewNoShowList">
                                                <!-- No-Show passengers will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Tab -->
                <div class="tab-pane fade" id="reportTab">
                    <div class="card dashboard-card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i> Generate Report</h5>
                        </div>
                        <div class="card-body">
                            <div class="filter-section">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">From Date</label>
                                        <input type="date" id="reportFromDate" class="form-control">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">To Date</label>
                                        <input type="date" id="reportToDate" class="form-control">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Flight/Hotel</label>
                                        <select id="reportFlightFilter" class="form-select">
                                            <option value="">All Flights/Hotels</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Customer</label>
                                        <select id="reportCustomerFilter" class="form-select">
                                            <option value="">All Customers</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="d-flex gap-2">
                                            <button id="generateReportBtn" class="btn btn-primary">
                                                <i class="fas fa-file-pdf me-2"></i> Generate PDF Report
                                            </button>
                                            <button id="generateExcelBtn" class="btn btn-success">
                                                <i class="fas fa-file-excel me-2"></i> Export to Excel
                                            </button>
                                            <button class="btn btn-foc" onclick="app.generateFOCReport()">
                                                <i class="fas fa-gift me-2"></i> FOC Report
                                            </button>
                                            <button class="btn btn-noshow" onclick="app.generateNoShowReport()">
                                                <i class="fas fa-times-circle me-2"></i> No-Show Report
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="app.clearReportFilters()">
                                                <i class="fas fa-filter-circle-xmark me-2"></i> Clear Filters
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Report Preview -->
                            <div id="reportPreview" class="mt-4 d-none">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-eye me-2"></i> Report Preview</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="reportStats" class="row mb-4"></div>
                                        <div class="table-responsive">
                                            <table class="table table-sm" id="reportPreviewTable">
                                                <!-- Preview data will be loaded here -->
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Reservation Modal -->
    <div class="modal fade" id="editReservationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Reservation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editReservationForm">
                        <input type="hidden" id="editReservationId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Customer</label>
                                <input type="text" id="editCustomer" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Date</label>
                                <input type="date" id="editReservationDate" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Flight/Hotel</label>
                                <input type="text" id="editFlightHotel" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">ETA</label>
                                <input type="time" id="editEta" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Direction</label>
                                <select id="editDirection" class="form-select" required>
                                    <option value="Arrival">Arrival</option>
                                    <option value="Departure">Departure</option>
                                    <option value="Transit">Transit</option>
                                    <option value="Local">Local</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Guest Name</label>
                                <input type="text" id="editGuestName" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Nationality</label>
                                <input type="text" id="editNationality" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Status</label>
                                <select id="editStatus" class="form-select">
                                    <option value="reserved">Reserved</option>
                                    <option value="checked-in">Checked-In</option>
                                    <option value="checked-out">Checked-Out</option>
                                    <option value="foc-reserved">FOC Reserved</option>
                                    <option value="foc-checkedin">FOC Checked-In</option>
                                    <option value="foc-checkedout">FOC Checked-Out</option>
                                    <option value="noshow">No-Show</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Guest Type</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editIsFOC">
                                    <label class="form-check-label" for="editIsFOC">
                                        Free of Charge (FOC)
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">Remarks</label>
                                <textarea id="editRemarks" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="app.updateReservation()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase Config -->
    <script src="resfire.js"></script>
    <!-- User Data -->
    <script src="user1.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Main Application Script -->
    <script>
    
    class ReservationSystem {
        constructor() {
            this.currentUser = null;
            this.db = firebase.firestore();
            this.customers = new Set();
            this.flightHotels = new Set();
            this.excelData = [];
            this.selectedCheckinIds = new Set();
            this.init();
        }

        init() {
            this.setupEventListeners();
            this.checkAuth();
            this.loadAutocompleteData();
        }

        async loadAutocompleteData() {
            try {
                const snapshot = await this.db.collection('reservations').get();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.customer) this.customers.add(data.customer);
                    if (data.flightHotel) this.flightHotels.add(data.flightHotel);
                });
            } catch (error) {
                console.error('Error loading autocomplete data:', error);
            }
        }

        setupEventListeners() {
            // Login
            document.getElementById('loginBtn').addEventListener('click', () => this.login());
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
            
            // Forms
            document.getElementById('reservationForm').addEventListener('submit', (e) => this.saveReservation(e));
            
            // Autocomplete setup
            const customerInput = document.getElementById('customer');
            if (customerInput) {
                customerInput.addEventListener('focus', () => this.showCustomerDropdown());
                customerInput.addEventListener('input', (e) => this.filterCustomerDropdown(e.target.value));
            }
            
            const flightInput = document.getElementById('flightHotel');
            if (flightInput) {
                flightInput.addEventListener('focus', () => this.showFlightDropdown());
                flightInput.addEventListener('input', (e) => this.filterFlightDropdown(e.target.value));
            }
            
            // Click outside to close dropdowns
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-container')) {
                    this.closeAllDropdowns();
                }
            });
            
            // Excel upload
            const excelInput = document.getElementById('excelFileInput');
            if (excelInput) {
                excelInput.addEventListener('change', (e) => this.handleExcelUpload(e));
            }
            
            const uploadBtn = document.getElementById('uploadExcelBtn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', () => this.uploadExcelData());
            }
            
            // Excel drag and drop
            const excelUploadArea = document.getElementById('excelUploadArea');
            if (excelUploadArea) {
                excelUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    excelUploadArea.classList.add('dragover');
                });
                
                excelUploadArea.addEventListener('dragleave', () => {
                    excelUploadArea.classList.remove('dragover');
                });
                
                excelUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    excelUploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].name.match(/\.(xlsx|xls|csv)$/)) {
                        this.readExcelFile(files[0]);
                    }
                });
            }
            
            // Filters
            const checkinDateFilter = document.getElementById('checkinDateFilter');
            if (checkinDateFilter) {
                checkinDateFilter.addEventListener('change', () => this.loadCheckinData());
            }
            
            const checkinFlightFilter = document.getElementById('checkinFlightFilter');
            if (checkinFlightFilter) {
                checkinFlightFilter.addEventListener('change', () => this.loadCheckinData());
            }
            
            const checkinCustomerFilter = document.getElementById('checkinCustomerFilter');
            if (checkinCustomerFilter) {
                checkinCustomerFilter.addEventListener('change', () => this.loadCheckinData());
            }
            
            const checkinStatusFilter = document.getElementById('checkinStatusFilter');
            if (checkinStatusFilter) {
                checkinStatusFilter.addEventListener('change', () => this.loadCheckinData());
            }
            
            const checkoutDateFilter = document.getElementById('checkoutDateFilter');
            if (checkoutDateFilter) {
                checkoutDateFilter.addEventListener('change', () => this.loadCheckoutData());
            }
            
            const checkoutFlightFilter = document.getElementById('checkoutFlightFilter');
            if (checkoutFlightFilter) {
                checkoutFlightFilter.addEventListener('change', () => this.loadCheckoutData());
            }
            
            const checkoutCustomerFilter = document.getElementById('checkoutCustomerFilter');
            if (checkoutCustomerFilter) {
                checkoutCustomerFilter.addEventListener('change', () => this.loadCheckoutData());
            }
            
            const checkoutStatusFilter = document.getElementById('checkoutStatusFilter');
            if (checkoutStatusFilter) {
                checkoutStatusFilter.addEventListener('change', () => this.loadCheckoutData());
            }
            
            const generateReportBtn = document.getElementById('generateReportBtn');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', () => this.generateReport());
            }
            
            const generateExcelBtn = document.getElementById('generateExcelBtn');
            if (generateExcelBtn) {
                generateExcelBtn.addEventListener('click', () => this.exportToExcel());
            }
            
            // Tab change events
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', (e) => {
                    const target = e.target.getAttribute('href');
                    if (target === '#checkinTab') {
                        this.loadCheckinData();
                        this.loadFlightOptionsForCheckin();
                        this.loadCustomerOptionsForCheckin();
                    } else if (target === '#checkoutTab') {
                        this.loadCheckoutData();
                        this.loadFlightOptionsForCheckout();
                        this.loadCustomerOptionsForCheckout();
                    } else if (target === '#reportTab') {
                        this.loadReportOptions();
                    } else if (target === '#overviewTab') {
                        this.loadOverviewData();
                    }
                });
            });
        }

        checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                this.currentUser = JSON.parse(savedUser);
                this.showDashboard();
            }
        }

        login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Hash the password using SHA-256
            this.hashPasswordSHA256(password).then(hashedPassword => {
                const user = users.find(u => u.username === username && u.passwordHash === hashedPassword);
                
                if (user) {
                    this.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    this.showDashboard();
                    this.hideError();
                } else {
                    this.showError('Invalid username or password');
                }
            }).catch(error => {
                console.error('Error hashing password:', error);
                this.showError('Login error. Please try again.');
            });
        }

        async hashPasswordSHA256(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        showError(message) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('d-none');
            }
        }

        hideError() {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.classList.add('d-none');
            }
        }

        showDashboard() {
            const loginScreen = document.getElementById('loginScreen');
            const dashboard = document.getElementById('dashboard');
            
            if (loginScreen) loginScreen.classList.add('d-none');
            if (dashboard) dashboard.classList.remove('d-none');
            
            // Display user info
            const userName = document.getElementById('userName');
            const userLevel = document.getElementById('userLevel');
            const userRC = document.getElementById('userRC');
            
            if (userName) userName.textContent = this.currentUser.name;
            if (userLevel) userLevel.textContent = this.currentUser.Level;
            if (userRC) userRC.textContent = this.currentUser.RCNo;
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const dateFields = [
                'reservationDate',
                'checkinDateFilter',
                'checkoutDateFilter',
                'reportFromDate',
                'reportToDate'
            ];
            
            dateFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = today;
            });
            
            // Load initial data
            this.loadCheckinData();
            this.loadCheckoutData();
            this.loadFlightOptionsForCheckin();
            this.loadFlightOptionsForCheckout();
            this.loadCustomerOptionsForCheckin();
            this.loadCustomerOptionsForCheckout();
            this.loadReportOptions();
            this.loadOverviewData();
            this.updateStats();
        }

        logout() {
            this.currentUser = null;
            localStorage.removeItem('currentUser');
            
            const dashboard = document.getElementById('dashboard');
            const loginScreen = document.getElementById('loginScreen');
            
            if (dashboard) dashboard.classList.add('d-none');
            if (loginScreen) loginScreen.classList.remove('d-none');
            
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            if (usernameInput) usernameInput.value = '';
            if (passwordInput) passwordInput.value = '';
        }

        showCustomerDropdown() {
            this.closeAllDropdowns();
            const input = document.getElementById('customer');
            if (!input) return;
            
            const container = input.parentElement;
            const dropdown = document.createElement('div');
            dropdown.className = 'autocomplete-dropdown';
            
            // Add "Add new" option
            const addNewOption = document.createElement('div');
            addNewOption.className = 'dropdown-item';
            addNewOption.innerHTML = '<i class="fas fa-plus me-2"></i> Add new customer';
            addNewOption.onclick = () => {
                this.closeAllDropdowns();
                input.focus();
            };
            dropdown.appendChild(addNewOption);
            
            // Add existing customers
            Array.from(this.customers).sort().forEach(customer => {
                const option = document.createElement('div');
                option.className = 'dropdown-item';
                option.textContent = customer;
                option.onclick = () => {
                    input.value = customer;
                    this.closeAllDropdowns();
                };
                dropdown.appendChild(option);
            });
            
            container.style.position = 'relative';
            container.appendChild(dropdown);
        }

        showFlightDropdown() {
            this.closeAllDropdowns();
            const input = document.getElementById('flightHotel');
            if (!input) return;
            
            const container = input.parentElement;
            const dropdown = document.createElement('div');
            dropdown.className = 'autocomplete-dropdown';
            
            // Add "Add new" option
            const addNewOption = document.createElement('div');
            addNewOption.className = 'dropdown-item';
            addNewOption.innerHTML = '<i class="fas fa-plus me-2"></i> Add new flight/hotel';
            addNewOption.onclick = () => {
                this.closeAllDropdowns();
                input.focus();
            };
            dropdown.appendChild(addNewOption);
            
            // Add existing flights/hotels
            Array.from(this.flightHotels).sort().forEach(flightHotel => {
                const option = document.createElement('div');
                option.className = 'dropdown-item';
                option.textContent = flightHotel;
                option.onclick = () => {
                    input.value = flightHotel;
                    this.closeAllDropdowns();
                };
                dropdown.appendChild(option);
            });
            
            container.style.position = 'relative';
            container.appendChild(dropdown);
        }

        filterCustomerDropdown(searchTerm) {
            // Implement filtering if needed
        }

        filterFlightDropdown(searchTerm) {
            // Implement filtering if needed
        }

        closeAllDropdowns() {
            document.querySelectorAll('.autocomplete-dropdown').forEach(dropdown => {
                dropdown.remove();
            });
        }

        async saveReservation(e) {
            e.preventDefault();
            
            const isFOC = document.getElementById('isFOC').checked;
            const status = isFOC ? 'foc-reserved' : 'reserved';
            
            const customer = document.getElementById('customer').value;
            const flightHotel = document.getElementById('flightHotel').value;
            const reservationDate = document.getElementById('reservationDate').value;
            
            const reservation = {
                customer: customer,
                date: reservationDate,
                flightHotel: flightHotel,
                eta: document.getElementById('eta').value,
                direction: document.getElementById('direction').value,
                guestName: document.getElementById('guestName').value,
                nationality: document.getElementById('nationality').value,
                remarks: document.getElementById('remarks').value,
                status: status,
                isFOC: isFOC,
                createdAt: new Date().toISOString(),
                createdBy: this.currentUser.username,
                checkinDate: null,
                checkoutDate: null,
                reservationDate: reservationDate
            };
            
            try {
                const docRef = await this.db.collection('reservations').add(reservation);
                
                // Add to autocomplete sets
                if (customer) this.customers.add(customer);
                if (flightHotel) this.flightHotels.add(flightHotel);
                
                alert('Reservation saved successfully!');
                
                this.updateStats();
                
                document.getElementById('reservationForm').reset();
                document.getElementById('isFOC').checked = false;
                document.getElementById('reservationDate').value = new Date().toISOString().split('T')[0];
                
                // Refresh all data
                this.loadCheckinData();
                this.loadCheckoutData();
                this.loadFlightOptionsForCheckin();
                this.loadFlightOptionsForCheckout();
                this.loadCustomerOptionsForCheckin();
                this.loadCustomerOptionsForCheckout();
                this.loadReportOptions();
                this.loadOverviewData();
                
            } catch (error) {
                console.error('Error saving reservation:', error);
                alert('Error saving reservation. Please try again.');
            }
        }

        async saveFOCReservation() {
            const isFOC = true;
            const status = 'foc-reserved';
            
            const customer = document.getElementById('customer').value;
            const flightHotel = document.getElementById('flightHotel').value;
            const reservationDate = document.getElementById('reservationDate').value;
            
            if (!customer || !flightHotel || !reservationDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            const reservation = {
                customer: customer,
                date: reservationDate,
                flightHotel: flightHotel,
                eta: document.getElementById('eta').value,
                direction: document.getElementById('direction').value,
                guestName: document.getElementById('guestName').value,
                nationality: document.getElementById('nationality').value,
                remarks: document.getElementById('remarks').value,
                status: status,
                isFOC: isFOC,
                createdAt: new Date().toISOString(),
                createdBy: this.currentUser.username,
                checkinDate: null,
                checkoutDate: null,
                reservationDate: reservationDate,
                focReason: 'Free of Charge Guest'
            };
            
            try {
                const docRef = await this.db.collection('reservations').add(reservation);
                
                // Add to autocomplete sets
                if (customer) this.customers.add(customer);
                if (flightHotel) this.flightHotels.add(flightHotel);
                
                alert('FOC Reservation saved successfully!');
                
                this.updateStats();
                
                document.getElementById('reservationForm').reset();
                document.getElementById('isFOC').checked = false;
                document.getElementById('reservationDate').value = new Date().toISOString().split('T')[0];
                
                // Refresh all data
                this.loadCheckinData();
                this.loadCheckoutData();
                this.loadFlightOptionsForCheckin();
                this.loadFlightOptionsForCheckout();
                this.loadCustomerOptionsForCheckin();
                this.loadCustomerOptionsForCheckout();
                this.loadReportOptions();
                this.loadOverviewData();
                
            } catch (error) {
                console.error('Error saving FOC reservation:', error);
                alert('Error saving FOC reservation. Please try again.');
            }
        }

        // Edit Reservation Functions
        async openEditModal(reservationId) {
            try {
                const doc = await this.db.collection('reservations').doc(reservationId).get();
                if (!doc.exists) {
                    alert('Reservation not found!');
                    return;
                }
                
                const reservation = doc.data();
                
                // Populate form
                document.getElementById('editReservationId').value = reservationId;
                document.getElementById('editCustomer').value = reservation.customer || '';
                document.getElementById('editReservationDate').value = reservation.reservationDate || '';
                document.getElementById('editFlightHotel').value = reservation.flightHotel || '';
                document.getElementById('editEta').value = reservation.eta || '';
                document.getElementById('editDirection').value = reservation.direction || 'Arrival';
                document.getElementById('editGuestName').value = reservation.guestName || '';
                document.getElementById('editNationality').value = reservation.nationality || '';
                document.getElementById('editStatus').value = reservation.status || 'reserved';
                document.getElementById('editIsFOC').checked = reservation.isFOC || false;
                document.getElementById('editRemarks').value = reservation.remarks || '';
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading reservation for edit:', error);
                alert('Error loading reservation details.');
            }
        }

        async updateReservation() {
            const reservationId = document.getElementById('editReservationId').value;
            const isFOC = document.getElementById('editIsFOC').checked;
            
            const updatedData = {
                customer: document.getElementById('editCustomer').value,
                reservationDate: document.getElementById('editReservationDate').value,
                flightHotel: document.getElementById('editFlightHotel').value,
                eta: document.getElementById('editEta').value,
                direction: document.getElementById('editDirection').value,
                guestName: document.getElementById('editGuestName').value,
                nationality: document.getElementById('editNationality').value,
                status: document.getElementById('editStatus').value,
                isFOC: isFOC,
                remarks: document.getElementById('editRemarks').value,
                updatedAt: new Date().toISOString(),
                updatedBy: this.currentUser.username
            };
            
            try {
                await this.db.collection('reservations').doc(reservationId).update(updatedData);
                
                // Add to autocomplete sets
                if (updatedData.customer) this.customers.add(updatedData.customer);
                if (updatedData.flightHotel) this.flightHotels.add(updatedData.flightHotel);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editReservationModal'));
                if (modal) {
                    modal.hide();
                }
                
                alert('Reservation updated successfully!');
                
                // Refresh all data
                this.loadCheckinData();
                this.loadCheckoutData();
                this.loadFlightOptionsForCheckin();
                this.loadFlightOptionsForCheckout();
                this.loadCustomerOptionsForCheckin();
                this.loadCustomerOptionsForCheckout();
                this.loadReportOptions();
                this.loadOverviewData();
                this.updateStats();
                
            } catch (error) {
                console.error('Error updating reservation:', error);
                alert('Error updating reservation. Please try again.');
            }
        }

        async loadFlightOptionsForCheckin() {
            try {
                const snapshot = await this.db.collection('reservations')
                    .where('status', 'in', ['reserved', 'checked-in', 'foc-reserved', 'foc-checkedin'])
                    .get();
                
                const flights = [...new Set(snapshot.docs.map(doc => doc.data().flightHotel))];
                const select = document.getElementById('checkinFlightFilter');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">All Flights/Hotels</option>';
                flights.forEach(flight => {
                    if (flight) {
                        const option = document.createElement('option');
                        option.value = flight;
                        option.textContent = flight;
                        select.appendChild(option);
                    }
                });
                
                if (flights.includes(currentValue)) {
                    select.value = currentValue;
                }
            } catch (error) {
                console.error('Error loading flight options for check-in:', error);
            }
        }

        async loadCustomerOptionsForCheckin() {
            try {
                const snapshot = await this.db.collection('reservations')
                    .where('status', 'in', ['reserved', 'checked-in', 'foc-reserved', 'foc-checkedin'])
                    .get();
                
                const customers = [...new Set(snapshot.docs.map(doc => doc.data().customer))];
                const select = document.getElementById('checkinCustomerFilter');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">All Customers</option>';
                customers.forEach(customer => {
                    if (customer) {
                        const option = document.createElement('option');
                        option.value = customer;
                        option.textContent = customer;
                        select.appendChild(option);
                    }
                });
                
                if (customers.includes(currentValue)) {
                    select.value = currentValue;
                }
            } catch (error) {
                console.error('Error loading customer options for check-in:', error);
            }
        }

        async loadFlightOptionsForCheckout() {
            try {
                const snapshot = await this.db.collection('reservations')
                    .where('status', 'in', ['checked-in', 'checked-out', 'foc-checkedin', 'foc-checkedout'])
                    .get();
                
                const flights = [...new Set(snapshot.docs.map(doc => doc.data().flightHotel))];
                const select = document.getElementById('checkoutFlightFilter');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">All Flights/Hotels</option>';
                flights.forEach(flight => {
                    if (flight) {
                        const option = document.createElement('option');
                            option.value = flight;
                            option.textContent = flight;
                            select.appendChild(option);
                        }
                    });
                    
                    if (flights.includes(currentValue)) {
                        select.value = currentValue;
                    }
                } catch (error) {
                    console.error('Error loading flight options for check-out:', error);
                }
            }

            async loadCustomerOptionsForCheckout() {
                try {
                    const snapshot = await this.db.collection('reservations')
                        .where('status', 'in', ['checked-in', 'checked-out', 'foc-checkedin', 'foc-checkedout'])
                        .get();
                    
                    const customers = [...new Set(snapshot.docs.map(doc => doc.data().customer))];
                    const select = document.getElementById('checkoutCustomerFilter');
                    if (!select) return;
                    
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">All Customers</option>';
                    customers.forEach(customer => {
                        if (customer) {
                            const option = document.createElement('option');
                            option.value = customer;
                            option.textContent = customer;
                            select.appendChild(option);
                        }
                    });
                    
                    if (customers.includes(currentValue)) {
                        select.value = currentValue;
                    }
                } catch (error) {
                    console.error('Error loading customer options for check-out:', error);
                }
            }

            async loadCheckinData() {
                const dateInput = document.getElementById('checkinDateFilter');
                const flightSelect = document.getElementById('checkinFlightFilter');
                const customerSelect = document.getElementById('checkinCustomerFilter');
                const statusSelect = document.getElementById('checkinStatusFilter');
                const tableBody = document.getElementById('checkinTable');
                
                if (!tableBody) return;
                
                const date = dateInput ? dateInput.value : '';
                const flightFilter = flightSelect ? flightSelect.value : '';
                const customerFilter = customerSelect ? customerSelect.value : '';
                const statusFilter = statusSelect ? statusSelect.value : '';
                
                try {
                    let query = this.db.collection('reservations');
                    
                    // Apply filters
                    if (date) {
                        query = query.where('reservationDate', '==', date);
                    }
                    
                    if (statusFilter) {
                        query = query.where('status', '==', statusFilter);
                    } else {
                        query = query.where('status', 'in', ['reserved', 'checked-in', 'foc-reserved', 'foc-checkedin']);
                    }
                    
                    const snapshot = await query.get();
                    tableBody.innerHTML = '';
                    
                    if (snapshot.empty) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="9" class="text-center text-muted">
                                    No reservations found
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    let hasData = false;
                    this.selectedCheckinIds.clear();
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // Apply additional filters
                        if (flightFilter && data.flightHotel !== flightFilter) return;
                        if (customerFilter && data.customer !== customerFilter) return;
                        
                        hasData = true;
                        
                        let statusBadge;
                        if (data.status === 'checked-in') {
                            statusBadge = '<span class="status-badge status-checkedin">Checked-In</span>';
                        } else if (data.status === 'foc-checkedin') {
                            statusBadge = '<span class="status-badge status-foc">FOC Checked-In</span>';
                        } else if (data.status === 'foc-reserved') {
                            statusBadge = '<span class="status-badge status-foc">FOC Reserved</span>';
                        } else {
                            statusBadge = '<span class="status-badge status-reserved">Reserved</span>';
                        }
                        
                        const checkinTime = data.checkinTime ? `<br><small>${data.checkinTime}</small>` : '';
                        
                        const isFoc = data.status.includes('foc');
                        const isCheckinEnabled = data.status === 'reserved' || data.status === 'foc-reserved';
                        
                        const row = `
                            <tr>
                                <td>
                                    ${isCheckinEnabled ? `
                                    <input type="checkbox" class="checkin-checkbox" value="${doc.id}" 
                                           onchange="app.toggleCheckinSelection('${doc.id}', this.checked)">
                                    ` : ''}
                                </td>
                                <td>${data.guestName}</td>
                                <td>${data.customer}</td>
                                <td>${data.flightHotel}</td>
                                <td>${data.eta}${checkinTime}</td>
                                <td>${data.direction}</td>
                                <td>${data.nationality}</td>
                                <td>${statusBadge} ${isFoc ? '<i class="fas fa-gift text-foc ms-1" title="FOC"></i>' : ''}</td>
                                <td>
                                    <div class="action-buttons">
                                        ${isCheckinEnabled ? `
                                        <button class="btn btn-sm btn-success" onclick="app.checkinGuest('${doc.id}')">
                                            <i class="fas fa-sign-in-alt"></i>
                                        </button>
                                        ` : ''}
                                        <button class="btn btn-sm btn-info" onclick="app.openEditModal('${doc.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-noshow" onclick="app.markNoShow('${doc.id}')">
                                            <i class="fas fa-times-circle"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="app.deleteReservation('${doc.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                    
                    if (!hasData) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="9" class="text-center text-muted">
                                    No guests match the selected filters
                                </td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading check-in data:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-danger">
                                Error loading data. Please try again.
                            </td>
                        </tr>
                    `;
                }
            }

            toggleSelectAllCheckin(checkbox) {
                const checkboxes = document.querySelectorAll('.checkin-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = checkbox.checked;
                    this.toggleCheckinSelection(cb.value, cb.checked);
                });
            }

            toggleCheckinSelection(id, isChecked) {
                if (isChecked) {
                    this.selectedCheckinIds.add(id);
                } else {
                    this.selectedCheckinIds.delete(id);
                }
            }

            async bulkMarkNoShow() {
                if (this.selectedCheckinIds.size === 0) {
                    alert('Please select at least one reservation to mark as No-Show');
                    return;
                }

                if (!confirm(`Are you sure you want to mark ${this.selectedCheckinIds.size} reservation(s) as No-Show?`)) {
                    return;
                }

                let successCount = 0;
                let errorCount = 0;

                for (const id of this.selectedCheckinIds) {
                    try {
                        const doc = await this.db.collection('reservations').doc(id).get();
                        if (doc.exists) {
                            const data = doc.data();
                            const newStatus = data.isFOC ? 'foc-noshow' : 'noshow';
                            
                            await this.db.collection('reservations').doc(id).update({
                                status: newStatus,
                                noshowTime: new Date().toLocaleTimeString('en-US', { 
                                    hour12: true, 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                }),
                                noshowDate: new Date().toISOString().split('T')[0],
                                noshowBy: this.currentUser.username
                            });
                            successCount++;
                        }
                    } catch (error) {
                        console.error(`Error marking reservation ${id} as No-Show:`, error);
                        errorCount++;
                    }
                }

                alert(`No-Show marked for ${successCount} reservation(s). ${errorCount > 0 ? `${errorCount} failed.` : ''}`);
                
                // Refresh data
                this.loadCheckinData();
                this.updateStats();
                this.loadOverviewData();
            }

            async markNoShow(reservationId) {
                if (!confirm('Are you sure you want to mark this reservation as No-Show?')) {
                    return;
                }
                
                try {
                    const doc = await this.db.collection('reservations').doc(reservationId).get();
                    if (doc.exists) {
                        const data = doc.data();
                        const newStatus = data.isFOC ? 'foc-noshow' : 'noshow';
                        
                        await this.db.collection('reservations').doc(reservationId).update({
                            status: newStatus,
                            noshowTime: new Date().toLocaleTimeString('en-US', { 
                                hour12: true, 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            }),
                            noshowDate: new Date().toISOString().split('T')[0],
                            noshowBy: this.currentUser.username
                        });
                        
                        alert('Reservation marked as No-Show');
                        
                        // Refresh data
                        this.loadCheckinData();
                        this.updateStats();
                        this.loadOverviewData();
                    }
                } catch (error) {
                    console.error('Error marking as No-Show:', error);
                    alert('Error marking as No-Show. Please try again.');
                }
            }

            async checkinGuest(reservationId) {
                if (!confirm('Are you sure you want to check in this guest?')) {
                    return;
                }
                
                const now = new Date();
                const checkinTime = now.toLocaleTimeString('en-US', { 
                    hour12: true, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                try {
                    const doc = await this.db.collection('reservations').doc(reservationId).get();
                    if (doc.exists) {
                        const data = doc.data();
                        const newStatus = data.isFOC ? 'foc-checkedin' : 'checked-in';
                        
                        await this.db.collection('reservations').doc(reservationId).update({
                            status: newStatus,
                            checkinTime: checkinTime,
                            checkinDateTime: now.toISOString(),
                            checkinBy: this.currentUser.username,
                            checkinDate: new Date().toISOString().split('T')[0]
                        });
                        
                        alert('Guest checked in successfully!');
                        
                        // Refresh all data
                        this.loadCheckinData();
                        this.loadCheckoutData();
                        this.loadFlightOptionsForCheckin();
                        this.loadFlightOptionsForCheckout();
                        this.loadCustomerOptionsForCheckin();
                        this.loadCustomerOptionsForCheckout();
                        this.updateStats();
                        this.loadOverviewData();
                    }
                } catch (error) {
                    console.error('Error checking in guest:', error);
                    alert('Error checking in guest. Please try again.');
                }
            }

            async loadCheckoutData() {
                const dateInput = document.getElementById('checkoutDateFilter');
                const flightSelect = document.getElementById('checkoutFlightFilter');
                const customerSelect = document.getElementById('checkoutCustomerFilter');
                const statusSelect = document.getElementById('checkoutStatusFilter');
                const tableBody = document.getElementById('checkoutTable');
                
                if (!tableBody) return;
                
                const date = dateInput ? dateInput.value : '';
                const flightFilter = flightSelect ? flightSelect.value : '';
                const customerFilter = customerSelect ? customerSelect.value : '';
                const statusFilter = statusSelect ? statusSelect.value : '';
                
                try {
                    let query = this.db.collection('reservations');
                    
                    // Apply status filter
                    if (statusFilter) {
                        query = query.where('status', '==', statusFilter);
                    } else {
                        query = query.where('status', 'in', ['checked-in', 'checked-out', 'foc-checkedin', 'foc-checkedout']);
                    }
                    
                    const snapshot = await query.get();
                    tableBody.innerHTML = '';
                    
                    if (snapshot.empty) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    No checked-in/out guests available
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    let hasData = false;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // Apply additional filters
                        if (date && data.checkinDate !== date) return;
                        if (flightFilter && data.flightHotel !== flightFilter) return;
                        if (customerFilter && data.customer !== customerFilter) return;
                        
                        hasData = true;
                        
                        let statusBadge;
                        if (data.status === 'checked-out') {
                            statusBadge = '<span class="status-badge status-checkedout">Checked-Out</span>';
                        } else if (data.status === 'foc-checkedout') {
                            statusBadge = '<span class="status-badge status-foc">FOC Checked-Out</span>';
                        } else if (data.status === 'foc-checkedin') {
                            statusBadge = '<span class="status-badge status-foc">FOC Checked-In</span>';
                        } else {
                            statusBadge = '<span class="status-badge status-checkedin">Checked-In</span>';
                        }
                        
                        const checkoutTime = data.checkoutTime ? `<br><small>${data.checkoutTime}</small>` : '';
                        
                        const isFoc = data.status.includes('foc');
                        const isCheckoutEnabled = data.status === 'checked-in' || data.status === 'foc-checkedin';
                        
                        const row = `
                            <tr>
                                <td>${data.guestName}</td>
                                <td>${data.customer}</td>
                                <td>${data.flightHotel}</td>
                                <td>${data.eta}${checkoutTime}</td>
                                <td>${data.direction}</td>
                                <td>${data.checkinTime || 'N/A'}</td>
                                <td>${statusBadge} ${isFoc ? '<i class="fas fa-gift text-foc ms-1" title="FOC"></i>' : ''}</td>
                                <td>
                                    <div class="action-buttons">
                                        ${isCheckoutEnabled ? `
                                        <button class="btn btn-sm btn-warning" onclick="app.checkoutGuest('${doc.id}')">
                                            <i class="fas fa-sign-out-alt"></i>
                                        </button>
                                        ` : ''}
                                        <button class="btn btn-sm btn-info" onclick="app.openEditModal('${doc.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="app.deleteReservation('${doc.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                    
                    if (!hasData) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    No guests match the selected filters
                                </td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading check-out data:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-danger">
                                Error loading data. Please try again.
                            </td>
                        </tr>
                    `;
                }
            }

            async checkoutGuest(reservationId) {
                if (!confirm('Are you sure you want to check out this guest?')) {
                    return;
                }
                
                const now = new Date();
                const checkoutTime = now.toLocaleTimeString('en-US', { 
                    hour12: true, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                try {
                    const doc = await this.db.collection('reservations').doc(reservationId).get();
                    if (doc.exists) {
                        const data = doc.data();
                        const newStatus = data.isFOC ? 'foc-checkedout' : 'checked-out';
                        
                        await this.db.collection('reservations').doc(reservationId).update({
                            status: newStatus,
                            checkoutTime: checkoutTime,
                            checkoutDateTime: now.toISOString(),
                            checkoutBy: this.currentUser.username,
                            checkoutDate: new Date().toISOString().split('T')[0]
                        });
                        
                        alert('Guest checked out successfully!');
                        
                        // Refresh all data
                        this.loadCheckoutData();
                        this.loadReportOptions();
                        this.loadFlightOptionsForCheckout();
                        this.loadCustomerOptionsForCheckout();
                        this.updateStats();
                        this.loadOverviewData();
                    }
                } catch (error) {
                    console.error('Error checking out guest:', error);
                    alert('Error checking out guest. Please try again.');
                }
            }

            async loadReportOptions() {
                try {
                    const snapshot = await this.db.collection('reservations').get();
                    
                    const flights = [...new Set(snapshot.docs.map(doc => doc.data().flightHotel))];
                    const customers = [...new Set(snapshot.docs.map(doc => doc.data().customer))];
                    
                    // Flight filter
                    const flightSelect = document.getElementById('reportFlightFilter');
                    if (flightSelect) {
                        const currentValue = flightSelect.value;
                        flightSelect.innerHTML = '<option value="">All Flights/Hotels</option>';
                        flights.forEach(flight => {
                            if (flight) {
                                const option = document.createElement('option');
                                option.value = flight;
                                option.textContent = flight;
                                flightSelect.appendChild(option);
                            }
                        });
                        if (flights.includes(currentValue)) {
                            flightSelect.value = currentValue;
                        }
                    }
                    
                    // Customer filter
                    const customerSelect = document.getElementById('reportCustomerFilter');
                    if (customerSelect) {
                        const currentValue = customerSelect.value;
                        customerSelect.innerHTML = '<option value="">All Customers</option>';
                        customers.forEach(customer => {
                            if (customer) {
                                const option = document.createElement('option');
                                option.value = customer;
                                option.textContent = customer;
                                customerSelect.appendChild(option);
                            }
                        });
                        if (customers.includes(currentValue)) {
                            customerSelect.value = currentValue;
                        }
                    }
                } catch (error) {
                    console.error('Error loading report options:', error);
                }
            }

            clearCheckinFilters() {
                document.getElementById('checkinDateFilter').value = '';
                document.getElementById('checkinFlightFilter').value = '';
                document.getElementById('checkinCustomerFilter').value = '';
                document.getElementById('checkinStatusFilter').value = 'reserved';
                this.loadCheckinData();
            }

            clearCheckoutFilters() {
                document.getElementById('checkoutDateFilter').value = '';
                document.getElementById('checkoutFlightFilter').value = '';
                document.getElementById('checkoutCustomerFilter').value = '';
                document.getElementById('checkoutStatusFilter').value = 'checked-in';
                this.loadCheckoutData();
            }

            clearReportFilters() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reportFromDate').value = today;
                document.getElementById('reportToDate').value = today;
                document.getElementById('reportFlightFilter').value = '';
                document.getElementById('reportCustomerFilter').value = '';
            }

            

            async generateFOCReport() {
                const fromDateInput = document.getElementById('reportFromDate');
                const toDateInput = document.getElementById('reportToDate');
                const flightSelect = document.getElementById('reportFlightFilter');
                const customerSelect = document.getElementById('reportCustomerFilter');
                
                if (!fromDateInput || !toDateInput) return;
                
                const fromDate = fromDateInput.value;
                const toDate = toDateInput.value;
                const flightFilter = flightSelect ? flightSelect.value : '';
                const customerFilter = customerSelect ? customerSelect.value : '';
                
                if (fromDate && toDate && fromDate > toDate) {
                    alert('From date cannot be after To date');
                    return;
                }
                
                try {
                    const snapshot = await this.db.collection('reservations').get();
                    const reservations = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const id = doc.id;
                        
                        // Only FOC guests
                        if (!data.isFOC) return;
                        
                        // Apply date filter
                        if (fromDate && toDate) {
                            const checkDate = data.checkoutDate || data.checkinDate || data.reservationDate;
                            if (!checkDate) return;
                            
                            if (checkDate < fromDate || checkDate > toDate) {
                                return;
                            }
                        }
                        
                        // Apply flight filter
                        if (flightFilter && data.flightHotel !== flightFilter) return;
                        
                        // Apply customer filter
                        if (customerFilter && data.customer !== customerFilter) return;
                        
                        reservations.push({ id, ...data });
                    });
                    
                    if (reservations.length === 0) {
                        alert('No FOC reservations found for the selected criteria.');
                        return;
                    }
                    
                    this.displayReport(reservations, fromDate, toDate, true);
                } catch (error) {
                    console.error('Error generating FOC report:', error);
                    alert('Error generating FOC report. Please try again.');
                }
            }

            async generateNoShowReport() {
                const fromDateInput = document.getElementById('reportFromDate');
                const toDateInput = document.getElementById('reportToDate');
                const flightSelect = document.getElementById('reportFlightFilter');
                const customerSelect = document.getElementById('reportCustomerFilter');
                
                if (!fromDateInput || !toDateInput) return;
                
                const fromDate = fromDateInput.value;
                const toDate = toDateInput.value;
                const flightFilter = flightSelect ? flightSelect.value : '';
                const customerFilter = customerSelect ? customerSelect.value : '';
                
                if (fromDate && toDate && fromDate > toDate) {
                    alert('From date cannot be after To date');
                    return;
                }
                
                try {
                    const snapshot = await this.db.collection('reservations').get();
                    const reservations = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const id = doc.id;
                        
                        // Only No-Show guests
                        if (!['noshow', 'foc-noshow'].includes(data.status)) return;
                        
                        // Apply date filter
                        if (fromDate && toDate) {
                            const checkDate = data.noshowDate || data.reservationDate;
                            if (!checkDate) return;
                            
                            if (checkDate < fromDate || checkDate > toDate) {
                                return;
                            }
                        }
                        
                        // Apply flight filter
                        if (flightFilter && data.flightHotel !== flightFilter) return;
                        
                        // Apply customer filter
                        if (customerFilter && data.customer !== customerFilter) return;
                        
                        reservations.push({ id, ...data });
                    });
                    
                    if (reservations.length === 0) {
                        alert('No No-Show reservations found for the selected criteria.');
                        return;
                    }
                    
                    this.displayReport(reservations, fromDate, toDate, false, true);
                } catch (error) {
                    console.error('Error generating No-Show report:', error);
                    alert('Error generating No-Show report. Please try again.');
                }
            }

            displayReport(reservations, fromDate, toDate, isFOCReport = false, isNoShowReport = false) {
                const printWindow = window.open('', '_blank');
                
                const currentDate = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Group by customer
                const reservationsByCustomer = {};
                reservations.forEach(res => {
                    if (!reservationsByCustomer[res.customer]) {
                        reservationsByCustomer[res.customer] = [];
                    }
                    reservationsByCustomer[res.customer].push(res);
                });
                
                // Calculate statistics
                let totalFOC = 0;
                let totalRegular = 0;
                let totalCheckedIn = 0;
                let totalCheckedOut = 0;
                let totalNoShow = 0;
                let totalReserved = 0;
                
                reservations.forEach(res => {
                    if (res.isFOC) totalFOC++;
                    else totalRegular++;
                    
                    if (res.status.includes('checked-in')) totalCheckedIn++;
                    if (res.status.includes('checked-out')) totalCheckedOut++;
                    if (res.status.includes('noshow')) totalNoShow++;
                    if (res.status.includes('reserved')) totalReserved++;
                });
                
                let reportHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Guest Report - Vilu Lounge</title>
                        <style>
                            @media print {
                                @page {
                                    size: A4;
                                    margin: 15mm;
                                }
                                body {
                                    font-family: Arial, sans-serif;
                                    font-size: 11px;
                                    color: #000;
                                    margin: 0;
                                    padding: 0;
                                }
                                .report-container {
                                    width: 100%;
                                }
                                .header {
                                    margin-bottom: 20px;
                                    padding-bottom: 15px;
                                    border-bottom: 1px solid #ddd;
                                }
                                .logo-address-section {
                                    width: 100%;
                                    margin-bottom: 15px;
                                }
                                .company-logo {
                                    width: 100px;
                                    height: auto;
                                    margin-bottom: 10px;
                                    display: block;
                                }
                                .company-info {
                                    text-align: left;
                                    font-size: 11px;
                                    line-height: 1.3;
                                }
                                .company-name {
                                    font-size: 16px;
                                    font-weight: bold;
                                    margin: 0 0 3px 0;
                                    color: #2c5282;
                                }
                                .company-address {
                                    font-size: 10px;
                                    margin: 0 0 2px 0;
                                }
                                .report-details {
                                    margin-top: 15px;
                                    padding-top: 10px;
                                    border-top: 1px solid #ddd;
                                }
                                .detail-row {
                                    display: flex;
                                    margin-bottom: 4px;
                                }
                                .detail-label {
                                    font-weight: bold;
                                    width: 100px;
                                }
                                .detail-value {
                                    flex: 1;
                                }
                                table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    margin: 10px 0 15px 0;
                                    page-break-inside: avoid;
                                }
                                th {
                                    background-color: #f8f9fa;
                                    color: #000;
                                    padding: 6px 4px;
                                    text-align: left;
                                    border: 1px solid #ddd;
                                    font-size: 10px;
                                    font-weight: bold;
                                }
                                td {
                                    padding: 5px 4px;
                                    border: 1px solid #ddd;
                                    font-size: 10px;
                                }
                                .customer-section {
                                    margin-bottom: 20px;
                                    page-break-inside: avoid;
                                }
                                .customer-name {
                                    background-color: #e9ecef;
                                    padding: 6px 10px;
                                    font-weight: bold;
                                    margin-bottom: 8px;
                                    font-size: 12px;
                                    border-left: 3px solid #3498db;
                                }
                                .footer {
                                    margin-top: 30px;
                                    page-break-inside: avoid;
                                    padding-top: 15px;
                                    border-top: 1px solid #ddd;
                                }
                                .signature-section {
                                    width: 45%;
                                    display: inline-block;
                                    vertical-align: top;
                                }
                                .signature-line {
                                    margin-top: 30px;
                                    border-top: 1px solid #000;
                                    width: 180px;
                                    padding-top: 4px;
                                    font-size: 10px;
                                }
                                .no-print {
                                    display: none;
                                }
                            }
                            @media screen {
                                body {
                                    font-family: Arial, sans-serif;
                                    font-size: 12px;
                                    padding: 20px;
                                    background: #f5f5f5;
                                }
                                .report-container {
                                    max-width: 210mm;
                                    margin: 0 auto;
                                    background: white;
                                    padding: 20px;
                                    box-shadow: 0 0 10px rgba(0,0,0,0.1);
                                }
                                .header {
                                    margin-bottom: 20px;
                                    padding-bottom: 20px;
                                    border-bottom: 1px solid #ddd;
                                }
                                .logo-address-section {
                                    width: 100%;
                                    margin-bottom: 15px;
                                }
                                .company-logo {
                                    width: 120px;
                                    height: auto;
                                    margin-bottom: 10px;
                                    display: block;
                                }
                                .company-info {
                                    text-align: left;
                                    font-size: 12px;
                                    line-height: 1.4;
                                }
                                .company-name {
                                    font-size: 18px;
                                    font-weight: bold;
                                    margin: 0 0 5px 0;
                                    color: #2c5282;
                                }
                                .company-address {
                                    font-size: 11px;
                                    margin: 0 0 2px 0;
                                }
                                .report-details {
                                    margin-top: 15px;
                                    padding-top: 12px;
                                    border-top: 1px solid #ddd;
                                }
                                .detail-row {
                                    display: flex;
                                    margin-bottom: 5px;
                                }
                                .detail-label {
                                    font-weight: bold;
                                    width: 120px;
                                }
                                .detail-value {
                                    flex: 1;
                                }
                                table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    margin: 15px 0 20px 0;
                                }
                                th {
                                    background-color: #f8f9fa;
                                    color: #000;
                                    padding: 8px;
                                    text-align: left;
                                    border: 1px solid #ddd;
                                }
                                td {
                                    padding: 7px;
                                    border: 1px solid #ddd;
                                }
                                .customer-section {
                                    margin-bottom: 25px;
                                }
                                .customer-name {
                                    background-color: #e9ecef;
                                    padding: 8px 12px;
                                    font-weight: bold;
                                    margin-bottom: 10px;
                                    font-size: 13px;
                                    border-left: 4px solid #3498db;
                                }
                                .footer {
                                    margin-top: 40px;
                                    padding-top: 20px;
                                    border-top: 1px solid #ddd;
                                }
                                .signature-section {
                                    width: 45%;
                                    display: inline-block;
                                    vertical-align: top;
                                }
                                .signature-line {
                                    margin-top: 40px;
                                    border-top: 1px solid #000;
                                    width: 200px;
                                    padding-top: 5px;
                                }
                                .print-buttons {
                                    text-align: center;
                                    margin-top: 20px;
                                    padding: 20px;
                                    background: #f8f9fa;
                                    border-radius: 5px;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="report-container">
                            <!-- Header -->
                            <div class="header">
                                <div class="logo-address-section">
                                    <img src="macl.png" alt="MACL Logo" class="company-logo">
                                    <div class="company-info">
                                        <div class="company-name">Vilu Business Lounge</div>
                                        <div class="company-address">Seaplane Terminal</div>
                                        <div class="company-address">Velana International Airport</div>
                                        <div class="company-address">Hulhule: 22000</div>
                                        <div class="company-address">Republic of Maldives</div>
                                        <div class="company-address">T: 3337117 / 3331773 | M: 7288007</div>
                                        <div class="company-address">W: www.macl.aero / E: vilu.lounge@macl.aero</div>
                                    </div>
                                </div>
                                
                                <div class="report-details">
                                    <div class="detail-row">
                                        <div class="detail-label">Date:</div>
                                        <div class="detail-value">${currentDate}</div>
                                    </div>
                                    ${fromDate && toDate ? `
                                    <div class="detail-row">
                                        <div class="detail-label">Period:</div>
                                        <div class="detail-value">${fromDate} to ${toDate}</div>
                                    </div>
                                    ` : ''}
                                    <div class="detail-row">
                                        <div class="detail-label">Total Records:</div>
                                        <div class="detail-value">${reservations.length}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Report Content -->
                `;
                
                Object.entries(reservationsByCustomer).forEach(([customer, customerReservations]) => {
                    reportHTML += `
                        <div class="customer-section">
                            <div class="customer-name">Customer: ${customer} (${customerReservations.length} records)</div>
                            
                            <table>
                                <thead>
                                    <tr>
                                        <th>Guest Name</th>
                                        <th>Flight/Hotel</th>
                                        <th>Direction</th>
                                        <th>Nationality</th>
                                        <th>Reservation Date</th>
                                        <th>Check-In</th>
                                        <th>Check-Out</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    customerReservations.forEach(res => {
                        reportHTML += `
                            <tr>
                                <td>${res.guestName}</td>
                                <td>${res.flightHotel}</td>
                                <td>${res.direction}</td>
                                <td>${res.nationality}</td>
                                <td>${res.reservationDate}</td>
                                <td>${res.checkinTime || '-'}</td>
                                <td>${res.checkoutTime || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    reportHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                reportHTML += `
                            <!-- Footer Signatures -->
                            <div class="footer">
                                <div class="signature-section">
                                    <div class="detail-row">
                                        <div class="detail-label">Prepared by:</div>
                                        <div class="detail-value">${this.currentUser.name}</div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="detail-label">RC No:</div>
                                        <div class="detail-value">${this.currentUser.RCNo}</div>
                                    </div>
                                    <div class="signature-line">Signature</div>
                                </div>
                                
                                <div class="signature-section" style="float: right;">
                                    <div class="detail-row">
                                        <div class="detail-label">Checked by:</div>
                                        <div class="detail-value">_____________________</div>
                                    </div>
                                    <div class="detail-row">
                                        <div class="detail-label">RC No:</div>
                                        <div class="detail-value">_____________________</div>
                                    </div>
                                    <div class="signature-line">Signature</div>
                                </div>
                                <div style="clear: both;"></div>
                            </div>
                            
                            <!-- Print Buttons (only for screen) -->
                            <div class="print-buttons no-print">
                                <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                    Print Report
                                </button>
                                <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Close Window
                                </button>
                            </div>
                        </div>
                    </body>
                    </html>
                `;
                
                printWindow.document.write(reportHTML);
                printWindow.document.close();
                printWindow.focus();
            }

            // Excel Upload Functions - VILU COMPATIBLE VERSION
            handleExcelUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.readExcelFile(file);
                }
            }

            readExcelFile(file) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first worksheet
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                        
                        if (jsonData.length === 0) {
                            alert('Excel file is empty or has no valid data.');
                            return;
                        }
                        
                        console.log('Excel data loaded (raw):', jsonData);
                        
                        // Process VILU format specifically
                        const processedData = this.processViluExcelFormat(jsonData);
                        this.excelData = processedData;
                        this.displayExcelPreview(processedData);
                    } catch (error) {
                        console.error('Error reading Excel file:', error);
                        alert('Error reading Excel file. Please make sure it\'s a valid Excel file.');
                    }
                };
                
                reader.onerror = () => {
                    alert('Error reading file. Please try again.');
                };
                
                reader.readAsArrayBuffer(file);
            }

            // IMPROVED TIME PARSING FUNCTION
            parseTime(timeValue) {
                if (!timeValue && timeValue !== 0) return '00:00';
                
                // Convert to string and trim
                let timeStr = timeValue.toString().trim();
                
                // Handle Excel numeric time (fraction of day)
                if (!isNaN(timeValue) && timeValue < 1) {
                    // Excel stores times as fractions (0.5 = 12:00)
                    const totalSeconds = timeValue * 24 * 60 * 60;
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                }
                
                // Remove "Hrs" or "hrs" from time string
                timeStr = timeStr.replace(/hrs?/gi, '').trim();
                
                // Handle numeric values like 1130, 930, 1430
                if (!isNaN(timeStr) && timeStr.length >= 3 && timeStr.length <= 4) {
                    const num = parseInt(timeStr);
                    let hours, minutes;
                    
                    if (timeStr.length === 3) {
                        hours = Math.floor(num / 100);
                        minutes = num % 100;
                    } else {
                        hours = Math.floor(num / 100);
                        minutes = num % 100;
                    }
                    
                    // Ensure valid hours and minutes
                    if (hours >= 0 && hours <= 24 && minutes >= 0 && minutes <= 59) {
                        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    }
                }
                
                // Handle various string formats
                // Remove spaces and convert to uppercase
                timeStr = timeStr.replace(/\s+/g, '').toUpperCase();
                
                // Try to match patterns like:
                // 11:30, 11:30AM, 11:30 PM, 1130, 1130AM, 11.30, 11.30AM
                const patterns = [
                    /^(\d{1,2})[:.](\d{2})\s*(AM|PM)?$/i,      // 11:30, 11:30AM, 11.30
                    /^(\d{3,4})\s*(AM|PM)?$/i,                 // 1130, 1130AM
                    /^(\d{1,2})\s*(AM|PM)?$/i                  // 11, 11AM
                ];
                
                for (const pattern of patterns) {
                    const match = timeStr.match(pattern);
                    if (match) {
                        let hours = parseInt(match[1]);
                        let minutes = match[2] ? parseInt(match[2]) : 0;
                        const period = match[3] ? match[3].toUpperCase() : '';
                        
                        // Handle 12-hour format
                        if (period === 'PM' && hours < 12) hours += 12;
                        if (period === 'AM' && hours === 12) hours = 0;
                        
                        // Handle 24-hour format for times like 1330
                        if (!period && hours < 24 && match[1].length >= 3) {
                            if (match[1].length === 3) {
                                hours = Math.floor(hours / 10);
                                minutes = hours % 10 * 10 + minutes;
                            } else if (match[1].length === 4) {
                                minutes = hours % 100;
                                hours = Math.floor(hours / 100);
                            }
                        }
                        
                        // Validate hours and minutes
                        if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                        }
                    }
                }
                
                // Try to parse as Date object
                const date = new Date(timeValue);
                if (!isNaN(date.getTime())) {
                    const hours = date.getHours();
                    const minutes = date.getMinutes();
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                }
                
                console.warn('Could not parse time:', timeValue);
                return '00:00';
            }

            // IMPROVED DATE PARSING FUNCTION
            parseDate(dateValue) {
                if (!dateValue) return new Date().toISOString().split('T')[0];
                
                // Convert to string
                let dateStr = dateValue.toString().trim();
                
                // Handle Excel serial date (number)
                if (!isNaN(dateValue) && dateValue > 25569) {
                    // Excel date (days since 1900)
                    const excelDate = new Date((dateValue - 25569) * 86400 * 1000);
                    return excelDate.toISOString().split('T')[0];
                }
                
                // Handle date-time strings like "2026-01-25 00:00:00"
                if (dateStr.includes(' ')) {
                    dateStr = dateStr.split(' ')[0];
                }
                
                // Try common date formats
                const dateFormats = [
                    /^(\d{4})-(\d{1,2})-(\d{1,2})$/,      // YYYY-MM-DD
                    /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,    // MM/DD/YYYY or DD/MM/YYYY
                    /^(\d{1,2})-(\d{1,2})-(\d{4})$/,      // DD-MM-YYYY
                    /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/,    // DD.MM.YYYY
                    /^(\d{4})(\d{2})(\d{2})$/,            // YYYYMMDD
                    /^(\d{1,2})\/(\d{1,2})\/(\d{2})$/,    // MM/DD/YY
                ];
                
                for (const format of dateFormats) {
                    const match = dateStr.match(format);
                    if (match) {
                        let year, month, day;
                        
                        if (format.source.includes('YYYY') || format.source.includes('YY')) {
                            // Format with explicit year
                            if (format.source.startsWith('^\\d{4}')) {
                                // YYYY-MM-DD or YYYYMMDD
                                year = parseInt(match[1]);
                                month = parseInt(match[2]) - 1;
                                day = parseInt(match[3]);
                            } else {
                                // Other formats
                                if (match[3].length === 4) {
                                    year = parseInt(match[3]);
                                    month = parseInt(match[1]) - 1;
                                    day = parseInt(match[2]);
                                } else {
                                    // 2-digit year
                                    year = 2000 + parseInt(match[3]);
                                    month = parseInt(match[1]) - 1;
                                    day = parseInt(match[2]);
                                }
                            }
                            
                            const date = new Date(year, month, day);
                            if (!isNaN(date.getTime())) {
                                return date.toISOString().split('T')[0];
                            }
                        }
                    }
                }
                
                // Try JavaScript Date parsing as last resort
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
                
                console.warn('Could not parse date:', dateValue);
                return new Date().toISOString().split('T')[0];
            }

            // VILU EXCEL SPECIFIC PROCESSING - FIXED VERSION
            processViluExcelFormat(data) {
                console.log('Processing VILU Excel format with raw data:', data);
                
                const reservations = [];
                const today = new Date().toISOString().split('T')[0];
                
                let contactPerson = '';
                let guestSectionStart = -1;
                
                // First pass: Find customer information and guest section
                for (let i = 0; i < data.length; i++) {
                    const row = data[i];
                    
                    // Skip empty rows
                    if (!row || row.length === 0) continue;
                    
                    // Look for "Contact Person:" in row
                    for (let j = 0; j < row.length; j++) {
                        const cell = row[j];
                        if (typeof cell === 'string') {
                            const cellLower = cell.toLowerCase().trim();
                            
                            // Find contact person - look for "Contact Person:" in any cell
                            if (cellLower === 'contact person:' || cellLower.includes('contact person')) {
                                // Contact person value is usually in the same row, next cell or same cell
                                // Try to extract from the cell itself if it contains ":"
                                if (cell.includes(':')) {
                                    const parts = cell.split(':');
                                    if (parts.length > 1) {
                                        contactPerson = parts[1].trim();
                                        if (!contactPerson) {
                                            // Check next cell in same row
                                            for (let k = j + 1; k < row.length; k++) {
                                                if (row[k] && row[k].toString().trim() !== '') {
                                                    contactPerson = row[k].toString().trim();
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                } else {
                                    // Check next cells for contact person value
                                    for (let k = j + 1; k < row.length; k++) {
                                        if (row[k] && row[k].toString().trim() !== '') {
                                            contactPerson = row[k].toString().trim();
                                            break;
                                        }
                                    }
                                }
                                console.log('Found contact person:', contactPerson, 'at row', i, 'col', j);
                            }
                            
                            // Find guest information section - look for "Guest Name" header
                            if (cellLower === 'guest name' && guestSectionStart === -1) {
                                guestSectionStart = i;
                                console.log('Guest section header found at row:', i, 'cell:', j);
                                // Check the next row for column headers
                                if (i + 1 < data.length) {
                                    const nextRow = data[i + 1];
                                    console.log('Next row (column headers):', nextRow);
                                }
                            }
                        }
                    }
                }
                
                // Use contact person as customer
                const customerName = contactPerson || 'Unknown Customer';
                
                console.log('Using customer:', customerName);
                console.log('Guest section starts at row:', guestSectionStart);
                
                // Second pass: Process guest rows
                if (guestSectionStart !== -1) {
                    // Start from 2 rows after the header (header row + column labels row)
                    const dataStartRow = guestSectionStart + 2;
                    
                    console.log('Processing guest data from row:', dataStartRow);
                    
                    for (let i = dataStartRow; i < data.length; i++) {
                        const row = data[i];
                        
                        // Skip empty rows or rows with no guest name
                        if (!row || row.length < 1) continue;
                        
                        const guestName = row[0]; // Guest Name is first column
                        
                        // Skip if no guest name or if it's empty
                        if (!guestName || guestName.toString().trim() === '') {
                            continue;
                        }
                        
                        console.log('Processing guest row', i, ':', row);
                        
                        // VILU Excel column mapping based on the provided sample:
                        // 0: Guest Name
                        // 1-5: Empty or other data
                        // 6: Passport No
                        // 7-8: Empty
                        // 9: Country (Nationality)
                        // 10-11: Empty
                        // 12: Flight No (Arrival)
                        // 13: Flight Time (Arrival)
                        // 14: Flight Date (Arrival)
                        // 15: Flight No (Departure)
                        // 16: Flight Time (Departure)
                        // 17: Flight Date (Departure)
                        
                        // Determine direction and extract flight info
                        let direction = 'Arrival';
                        let flightHotel = '';
                        let rawTime = '';
                        let rawDate = '';
                        let nationality = '';
                        
                        // Check if we have departure flight info
                        const hasDepartureInfo = row[15] && row[15].toString().trim() !== '';
                        
                        if (hasDepartureInfo) {
                            // This is a departure
                            direction = 'Departure';
                            flightHotel = row[15] ? row[15].toString().trim() : '';
                            rawTime = row[16] ? row[16].toString().trim() : '';
                            rawDate = row[17] ? row[17].toString().trim() : '';
                        } else {
                            // This is an arrival (default)
                            direction = 'Arrival';
                            flightHotel = row[12] ? row[12].toString().trim() : '';
                            rawTime = row[13] ? row[13].toString().trim() : '';
                            rawDate = row[14] ? row[14].toString().trim() : '';
                        }
                        
                        // Get nationality from column 9 (Country)
                        nationality = row[9] ? row[9].toString().trim() : '';
                        // If Country is empty, set nationality to empty (not 'Unknown')
                        
                        // Parse date and time
                        const parsedDate = this.parseDate(rawDate || today);
                        const parsedTime = this.parseTime(rawTime || '00:00');
                        
                        // Create reservation object
                        const reservation = {
                            customer: customerName,
                            reservationDate: parsedDate,
                            flightHotel: flightHotel || 'Unknown Flight',
                            eta: parsedTime,
                            direction: direction,
                            guestName: guestName.toString().trim(),
                            nationality: nationality, // Empty if Country was empty
                            remarks: `Imported from VILU Excel - ${direction}: ${flightHotel || 'No flight info'}`,
                            status: 'reserved',
                            isFOC: false,
                            createdAt: new Date().toISOString(),
                            createdBy: this.currentUser.username,
                            source: 'vilu_excel_import'
                        };
                        
                        console.log('Created reservation:', reservation);
                        
                        // Validate the reservation
                        if (this.validateReservation(reservation)) {
                            reservations.push(reservation);
                        } else {
                            console.log('Invalid reservation skipped:', reservation);
                        }
                    }
                }
                
                console.log(`Found ${reservations.length} reservations in VILU format`);
                return reservations;
            }

            validateReservation(reservation) {
                // Check required fields
                const requiredFields = ['customer', 'guestName', 'flightHotel'];
                
                for (const field of requiredFields) {
                    if (!reservation[field] || reservation[field].toString().trim() === '') {
                        console.log(`Missing required field: ${field}`, reservation);
                        return false;
                    }
                }
                
                // Validate date format (YYYY-MM-DD)
                const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                if (!dateRegex.test(reservation.reservationDate)) {
                    console.log('Invalid date format:', reservation.reservationDate);
                    return false;
                }
                
                // Validate time format (HH:MM)
                const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
                if (!timeRegex.test(reservation.eta)) {
                    console.log('Invalid time format:', reservation.eta);
                    return false;
                }
                
                return true;
            }

            displayExcelPreview(data) {
                const previewContainer = document.getElementById('excelPreview');
                const previewHeader = document.getElementById('excelPreviewHeader');
                const previewBody = document.getElementById('excelPreviewBody');
                const previewCount = document.getElementById('previewCount');
                
                if (!previewContainer || !previewHeader || !previewBody) return;
                
                // Clear previous preview
                previewHeader.innerHTML = '';
                previewBody.innerHTML = '';
                
                if (data.length > 0) {
                    // Create header row for preview
                    const headers = [
                        'Guest Name', 'Customer', 'Flight/Hotel', 'ETA', 
                        'Direction', 'Nationality', 'Reservation Date', 'Status'
                    ];
                    
                    // Create header row
                    let headerHtml = '<tr>';
                    headers.forEach(header => {
                        headerHtml += `<th>${header}</th>`;
                    });
                    headerHtml += '</tr>';
                    previewHeader.innerHTML = headerHtml;
                    
                    // Create data rows
                    let validCount = 0;
                    const previewLimit = Math.min(10, data.length);
                    
                    for (let i = 0; i < previewLimit; i++) {
                        const reservation = data[i];
                        const isValid = this.validateReservation(reservation);
                        
                        let rowHtml = '<tr>';
                        
                        // Guest Name
                        rowHtml += `<td><strong>${reservation.guestName || ''}</strong></td>`;
                        
                        // Customer
                        rowHtml += `<td>${reservation.customer || ''}</td>`;
                        
                        // Flight/Hotel
                        rowHtml += `<td>${reservation.flightHotel || ''}</td>`;
                        
                        // ETA
                        rowHtml += `<td>${reservation.eta || ''}</td>`;
                        
                        // Direction
                        rowHtml += `<td>${reservation.direction || 'Arrival'}</td>`;
                        
                        // Nationality
                        rowHtml += `<td>${reservation.nationality || ''}</td>`;
                        
                        // Reservation Date
                        rowHtml += `<td>${reservation.reservationDate || ''}</td>`;
                        
                        // Validation Status
                        rowHtml += `<td style="background-color: ${isValid ? '#d4edda' : '#f8d7da'}">
                            ${isValid ? ' Valid' : ' Invalid'}
                            <br><small>${!reservation.flightHotel || reservation.flightHotel === 'Unknown Flight' ? 'No flight' : ''}</small>
                        </td>`;
                        
                        rowHtml += '</tr>';
                        previewBody.innerHTML += rowHtml;
                        
                        if (isValid) validCount++;
                    }
                    
                    // Add summary row
                    previewBody.innerHTML += `
                        <tr>
                            <td colspan="8" style="background-color: #e9ecef; font-weight: bold;">
                                Summary: ${validCount} valid / ${previewLimit} shown (Total: ${data.length} reservations)
                                ${validCount < data.length ? `<br><small>${data.length - validCount} invalid due to missing data</small>` : ''}
                            </td>
                        </tr>
                    `;
                    
                    previewCount.textContent = data.length;
                    previewContainer.classList.remove('d-none');
                    
                    // Show sample of what will be uploaded
                    if (data.length > 0) {
                        const sample = data[0];
                        const issues = [];
                        if (!sample.customer || sample.customer === 'Unknown Customer') issues.push('Customer');
                        if (!sample.flightHotel || sample.flightHotel === 'Unknown Flight') issues.push('Flight');
                        if (sample.eta === '00:00') issues.push('ETA');
                        
                        let message = `VILU Excel detected! Found ${data.length} guest entries.\n\nSample entry:\n- Guest: ${sample.guestName}\n- Customer: ${sample.customer}\n- Flight: ${sample.flightHotel}\n- ETA: ${sample.eta}\n- Date: ${sample.reservationDate}\n- Direction: ${sample.direction}\n- Nationality: ${sample.nationality || '(empty)'}`;
                        
                        if (issues.length > 0) {
                            message += `\n\n Issues detected in sample: ${issues.join(', ')}`;
                            message += `\nPlease check the Excel format matches VILU template.`;
                        }
                        
                        alert(message);
                    }
                }
            }

            async uploadExcelData() {
                if (this.excelData.length === 0) {
                    alert('No data to upload. Please select an Excel file first.');
                    return;
                }

                // Filter valid reservations
                const reservations = this.excelData.filter(res => this.validateReservation(res));
                
                if (reservations.length === 0) {
                    alert('No valid reservations found to upload.');
                    return;
                }

                if (!confirm(`Are you sure you want to upload ${reservations.length} reservations?`)) {
                    return;
                }

                let successCount = 0;
                let errorCount = 0;
                let skippedRows = [];

                // Show processing message
                alert(`Processing ${reservations.length} records... Please wait.`);

                // Process each reservation
                for (let i = 0; i < reservations.length; i++) {
                    const reservation = reservations[i];
                    try {
                        // Add to Firebase
                        await this.db.collection('reservations').add(reservation);
                        successCount++;
                        
                        // Add to autocomplete sets
                        if (reservation.customer) this.customers.add(reservation.customer);
                        if (reservation.flightHotel) this.flightHotels.add(reservation.flightHotel);
                        
                    } catch (error) {
                        console.error(`Error uploading reservation ${i + 1}:`, reservation, error);
                        skippedRows.push({ 
                            index: i + 1, 
                            reason: error.message, 
                            guest: reservation.guestName 
                        });
                        errorCount++;
                    }
                }

                // Show detailed results
                let resultMessage = `Upload completed!\n\nSuccess: ${successCount}\nFailed: ${errorCount}`;
                
                if (skippedRows.length > 0) {
                    resultMessage += `\n\nSkipped Reservations (first 5):`;
                    skippedRows.slice(0, 5).forEach(skip => {
                        resultMessage += `\n#${skip.index} (${skip.guest}): ${skip.reason}`;
                    });
                    if (skippedRows.length > 5) {
                        resultMessage += `\n... and ${skippedRows.length - 5} more`;
                    }
                }
                
                alert(resultMessage);
                
                // Clear preview and refresh data
                this.clearExcelPreview();
                this.loadCheckinData();
                this.loadCheckoutData();
                this.loadFlightOptionsForCheckin();
                this.loadFlightOptionsForCheckout();
                this.loadCustomerOptionsForCheckin();
                this.loadCustomerOptionsForCheckout();
                this.loadReportOptions();
                this.updateStats();
                this.loadOverviewData();
            }

            clearExcelPreview() {
                const previewContainer = document.getElementById('excelPreview');
                const fileInput = document.getElementById('excelFileInput');
                
                if (previewContainer) previewContainer.classList.add('d-none');
                if (fileInput) fileInput.value = '';
                this.excelData = [];
            }

            async updateStats() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Get all reservations for today
                    const snapshot = await this.db.collection('reservations')
                        .where('reservationDate', '==', today)
                        .get();
                    
                    let reserved = 0;
                    let checkedin = 0;
                    let checkedout = 0;
                    let foc = 0;
                    let noshow = 0;
                    let cancelled = 0;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        if (data.status.includes('reserved') && !data.status.includes('foc')) reserved++;
                        if (data.status.includes('checked-in') && !data.status.includes('foc')) checkedin++;
                        if (data.status.includes('checked-out') && !data.status.includes('foc')) checkedout++;
                        if (data.isFOC) foc++;
                        if (data.status.includes('noshow')) noshow++;
                        if (data.status === 'cancelled') cancelled++;
                    });
                    
                    // Update stats display
                    document.getElementById('statReservations').textContent = reserved;
                    document.getElementById('statCheckins').textContent = checkedin;
                    document.getElementById('statCheckouts').textContent = checkedout;
                    document.getElementById('statFOC').textContent = foc;
                    document.getElementById('statNoshow').textContent = noshow;
                    document.getElementById('statCancelled').textContent = cancelled;
                    document.getElementById('statActive').textContent = checkedin; // Active = currently checked in
                    
                    // Show quick stats section
                    document.getElementById('quickStats').classList.remove('d-none');
                    
                } catch (error) {
                    console.error('Error updating stats:', error);
                }
            }

            async loadOverviewData() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Get all reservations for today
                    const snapshot = await this.db.collection('reservations')
                        .where('reservationDate', '==', today)
                        .get();
                    
                    let reservedList = [];
                    let checkedinList = [];
                    let checkedoutList = [];
                    let focList = [];
                    let noshowList = [];
                    
                    let overviewReserved = 0;
                    let overviewCheckedIn = 0;
                    let overviewCheckedOut = 0;
                    let overviewFOC = 0;
                    let overviewNoShow = 0;
                    let overviewCancelled = 0;
                    let overviewTotalToday = 0;
                    let overviewActiveNow = 0;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const id = doc.id;
                        
                        overviewTotalToday++;
                        
                        if (data.status.includes('reserved') && !data.status.includes('foc')) {
                            overviewReserved++;
                            reservedList.push({ id, ...data });
                        }
                        if (data.status.includes('checked-in') && !data.status.includes('foc')) {
                            overviewCheckedIn++;
                            overviewActiveNow++;
                            checkedinList.push({ id, ...data });
                        }
                        if (data.status.includes('checked-out') && !data.status.includes('foc')) {
                            overviewCheckedOut++;
                            checkedoutList.push({ id, ...data });
                        }
                        if (data.isFOC) {
                            overviewFOC++;
                            focList.push({ id, ...data });
                        }
                        if (data.status.includes('noshow')) {
                            overviewNoShow++;
                            noshowList.push({ id, ...data });
                        }
                        if (data.status === 'cancelled') {
                            overviewCancelled++;
                        }
                    });
                    
                    // Update overview counts
                    document.getElementById('overviewReserved').textContent = overviewReserved;
                    document.getElementById('overviewCheckedIn').textContent = overviewCheckedIn;
                    document.getElementById('overviewCheckedOut').textContent = overviewCheckedOut;
                    document.getElementById('overviewFOC').textContent = overviewFOC;
                    document.getElementById('overviewNoShow').textContent = overviewNoShow;
                    document.getElementById('overviewCancelled').textContent = overviewCancelled;
                    document.getElementById('overviewTotalToday').textContent = overviewTotalToday;
                    document.getElementById('overviewActiveNow').textContent = overviewActiveNow;
                    
                    // Display lists
                    this.displayOverviewList('overviewReservedList', reservedList, 'reserved');
                    this.displayOverviewList('overviewCheckedInList', checkedinList, 'checkedin');
                    this.displayOverviewList('overviewCheckedOutList', checkedoutList, 'checkedout');
                    this.displayOverviewList('overviewFOCList', focList, 'foc');
                    this.displayOverviewList('overviewNoShowList', noshowList, 'noshow');
                    
                } catch (error) {
                    console.error('Error loading overview data:', error);
                }
            }

            displayOverviewList(elementId, list, type) {
                const element = document.getElementById(elementId);
                const countElement = document.getElementById(`${type}Count`);
                
                if (!element) return;
                
                // Update count badge
                if (countElement) {
                    countElement.textContent = `${list.length} ${list.length === 1 ? 'guest' : 'guests'}`;
                }
                
                if (list.length === 0) {
                    element.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center text-muted py-4">
                                No ${type.replace(/([A-Z])/g, ' $1').toLowerCase()} passengers
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                for (let i = 0; i < list.length; i++) {
                    const item = list[i];
                    
                    let statusBadge = '';
                    let timeInfo = '';
                    
                    if (type === 'reserved') {
                        statusBadge = '<span class="badge bg-warning text-dark">Reserved</span>';
                        timeInfo = item.eta || '';
                    } else if (type === 'checkedin') {
                        statusBadge = '<span class="badge bg-success">Checked-In</span>';
                        timeInfo = item.checkinTime || '';
                    } else if (type === 'checkedout') {
                        statusBadge = '<span class="badge bg-info">Checked-Out</span>';
                        timeInfo = item.checkoutTime || '';
                    } else if (type === 'foc') {
                        if (item.status.includes('checked-in')) {
                            statusBadge = '<span class="badge bg-success">Checked-In</span>';
                            timeInfo = item.checkinTime || '';
                        } else if (item.status.includes('checked-out')) {
                            statusBadge = '<span class="badge bg-info">Checked-Out</span>';
                            timeInfo = item.checkoutTime || '';
                        } else if (item.status.includes('reserved')) {
                            statusBadge = '<span class="badge bg-warning">Reserved</span>';
                            timeInfo = item.eta || '';
                        } else {
                            statusBadge = '<span class="badge bg-foc">FOC</span>';
                        }
                    } else if (type === 'noshow') {
                        statusBadge = '<span class="badge bg-secondary">No-Show</span>';
                        timeInfo = item.eta || '';
                    }
                    
                    html += `
                        <tr onclick="app.showReservationDetails('${item.id}')" style="cursor: pointer;" title="Click to view details">
                            <td><strong>${item.guestName}</strong></td>
                            <td>${item.flightHotel}</td>
                            <td>${type === 'foc' ? statusBadge : timeInfo}</td>
                        </tr>
                    `;
                }
                
                element.innerHTML = html;
            }

            async showReservationDetails(reservationId) {
                try {
                    const doc = await this.db.collection('reservations').doc(reservationId).get();
                    if (!doc.exists) {
                        alert('Reservation not found!');
                        return;
                    }
                    
                    const reservation = doc.data();
                    
                    // Create modal for details
                    const modalHtml = `
                        <div class="modal fade" id="reservationDetailsModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Reservation Details</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Guest Name:</strong></label>
                                                    <p>${reservation.guestName}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Customer:</strong></label>
                                                    <p>${reservation.customer}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Flight/Hotel:</strong></label>
                                                    <p>${reservation.flightHotel}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>ETA:</strong></label>
                                                    <p>${reservation.eta}</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Direction:</strong></label>
                                                    <p>${reservation.direction}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Nationality:</strong></label>
                                                    <p>${reservation.nationality}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Reservation Date:</strong></label>
                                                    <p>${reservation.reservationDate}</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label"><strong>Status:</strong></label>
                                                    <span class="badge bg-${reservation.status.includes('foc') ? 'foc' : 
                                                        reservation.status === 'reserved' ? 'warning' : 
                                                        reservation.status === 'checked-in' ? 'success' : 
                                                        reservation.status === 'checked-out' ? 'info' : 
                                                        reservation.status === 'noshow' ? 'secondary' : 'danger'}">${reservation.status}</span>
                                                    ${reservation.isFOC ? '<span class="badge bg-foc ms-2">FOC</span>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <label class="form-label"><strong>Created:</strong></label>
                                            <p>${new Date(reservation.createdAt).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-danger" onclick="app.deleteReservation('${reservationId}')">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remove existing modal if any
                    const existingModal = document.getElementById('reservationDetailsModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Add modal to body
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('reservationDetailsModal'));
                    modal.show();
                    
                } catch (error) {
                    console.error('Error loading reservation details:', error);
                    alert('Error loading reservation details.');
                }
            }

            async deleteReservation(reservationId) {
                if (!confirm('Are you sure you want to delete this reservation? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    await this.db.collection('reservations').doc(reservationId).delete();
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reservationDetailsModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    alert('Reservation deleted successfully!');
                    
                    // Refresh other data
                    this.loadCheckinData();
                    this.loadCheckoutData();
                    this.updateStats();
                    
                } catch (error) {
                    console.error('Error deleting reservation:', error);
                    alert('Error deleting reservation. Please try again.');
                }
            }

            downloadExcelTemplate() {
                // Create VILU Business Lounge template based on the provided format
                const viluTemplate = [
                    ['VILU Business Lounge', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Seaplane Terminal', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Maldives Airports Company Limited', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Velana International Airport', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Hulhule 2200', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Republic of Maldives', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Booking Number:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['VILU BUSINESS LOUNGE SERVICE APPLICATION FORM', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['1- Service Applicant:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Name of Service Applicant:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Contact Person:', 'AIRLINE COMPANY CONTACT', '', '', '', '', 'Telephone/Mobile', '', '', 'Fax', '', '', 'Email', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Billing Address:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Contact Person', '', '', '', '', '', 'Telephone/Mobile', '', '', 'Fax', '', '', 'Email', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['2- Guest Information (if required more space please attach sheets in this format)', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Guest Name', '', '', '', '', '', 'Passport No:', '', '', 'Country', '', '', 'Arrival', '', '', 'Departure', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', 'Flight No', 'Flight Time', 'Flight Date', 'Flight No', 'Flight Time', 'Flight Date'],
                    ['Haruka Yazaki', '', '', '', '', '', 'AB123456', '', '', 'Japan', '', '', 'Somerset', '07:15 Hrs', '2026-01-25', '', '', ''],
                    ['Hayato Atagi', '', '', '', '', '', 'CD789012', '', '', 'Japan', '', '', 'Somerset', '07:15 Hrs', '2026-01-25', '', '', ''],
                    ['Frank Johnsen', '', '', '', '', '', 'EF345678', '', '', 'Norway', '', '', 'EK656', '07:35 Hrs', '2026-01-25', '', '', ''],
                    ['Ana-Maria Mereuta Johnsen', '', '', '', '', '', 'GH456789', '', '', 'Norway', '', '', 'EK656', '07:35 Hrs', '2026-01-25', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['4- Flight Details  (Please Tick ( ) required service below)', '', '', '', '', '', '5-  Preference (Please Tick ( ) below)', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Arrival', '', '', 'Departure', '', '', 'Gluten Free', '', 'Lactose Free', '', '', 'Vegan', '', '', 'Nut Allergy', '', '', ''],
                    ['Airline:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Flight No.:', '', '', '', '', '', '6- Special Assistance (Please Tick ( ) the required service)', '', '', '', '', '', '', '', '', '', ''],
                    ['Time:', '', '', '', '', '', 'Wheel Chair', '', '', 'Stretcher', '', '', '', 'Ambulance', '', '', '', ''],
                    ['Date:', '', '', '', '', '', '7- If any special name preferred for "Name Board" please write below in capital letters', '', '', '', '', '', '', '', '', '', ''],
                    ['Origin/Destination:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['I have read the terms and conditions for VILU Business Lounge (seaplane terminal)  service and agreed to abide by', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['8- Applicant Signatory:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Name', '', '', '', '', '', 'Designation', '', '', 'Date', '', '', 'Time', '', '', 'Stamp & Signature', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['9-  Authorized Signatory of MACL for VILU Business Lounge (seaplane terminal)', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Name', '', '', '', '', '', 'Designation', '', '', 'Date', '', '', 'Time', '', '', 'Stamp & Signature', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Important Information:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Reservation of VILU Business lounge (seaplane Terminal) for the following day shall be made, before 1900hrs of every day, and all late bookings must be notified  02 hours prior to the movement time.(Applications for early morning flights during non working hours will be counted from lounge opening time).VILU Business Lounge will be open from 0500am to 0900pm. For reservations the hotline is +(960)    and VILU Business lounge service application form" can be emailed to :   email:vilu.lounge@macl.aero', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['Telephone + (960) 7288007            Fax: + (960)  3331640               e-mail: vilu.lounge@macl.aero       website: www.macl.aero', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
                ];
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(viluTemplate);
                
                // Set column widths for better readability
                const wscols = [];
                for (let i = 0; i < 18; i++) {
                    wscols.push({ wch: 15 });
                }
                ws['!cols'] = wscols;
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'VILU Template');
                XLSX.writeFile(wb, 'VILU_Business_Lounge_Template.xlsx');
                
                alert('VILU Business Lounge template downloaded. Fill in rows 22-25 with guest information and set Contact Person in row 13.');
            }

            async exportToExcel() {
                const fromDateInput = document.getElementById('reportFromDate');
                const toDateInput = document.getElementById('reportToDate');
                const flightSelect = document.getElementById('reportFlightFilter');
                const customerSelect = document.getElementById('reportCustomerFilter');
                
                if (!fromDateInput || !toDateInput) return;
                
                const fromDate = fromDateInput.value;
                const toDate = toDateInput.value;
                const flightFilter = flightSelect ? flightSelect.value : '';
                const customerFilter = customerSelect ? customerSelect.value : '';
                
                if (fromDate && toDate && fromDate > toDate) {
                    alert('From date cannot be after To date');
                    return;
                }
                
                // Show loading
                alert('Generating Excel file... Please wait.');
                
                // Fetch data and export
                this.fetchDataForExport(fromDate, toDate, flightFilter, customerFilter);
            }

            async fetchDataForExport(fromDate, toDate, flightFilter, customerFilter) {
                try {
                    const snapshot = await this.db.collection('reservations').get();
                    const reservations = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // Apply filters
                        if (fromDate && toDate) {
                            const checkDate = data.checkoutDate || data.checkinDate || data.reservationDate;
                            if (!checkDate) return;
                            
                            if (checkDate < fromDate || checkDate > toDate) {
                                return;
                            }
                        }
                        
                        if (flightFilter && data.flightHotel !== flightFilter) return;
                        if (customerFilter && data.customer !== customerFilter) return;
                        
                        reservations.push(data);
                    });
                    
                    if (reservations.length === 0) {
                        alert('No data found for export.');
                        return;
                    }
                    
                    this.exportDataToExcel(reservations);
                } catch (error) {
                    console.error('Error fetching data for export:', error);
                    alert('Error generating Excel file.');
                }
            }

            exportDataToExcel(data) {
                // Prepare data for Excel
                const excelData = data.map(item => ({
                    'Customer': item.customer,
                    'Reservation Date': item.reservationDate,
                    'Flight/Hotel': item.flightHotel,
                    'ETA': item.eta,
                    'Direction': item.direction,
                    'Guest Name': item.guestName,
                    'Nationality': item.nationality,
                    'Status': item.status,
                    'Guest Type': item.isFOC ? 'FOC' : 'Regular',
                    'Check-In Time': item.checkinTime || '',
                    'Check-Out Time': item.checkoutTime || '',
                    'No-Show Time': item.noshowTime || '',
                    'Remarks': item.remarks || '',
                    'Created By': item.createdBy,
                    'Created At': new Date(item.createdAt).toLocaleString()
                }));
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Reservations');
                
                // Generate filename with date
                const dateStr = new Date().toISOString().split('T')[0];
                const filename = `Vilu_Lounge_Report_${dateStr}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, filename);
            }
        }

        // Initialize application
        const app = new ReservationSystem();
    </script>
   
</body>
</html>
