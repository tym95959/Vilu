<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation & Check-In System | Vilu Lounge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <style>
        :root {
            --primary-color: #0d9488;
            --secondary-color: #14b8a6;
            --accent-color: #f59e0b;
            --light-bg: #f0fdfa;
            --dark-bg: #134e4a;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --info-color: #0ea5e9;
            --danger-color: #ef4444;
            --foc-color: #8b5cf6;
            --noshow-color: #64748b;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --gradient-primary: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            --gradient-light: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
        }
        
        body { 
            background: var(--gradient-light);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #334155;
            min-height: 100vh;
        }
        
        .dashboard-card { 
            transition: var(--transition); 
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            background: white;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        
        /* BLACK HEADERS */
        .card-header {
            background: #000000 !important;
            color: white !important;
            font-weight: 600;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: none;
        }
        
        .modal-header {
            background: #000000 !important;
            color: white !important;
            border-bottom: none;
            padding: 20px;
        }
        
        .navbar {
            background: #000000 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 12px 0;
        }
        
        .login-container { 
            max-width: 420px; 
            margin: 80px auto; 
        }
        
        .nav-link { 
            color: #475569;
            font-weight: 500;
            border-radius: var(--border-radius);
            padding: 12px 20px;
            transition: var(--transition);
            margin: 0 5px;
        }
        
        .nav-link.active { 
            background: #000000;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .nav-link:hover:not(.active) {
            background-color: #f1f5f9;
            transform: translateY(-2px);
        }
        
        .table-responsive { 
            max-height: 500px; 
            overflow-y: auto; 
            border-radius: var(--border-radius);
            border: 1px solid #e2e8f0;
            background: white;
        }
        
        /* Status badges */
        .status-badge {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
        }
        
        .status-reserved { 
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-checkedin { 
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-checkedout { 
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-foc { 
            background-color: #ede9fe;
            color: #5b21b6;
        }
        
        .status-noshow { 
            background-color: #f1f5f9;
            color: #475569;
        }
        
        .status-cancelled { 
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        /* Bulk Actions Bar */
        .bulk-actions-bar {
            background: #f8fafc;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
            display: none;
        }
        
        .bulk-actions-bar.show {
            display: block;
        }
        
        /* Filter section */
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-left: 4px solid #000000;
        }
        
        /* Form styles */
        .form-label {
            font-weight: 600;
            color: #475569;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        
        .form-control, .form-select {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 14px;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .btn {
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: #000000;
            color: white;
        }
        
        .btn-primary:hover {
            background: #333333;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Stats cards */
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border: 1px solid #e2e8f0;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #000000;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .definition-box {
            background: #f0fdfa;
            border-left: 4px solid #000000;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .breakdown-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid #e2e8f0;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
        }
        
        /* Report filters */
        .report-filters {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="card dashboard-card">
            <div class="card-header text-center py-4">
                <div class="logo-container mb-3">
                    <i class="fas fa-hotel fa-3x mb-2" style="color: white;"></i>
                    <h2 class="mb-1 fw-bold">Vilu Business Lounge</h2>
                    <p class="mb-0 opacity-90">Reservation System</p>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                        <input type="text" id="username" class="form-control" placeholder="Enter username">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="form-label">Password</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                        <input type="password" id="password" class="form-control" placeholder="Enter password">
                    </div>
                </div>
                <button id="loginBtn" class="btn btn-primary w-100 py-2">
                    <i class="fas fa-sign-in-alt me-2"></i> Login
                </button>
                <div id="loginError" class="alert alert-danger mt-3 d-none text-center"></div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="d-none">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid px-3">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-hotel me-2"></i>
                    Vilu Lounge
                </a>
                <div class="navbar-text text-white">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <small>Welcome,</small>
                            <div class="fw-bold" id="userName"></div>
                        </div>
                        <button class="btn btn-light btn-sm" id="logoutBtn">
                            <i class="fas fa-sign-out-alt me-1"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="content-wrapper">
            <!-- Tabs -->
            <div class="mt-3">
                <ul class="nav nav-pills" id="mainTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#reservationTab">
                            <i class="fas fa-calendar-plus me-1"></i> New Reservation
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#checkinTab">
                            <i class="fas fa-sign-in-alt me-1"></i> Check-In
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#checkoutTab">
                            <i class="fas fa-sign-out-alt me-1"></i> Check-Out
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#overviewTab">
                            <i class="fas fa-chart-bar me-1"></i> Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#reportTab">
                            <i class="fas fa-file-alt me-1"></i> Reports
                        </a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content mt-2">
                    <!-- Reservation Tab -->
                    <div class="tab-pane fade show active" id="reservationTab">
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-calendar-plus me-2"></i> New Reservation</h5>
                            </div>
                            <div class="card-body">
                                <form id="reservationForm" novalidate>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Customer</label>
                                            <input type="text" id="customer" class="form-control" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Date</label>
                                            <input type="date" id="reservationDate" class="form-control" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Flight/Hotel</label>
                                            <input type="text" id="flightHotel" class="form-control" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">STA</label>
                                            <input type="time" id="sta" class="form-control" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Direction</label>
                                            <select id="direction" class="form-select" required>
                                                <option value="">Select Direction</option>
                                                <option value="Arrival">Arrival</option>
                                                <option value="Departure">Departure</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Guest Name</label>
                                            <input type="text" id="guestName" class="form-control" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Nationality</label>
                                            <input type="text" id="nationality" class="form-control" required>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label">Remarks</label>
                                            <textarea id="remarks" class="form-control" rows="2"></textarea>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="isFOC">
                                                <label class="form-check-label" for="isFOC">
                                                    Free of Charge (FOC)
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-save me-1"></i> Save Reservation
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Check-In Tab -->
                    <div class="tab-pane fade" id="checkinTab">
                        <!-- Bulk Check-In Actions -->
                        <div class="bulk-actions-bar" id="bulkCheckinActions">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong><span id="selectedCheckinCount">0</span> guests selected</strong>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success btn-sm" onclick="app.bulkCheckin()">
                                        <i class="fas fa-sign-in-alt me-1"></i> Bulk Check-In
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="app.clearCheckinSelections()">
                                        <i class="fas fa-times me-1"></i> Clear All
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card dashboard-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-sign-in-alt me-2"></i> Check-In Guests</h5>
                            </div>
                            <div class="card-body">
                                <div class="filter-section">
                                    <div class="row g-2">
                                        <div class="col-md-3">
                                            <label class="form-label">Date</label>
                                            <input type="date" id="checkinDateFilter" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Flight/Hotel</label>
                                            <input type="text" id="checkinFlightFilter" class="form-control" placeholder="Filter flight/hotel">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Customer</label>
                                            <input type="text" id="checkinCustomerFilter" class="form-control" placeholder="Filter customer">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Status</label>
                                            <select id="checkinStatusFilter" class="form-select">
                                                <option value="">All</option>
                                                <option value="reserved">Reserved</option>
                                                <option value="foc-reserved">FOC Reserved</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Select All</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="selectAllCheckin" onchange="app.toggleSelectAllCheckin(this)">
                                                <label class="form-check-label" for="selectAllCheckin">
                                                    Select All Visible
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th width="50px"></th>
                                                <th>Guest</th>
                                                <th>Customer</th>
                                                <th>Flight</th>
                                                <th>STA</th>
                                                <th>Direction</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="checkinTable">
                                            <!-- Data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Check-Out Tab -->
                    <div class="tab-pane fade" id="checkoutTab">
                        <!-- Bulk Check-Out Actions -->
                        <div class="bulk-actions-bar" id="bulkCheckoutActions">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong><span id="selectedCheckoutCount">0</span> guests selected</strong>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-warning btn-sm" onclick="app.bulkCheckout()">
                                        <i class="fas fa-sign-out-alt me-1"></i> Bulk Check-Out
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="app.clearCheckoutSelections()">
                                        <i class="fas fa-times me-1"></i> Clear All
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card dashboard-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-sign-out-alt me-2"></i> Check-Out Guests</h5>
                            </div>
                            <div class="card-body">
                                <div class="filter-section">
                                    <div class="row g-2">
                                        <div class="col-md-3">
                                            <label class="form-label">Date</label>
                                            <input type="date" id="checkoutDateFilter" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Flight/Hotel</label>
                                            <input type="text" id="checkoutFlightFilter" class="form-control" placeholder="Filter flight/hotel">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Customer</label>
                                            <input type="text" id="checkoutCustomerFilter" class="form-control" placeholder="Filter customer">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Status</label>
                                            <select id="checkoutStatusFilter" class="form-select">
                                                <option value="">All</option>
                                                <option value="checked-in">Checked-In</option>
                                                <option value="foc-checkedin">FOC Checked-In</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Select All</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="selectAllCheckout" onchange="app.toggleSelectAllCheckout(this)">
                                                <label class="form-check-label" for="selectAllCheckout">
                                                    Select All Visible
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th width="50px"></th>
                                                <th>Guest</th>
                                                <th>Customer</th>
                                                <th>Flight</th>
                                                <th>Check-In Time</th>
                                                <th>Duration</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="checkoutTable">
                                            <!-- Data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Overview Tab -->
                    <div class="tab-pane fade" id="overviewTab">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="filter-section">
                                    <label class="form-label">Select Date</label>
                                    <input type="date" id="overviewDateFilter" class="form-control" value="<?php echo date('Y-m-d'); ?>">
                                </div>
                            </div>
                        </div>

                        <div class="definition-box">
                            <div class="definition-title">"Active Now" Definition</div>
                            <div class="definition-text">
                                "Active Now" shows guests who are currently checked in (arrived at lounge) but not yet checked out.
                                This is calculated from the check-in time until check-out completion.
                            </div>
                        </div>

                        <!-- Stats Row -->
                        <div class="row stats-row g-3">
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <i class="fas fa-calendar-check stat-icon text-warning"></i>
                                    <div class="stat-number" id="overviewReserved">0</div>
                                    <div class="stat-label">Reserved</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <i class="fas fa-sign-in-alt stat-icon text-success"></i>
                                    <div class="stat-number" id="overviewCheckedIn">0</div>
                                    <div class="stat-label">Checked-In</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <i class="fas fa-sign-out-alt stat-icon text-info"></i>
                                    <div class="stat-number" id="overviewCheckedOut">0</div>
                                    <div class="stat-label">Checked-Out</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <i class="fas fa-gift stat-icon text-foc"></i>
                                    <div class="stat-number" id="overviewFOC">0</div>
                                    <div class="stat-label">FOC Guests</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <i class="fas fa-times-circle stat-icon text-noshow"></i>
                                    <div class="stat-number" id="overviewNoShow">0</div>
                                    <div class="stat-label">No-Show</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="stat-card">
                                    <i class="fas fa-user-check stat-icon text-primary"></i>
                                    <div class="stat-number" id="overviewActiveNow">0</div>
                                    <div class="stat-label">Active Now</div>
                                </div>
                            </div>
                        </div>

                        <!-- Breakdown -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="breakdown-card">
                                    <div class="breakdown-header">Arrival/Departure Breakdown</div>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Direction</th>
                                                <th>Reserved</th>
                                                <th>Checked-In</th>
                                                <th>Checked-Out</th>
                                            </tr>
                                        </thead>
                                        <tbody id="directionBreakdown">
                                            <!-- Data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="breakdown-card">
                                    <div class="breakdown-header">Recent Activity</div>
                                    <div class="table-responsive" style="max-height: 250px;">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Time</th>
                                                    <th>Guest</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentActivity">
                                                <!-- Data will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Tab -->
                    <div class="tab-pane fade" id="reportTab">
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i> Reports</h5>
                            </div>
                            <div class="card-body">
                                <div class="report-filters">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">From Date</label>
                                            <input type="date" id="reportFromDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">To Date</label>
                                            <input type="date" id="reportToDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Customer</label>
                                            <input type="text" id="reportCustomerFilter" class="form-control" placeholder="Filter by customer">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Flight/Hotel</label>
                                            <input type="text" id="reportFlightFilter" class="form-control" placeholder="Filter by flight/hotel">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Report Type</label>
                                            <select id="reportType" class="form-select">
                                                <option value="all">All Guests</option>
                                                <option value="foc">FOC Only</option>
                                                <option value="noshow">No-Show Only</option>
                                                <option value="arrival">Arrival Only</option>
                                                <option value="departure">Departure Only</option>
                                            </select>
                                        </div>
                                        <div class="col-md-12 mt-3">
                                            <button id="generatePdfReportBtn" class="btn btn-primary">
                                                <i class="fas fa-file-pdf me-1"></i> Generate PDF Report
                                            </button>
                                            <button id="generateExcelReportBtn" class="btn btn-success ms-2">
                                                <i class="fas fa-file-excel me-1"></i> Export to Excel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Report Preview -->
                                <div id="reportPreview" class="mt-4" style="display: none;">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-eye me-2"></i> Report Preview</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm" id="reportPreviewTable">
                                                    <!-- Preview data will be loaded here -->
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Reservation Modal -->
    <div class="modal fade" id="editReservationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i> Edit Reservation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editReservationForm">
                        <input type="hidden" id="editReservationId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Customer</label>
                                <input type="text" id="editCustomer" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" id="editReservationDate" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Flight/Hotel</label>
                                <input type="text" id="editFlightHotel" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">STA</label>
                                <input type="time" id="editSta" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Direction</label>
                                <select id="editDirection" class="form-select" required>
                                    <option value="Arrival">Arrival</option>
                                    <option value="Departure">Departure</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Guest Name</label>
                                <input type="text" id="editGuestName" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nationality</label>
                                <input type="text" id="editNationality" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select id="editStatus" class="form-select">
                                    <option value="reserved">Reserved</option>
                                    <option value="checked-in">Checked-In</option>
                                    <option value="checked-out">Checked-Out</option>
                                    <option value="foc-reserved">FOC Reserved</option>
                                    <option value="foc-checkedin">FOC Checked-In</option>
                                    <option value="foc-checkedout">FOC Checked-Out</option>
                                    <option value="noshow">No-Show</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Guest Type</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editIsFOC">
                                    <label class="form-check-label" for="editIsFOC">
                                        Free of Charge (FOC)
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Remarks</label>
                                <textarea id="editRemarks" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="app.updateReservation()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase Config -->
    <script src="resfire.js"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Main Application Script -->
    <script>
    class ReservationSystem {
    constructor() {
        this.currentUser = null;
        this.db = firebase.firestore();
        this.customers = new Set();
        this.flightHotels = new Set();
        this.excelData = [];
        this.selectedCheckinIds = new Set();
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.checkAuth();
        this.loadAutocompleteData();
    }

    async loadAutocompleteData() {
        try {
            const snapshot = await this.db.collection('reservations').get();
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.customer) this.customers.add(data.customer);
                if (data.flightHotel) this.flightHotels.add(data.flightHotel);
            });
        } catch (error) {
            console.error('Error loading autocomplete data:', error);
        }
    }

    setupEventListeners() {
        // Login
        document.getElementById('loginBtn').addEventListener('click', () => this.login());
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
        
        // Forms
        document.getElementById('reservationForm').addEventListener('submit', (e) => this.saveReservation(e));
        
        // Autocomplete setup
        const customerInput = document.getElementById('customer');
        if (customerInput) {
            customerInput.addEventListener('focus', () => this.showCustomerDropdown());
            customerInput.addEventListener('input', (e) => this.filterCustomerDropdown(e.target.value));
        }
        
        const flightInput = document.getElementById('flightHotel');
        if (flightInput) {
            flightInput.addEventListener('focus', () => this.showFlightDropdown());
            flightInput.addEventListener('input', (e) => this.filterFlightDropdown(e.target.value));
        }
        
        // Click outside to close dropdowns
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                this.closeAllDropdowns();
            }
        });
        
        // Excel upload
        const excelInput = document.getElementById('excelFileInput');
        if (excelInput) {
            excelInput.addEventListener('change', (e) => this.handleExcelUpload(e));
        }
        
        const uploadBtn = document.getElementById('uploadExcelBtn');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', () => this.uploadExcelData());
        }
        
        // Excel drag and drop
        const excelUploadArea = document.getElementById('excelUploadArea');
        if (excelUploadArea) {
            excelUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                excelUploadArea.classList.add('dragover');
            });
            
            excelUploadArea.addEventListener('dragleave', () => {
                excelUploadArea.classList.remove('dragover');
            });
            
            excelUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                excelUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.match(/\.(xlsx|xls|csv)$/)) {
                    this.readExcelFile(files[0]);
                }
            });
        }
        
        // Filters
        const checkinDateFilter = document.getElementById('checkinDateFilter');
        if (checkinDateFilter) {
            checkinDateFilter.addEventListener('change', () => this.loadCheckinData());
        }
        
        const checkinFlightFilter = document.getElementById('checkinFlightFilter');
        if (checkinFlightFilter) {
            checkinFlightFilter.addEventListener('change', () => this.loadCheckinData());
        }
        
        const checkinCustomerFilter = document.getElementById('checkinCustomerFilter');
        if (checkinCustomerFilter) {
            checkinCustomerFilter.addEventListener('change', () => this.loadCheckinData());
        }
        
        const checkinStatusFilter = document.getElementById('checkinStatusFilter');
        if (checkinStatusFilter) {
            checkinStatusFilter.addEventListener('change', () => this.loadCheckinData());
        }
        
        const checkoutDateFilter = document.getElementById('checkoutDateFilter');
        if (checkoutDateFilter) {
            checkoutDateFilter.addEventListener('change', () => this.loadCheckoutData());
        }
        
        const checkoutFlightFilter = document.getElementById('checkoutFlightFilter');
        if (checkoutFlightFilter) {
            checkoutFlightFilter.addEventListener('change', () => this.loadCheckoutData());
        }
        
        const checkoutCustomerFilter = document.getElementById('checkoutCustomerFilter');
        if (checkoutCustomerFilter) {
            checkoutCustomerFilter.addEventListener('change', () => this.loadCheckoutData());
        }
        
        const checkoutStatusFilter = document.getElementById('checkoutStatusFilter');
        if (checkoutStatusFilter) {
            checkoutStatusFilter.addEventListener('change', () => this.loadCheckoutData());
        }
        
        const generateReportBtn = document.getElementById('generateReportBtn');
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', () => this.generateReport());
        }
        
        const generateExcelBtn = document.getElementById('generateExcelBtn');
        if (generateExcelBtn) {
            generateExcelBtn.addEventListener('click', () => this.exportToExcel());
        }
        
        // Tab change events
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (e) => {
                const target = e.target.getAttribute('href');
                if (target === '#checkinTab') {
                    this.loadCheckinData();
                    this.loadFlightOptionsForCheckin();
                    this.loadCustomerOptionsForCheckin();
                } else if (target === '#checkoutTab') {
                    this.loadCheckoutData();
                    this.loadFlightOptionsForCheckout();
                    this.loadCustomerOptionsForCheckout();
                } else if (target === '#reportTab') {
                    this.loadReportOptions();
                } else if (target === '#overviewTab') {
                    this.loadOverviewData();
                }
            });
        });

        // Auto-refresh overview data every 30 seconds
        setInterval(() => {
            if (document.getElementById('overviewTab') && document.getElementById('overviewTab').classList.contains('active')) {
                this.loadOverviewData();
            }
        }, 30000);
    }

    checkAuth() {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            this.currentUser = JSON.parse(savedUser);
            this.showDashboard();
        }
    }

    login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        // Hash the password using SHA-256
        this.hashPasswordSHA256(password).then(hashedPassword => {
            const user = users.find(u => u.username === username && u.passwordHash === hashedPassword);
            
            if (user) {
                this.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                this.showDashboard();
                this.hideError();
            } else {
                this.showError('Invalid username or password');
            }
        }).catch(error => {
            console.error('Error hashing password:', error);
            this.showError('Login error. Please try again.');
        });
    }

    async hashPasswordSHA256(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    showError(message) {
        const errorDiv = document.getElementById('loginError');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
        }
    }

    hideError() {
        const errorDiv = document.getElementById('loginError');
        if (errorDiv) {
            errorDiv.classList.add('d-none');
        }
    }

    showDashboard() {
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        
        if (loginScreen) loginScreen.classList.add('d-none');
        if (dashboard) dashboard.classList.remove('d-none');
        
        // Display user info
        const userName = document.getElementById('userName');
        const userLevel = document.getElementById('userLevel');
        const userRC = document.getElementById('userRC');
        
        if (userName) userName.textContent = this.currentUser.name;
        if (userLevel) userLevel.textContent = this.currentUser.Level;
        if (userRC) userRC.textContent = this.currentUser.RCNo;
        
        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        const dateFields = [
            'reservationDate',
            'checkinDateFilter',
            'checkoutDateFilter',
            'reportFromDate',
            'reportToDate'
        ];
        
        dateFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.value = today;
        });
        
        // Load initial data
        this.loadCheckinData();
        this.loadCheckoutData();
        this.loadFlightOptionsForCheckin();
        this.loadFlightOptionsForCheckout();
        this.loadCustomerOptionsForCheckin();
        this.loadCustomerOptionsForCheckout();
        this.loadReportOptions();
        this.loadOverviewData();
        this.updateStats();
    }

    logout() {
        this.currentUser = null;
        localStorage.removeItem('currentUser');
        
        const dashboard = document.getElementById('dashboard');
        const loginScreen = document.getElementById('loginScreen');
        
        if (dashboard) dashboard.classList.add('d-none');
        if (loginScreen) loginScreen.classList.remove('d-none');
        
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        
        if (usernameInput) usernameInput.value = '';
        if (passwordInput) passwordInput.value = '';
    }

    showCustomerDropdown() {
        this.closeAllDropdowns();
        const input = document.getElementById('customer');
        if (!input) return;
        
        const container = input.parentElement;
        const dropdown = document.createElement('div');
        dropdown.className = 'autocomplete-dropdown';
        
        // Add "Add new" option
        const addNewOption = document.createElement('div');
        addNewOption.className = 'dropdown-item';
        addNewOption.innerHTML = '<i class="fas fa-plus me-2"></i> Add new customer';
        addNewOption.onclick = () => {
            this.closeAllDropdowns();
            input.focus();
        };
        dropdown.appendChild(addNewOption);
        
        // Add existing customers
        Array.from(this.customers).sort().forEach(customer => {
            const option = document.createElement('div');
            option.className = 'dropdown-item';
            option.textContent = customer;
            option.onclick = () => {
                input.value = customer;
                this.closeAllDropdowns();
            };
            dropdown.appendChild(option);
        });
        
        container.style.position = 'relative';
        container.appendChild(dropdown);
    }

    showFlightDropdown() {
        this.closeAllDropdowns();
        const input = document.getElementById('flightHotel');
        if (!input) return;
        
        const container = input.parentElement;
        const dropdown = document.createElement('div');
        dropdown.className = 'autocomplete-dropdown';
        
        // Add "Add new" option
        const addNewOption = document.createElement('div');
        addNewOption.className = 'dropdown-item';
        addNewOption.innerHTML = '<i class="fas fa-plus me-2"></i> Add new flight/hotel';
        addNewOption.onclick = () => {
            this.closeAllDropdowns();
            input.focus();
        };
        dropdown.appendChild(addNewOption);
        
        // Add existing flights/hotels
        Array.from(this.flightHotels).sort().forEach(flightHotel => {
            const option = document.createElement('div');
            option.className = 'dropdown-item';
            option.textContent = flightHotel;
            option.onclick = () => {
                input.value = flightHotel;
                this.closeAllDropdowns();
            };
            dropdown.appendChild(option);
        });
        
        container.style.position = 'relative';
        container.appendChild(dropdown);
    }

    filterCustomerDropdown(searchTerm) {
        // Implement filtering if needed
    }

    filterFlightDropdown(searchTerm) {
        // Implement filtering if needed
    }

    closeAllDropdowns() {
        document.querySelectorAll('.autocomplete-dropdown').forEach(dropdown => {
            dropdown.remove();
        });
    }

    async saveReservation(e) {
        e.preventDefault();
        
        const isFOC = document.getElementById('isFOC').checked;
        const status = isFOC ? 'foc-reserved' : 'reserved';
        
        const customer = document.getElementById('customer').value;
        const flightHotel = document.getElementById('flightHotel').value;
        const reservationDate = document.getElementById('reservationDate').value;
        
        const reservation = {
            customer: customer,
            date: reservationDate,
            flightHotel: flightHotel,
            eta: document.getElementById('eta').value,
            direction: document.getElementById('direction').value,
            guestName: document.getElementById('guestName').value,
            nationality: document.getElementById('nationality').value,
            remarks: document.getElementById('remarks').value,
            status: status,
            isFOC: isFOC,
            createdAt: new Date().toISOString(),
            createdBy: this.currentUser.username,
            checkinDate: null,
            checkoutDate: null,
            reservationDate: reservationDate
        };
        
        try {
            const docRef = await this.db.collection('reservations').add(reservation);
            
            // Add to autocomplete sets
            if (customer) this.customers.add(customer);
            if (flightHotel) this.flightHotels.add(flightHotel);
            
            alert('Reservation saved successfully!');
            
            this.updateStats();
            
            document.getElementById('reservationForm').reset();
            document.getElementById('isFOC').checked = false;
            document.getElementById('reservationDate').value = new Date().toISOString().split('T')[0];
            
            // Refresh all data
            this.loadCheckinData();
            this.loadCheckoutData();
            this.loadFlightOptionsForCheckin();
            this.loadFlightOptionsForCheckout();
            this.loadCustomerOptionsForCheckin();
            this.loadCustomerOptionsForCheckout();
            this.loadReportOptions();
            this.loadOverviewData();
            
        } catch (error) {
            console.error('Error saving reservation:', error);
            alert('Error saving reservation. Please try again.');
        }
    }

    async saveFOCReservation() {
        const isFOC = true;
        const status = 'foc-reserved';
        
        const customer = document.getElementById('customer').value;
        const flightHotel = document.getElementById('flightHotel').value;
        const reservationDate = document.getElementById('reservationDate').value;
        
        if (!customer || !flightHotel || !reservationDate) {
            alert('Please fill in all required fields');
            return;
        }
        
        const reservation = {
            customer: customer,
            date: reservationDate,
            flightHotel: flightHotel,
            eta: document.getElementById('eta').value,
            direction: document.getElementById('direction').value,
            guestName: document.getElementById('guestName').value,
            nationality: document.getElementById('nationality').value,
            remarks: document.getElementById('remarks').value,
            status: status,
            isFOC: isFOC,
            createdAt: new Date().toISOString(),
            createdBy: this.currentUser.username,
            checkinDate: null,
            checkoutDate: null,
            reservationDate: reservationDate,
            focReason: 'Free of Charge Guest'
        };
        
        try {
            const docRef = await this.db.collection('reservations').add(reservation);
            
            // Add to autocomplete sets
            if (customer) this.customers.add(customer);
            if (flightHotel) this.flightHotels.add(flightHotel);
            
            alert('FOC Reservation saved successfully!');
            
            this.updateStats();
            
            document.getElementById('reservationForm').reset();
            document.getElementById('isFOC').checked = false;
            document.getElementById('reservationDate').value = new Date().toISOString().split('T')[0];
            
            // Refresh all data
            this.loadCheckinData();
            this.loadCheckoutData();
            this.loadFlightOptionsForCheckin();
            this.loadFlightOptionsForCheckout();
            this.loadCustomerOptionsForCheckin();
            this.loadCustomerOptionsForCheckout();
            this.loadReportOptions();
            this.loadOverviewData();
            
        } catch (error) {
            console.error('Error saving FOC reservation:', error);
            alert('Error saving FOC reservation. Please try again.');
        }
    }

    // Edit Reservation Functions
    async openEditModal(reservationId) {
        try {
            const doc = await this.db.collection('reservations').doc(reservationId).get();
            if (!doc.exists) {
                alert('Reservation not found!');
                return;
            }
            
            const reservation = doc.data();
            
            // Populate form
            document.getElementById('editReservationId').value = reservationId;
            document.getElementById('editCustomer').value = reservation.customer || '';
            document.getElementById('editReservationDate').value = reservation.reservationDate || '';
            document.getElementById('editFlightHotel').value = reservation.flightHotel || '';
            document.getElementById('editEta').value = reservation.eta || '';
            document.getElementById('editDirection').value = reservation.direction || 'Arrival';
            document.getElementById('editGuestName').value = reservation.guestName || '';
            document.getElementById('editNationality').value = reservation.nationality || '';
            document.getElementById('editStatus').value = reservation.status || 'reserved';
            document.getElementById('editIsFOC').checked = reservation.isFOC || false;
            document.getElementById('editRemarks').value = reservation.remarks || '';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error loading reservation for edit:', error);
            alert('Error loading reservation details.');
        }
    }

    async updateReservation() {
        const reservationId = document.getElementById('editReservationId').value;
        const isFOC = document.getElementById('editIsFOC').checked;
        
        const updatedData = {
            customer: document.getElementById('editCustomer').value,
            reservationDate: document.getElementById('editReservationDate').value,
            flightHotel: document.getElementById('editFlightHotel').value,
            eta: document.getElementById('editEta').value,
            direction: document.getElementById('editDirection').value,
            guestName: document.getElementById('editGuestName').value,
            nationality: document.getElementById('editNationality').value,
            status: document.getElementById('editStatus').value,
            isFOC: isFOC,
            remarks: document.getElementById('editRemarks').value,
            updatedAt: new Date().toISOString(),
            updatedBy: this.currentUser.username
        };
        
        try {
            await this.db.collection('reservations').doc(reservationId).update(updatedData);
            
            // Add to autocomplete sets
            if (updatedData.customer) this.customers.add(updatedData.customer);
            if (updatedData.flightHotel) this.flightHotels.add(updatedData.flightHotel);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editReservationModal'));
            if (modal) {
                modal.hide();
            }
            
            alert('Reservation updated successfully!');
            
            // Refresh all data
            this.loadCheckinData();
            this.loadCheckoutData();
            this.loadFlightOptionsForCheckin();
            this.loadFlightOptionsForCheckout();
            this.loadCustomerOptionsForCheckin();
            this.loadCustomerOptionsForCheckout();
            this.loadReportOptions();
            this.loadOverviewData();
            this.updateStats();
            
        } catch (error) {
            console.error('Error updating reservation:', error);
            alert('Error updating reservation. Please try again.');
        }
    }

    async loadFlightOptionsForCheckin() {
        try {
            const snapshot = await this.db.collection('reservations')
                .where('status', 'in', ['reserved', 'checked-in', 'foc-reserved', 'foc-checkedin'])
                .get();
            
            const flights = [...new Set(snapshot.docs.map(doc => doc.data().flightHotel))];
            const select = document.getElementById('checkinFlightFilter');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Flights/Hotels</option>';
            flights.forEach(flight => {
                if (flight) {
                    const option = document.createElement('option');
                    option.value = flight;
                    option.textContent = flight;
                    select.appendChild(option);
                }
            });
            
            if (flights.includes(currentValue)) {
                select.value = currentValue;
            }
        } catch (error) {
            console.error('Error loading flight options for check-in:', error);
        }
    }

    async loadCustomerOptionsForCheckin() {
        try {
            const snapshot = await this.db.collection('reservations')
                .where('status', 'in', ['reserved', 'checked-in', 'foc-reserved', 'foc-checkedin'])
                .get();
            
            const customers = [...new Set(snapshot.docs.map(doc => doc.data().customer))];
            const select = document.getElementById('checkinCustomerFilter');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Customers</option>';
            customers.forEach(customer => {
                if (customer) {
                    const option = document.createElement('option');
                    option.value = customer;
                    option.textContent = customer;
                    select.appendChild(option);
                }
            });
            
            if (customers.includes(currentValue)) {
                select.value = currentValue;
            }
        } catch (error) {
            console.error('Error loading customer options for check-in:', error);
        }
    }

    async loadFlightOptionsForCheckout() {
        try {
            const snapshot = await this.db.collection('reservations')
                .where('status', 'in', ['checked-in', 'checked-out', 'foc-checkedin', 'foc-checkedout'])
                .get();
            
            const flights = [...new Set(snapshot.docs.map(doc => doc.data().flightHotel))];
            const select = document.getElementById('checkoutFlightFilter');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Flights/Hotels</option>';
            flights.forEach(flight => {
                if (flight) {
                    const option = document.createElement('option');
                    option.value = flight;
                    option.textContent = flight;
                    select.appendChild(option);
                }
            });
            
            if (flights.includes(currentValue)) {
                select.value = currentValue;
            }
        } catch (error) {
            console.error('Error loading flight options for check-out:', error);
        }
    }

    async loadCustomerOptionsForCheckout() {
        try {
            const snapshot = await this.db.collection('reservations')
                .where('status', 'in', ['checked-in', 'checked-out', 'foc-checkedin', 'foc-checkedout'])
                .get();
            
            const customers = [...new Set(snapshot.docs.map(doc => doc.data().customer))];
            const select = document.getElementById('checkoutCustomerFilter');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Customers</option>';
            customers.forEach(customer => {
                if (customer) {
                    const option = document.createElement('option');
                    option.value = customer;
                    option.textContent = customer;
                    select.appendChild(option);
                }
            });
            
            if (customers.includes(currentValue)) {
                select.value = currentValue;
            }
        } catch (error) {
            console.error('Error loading customer options for check-out:', error);
        }
    }

    async loadCheckinData() {
        const dateInput = document.getElementById('checkinDateFilter');
        const flightSelect = document.getElementById('checkinFlightFilter');
        const customerSelect = document.getElementById('checkinCustomerFilter');
        const statusSelect = document.getElementById('checkinStatusFilter');
        const tableBody = document.getElementById('checkinTable');
        
        if (!tableBody) return;
        
        const date = dateInput ? dateInput.value : '';
        const flightFilter = flightSelect ? flightSelect.value : '';
        const customerFilter = customerSelect ? customerSelect.value : '';
        const statusFilter = statusSelect ? statusSelect.value : '';
        
        try {
            let query = this.db.collection('reservations');
            
            // Apply filters
            if (date) {
                query = query.where('reservationDate', '==', date);
            }
            
            if (statusFilter) {
                query = query.where('status', '==', statusFilter);
            } else {
                query = query.where('status', 'in', ['reserved', 'checked-in', 'foc-reserved', 'foc-checkedin']);
            }
            
            const snapshot = await query.get();
            tableBody.innerHTML = '';
            
            if (snapshot.empty) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            No reservations found
                        </td>
                    </tr>
                `;
                return;
            }
            
            let hasData = false;
            this.selectedCheckinIds.clear();
            
            snapshot.forEach(doc => {
                const data = doc.data();
                
                // Apply additional filters
                if (flightFilter && data.flightHotel !== flightFilter) return;
                if (customerFilter && data.customer !== customerFilter) return;
                
                hasData = true;
                
                let statusBadge;
                if (data.status === 'checked-in') {
                    statusBadge = '<span class="status-badge status-checkedin">Checked-In</span>';
                } else if (data.status === 'foc-checkedin') {
                    statusBadge = '<span class="status-badge status-foc">FOC Checked-In</span>';
                } else if (data.status === 'foc-reserved') {
                    statusBadge = '<span class="status-badge status-foc">FOC Reserved</span>';
                } else {
                    statusBadge = '<span class="status-badge status-reserved">Reserved</span>';
                }
                
                const checkinTime = data.checkinTime ? `<br><small>${data.checkinTime}</small>` : '';
                
                const isFoc = data.status.includes('foc');
                const isCheckinEnabled = data.status === 'reserved' || data.status === 'foc-reserved';
                
                const row = `
                    <tr>
                        <td>
                            ${isCheckinEnabled ? `
                            <input type="checkbox" class="checkin-checkbox" value="${doc.id}" 
                                   onchange="app.toggleCheckinSelection('${doc.id}', this.checked)">
                            ` : ''}
                        </td>
                        <td>${data.guestName}</td>
                        <td>${data.customer}</td>
                        <td>${data.flightHotel}</td>
                        <td>${data.eta}${checkinTime}</td>
                        <td>${data.direction}</td>
                        <td>${data.nationality}</td>
                        <td>${statusBadge} ${isFoc ? '<i class="fas fa-gift text-foc ms-1" title="FOC"></i>' : ''}</td>
                        <td>
                            <div class="action-buttons">
                                ${isCheckinEnabled ? `
                                <button class="btn btn-sm btn-success" onclick="app.checkinGuest('${doc.id}')">
                                    <i class="fas fa-sign-in-alt"></i>
                                </button>
                                ` : ''}
                                <button class="btn btn-sm btn-info" onclick="app.openEditModal('${doc.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-noshow" onclick="app.markNoShow('${doc.id}')">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="app.deleteReservation('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            
            if (!hasData) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            No guests match the selected filters
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Error loading check-in data:', error);
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-danger">
                        Error loading data. Please try again.
                    </td>
                </tr>
            `;
        }
    }

    toggleSelectAllCheckin(checkbox) {
        const checkboxes = document.querySelectorAll('.checkin-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
            this.toggleCheckinSelection(cb.value, cb.checked);
        });
    }

    toggleCheckinSelection(id, isChecked) {
        if (isChecked) {
            this.selectedCheckinIds.add(id);
        } else {
            this.selectedCheckinIds.delete(id);
        }
    }

    async bulkMarkNoShow() {
        if (this.selectedCheckinIds.size === 0) {
            alert('Please select at least one reservation to mark as No-Show');
            return;
        }

        if (!confirm(`Are you sure you want to mark ${this.selectedCheckinIds.size} reservation(s) as No-Show?`)) {
            return;
        }

        let successCount = 0;
        let errorCount = 0;

        for (const id of this.selectedCheckinIds) {
            try {
                const doc = await this.db.collection('reservations').doc(id).get();
                if (doc.exists) {
                    const data = doc.data();
                    const newStatus = data.isFOC ? 'foc-noshow' : 'noshow';
                    
                    await this.db.collection('reservations').doc(id).update({
                        status: newStatus,
                        noshowTime: new Date().toLocaleTimeString('en-US', { 
                            hour12: true, 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }),
                        noshowDate: new Date().toISOString().split('T')[0],
                        noshowBy: this.currentUser.username
                    });
                    successCount++;
                }
            } catch (error) {
                console.error(`Error marking reservation ${id} as No-Show:`, error);
                errorCount++;
            }
        }

        alert(`No-Show marked for ${successCount} reservation(s). ${errorCount > 0 ? `${errorCount} failed.` : ''}`);
        
        // Refresh data
        this.loadCheckinData();
        this.updateStats();
        this.loadOverviewData();
    }

    async markNoShow(reservationId) {
        if (!confirm('Are you sure you want to mark this reservation as No-Show?')) {
            return;
        }
        
        try {
            const doc = await this.db.collection('reservations').doc(reservationId).get();
            if (doc.exists) {
                const data = doc.data();
                const newStatus = data.isFOC ? 'foc-noshow' : 'noshow';
                
                await this.db.collection('reservations').doc(reservationId).update({
                    status: newStatus,
                    noshowTime: new Date().toLocaleTimeString('en-US', { 
                        hour12: true, 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }),
                    noshowDate: new Date().toISOString().split('T')[0],
                    noshowBy: this.currentUser.username
                });
                
                alert('Reservation marked as No-Show');
                
                // Refresh data
                this.loadCheckinData();
                this.updateStats();
                this.loadOverviewData();
            }
        } catch (error) {
            console.error('Error marking as No-Show:', error);
            alert('Error marking as No-Show. Please try again.');
        }
    }

    async checkinGuest(reservationId) {
        if (!confirm('Are you sure you want to check in this guest?')) {
            return;
        }
        
        const now = new Date();
        const checkinTime = now.toLocaleTimeString('en-US', { 
            hour12: true, 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        try {
            const doc = await this.db.collection('reservations').doc(reservationId).get();
            if (doc.exists) {
                const data = doc.data();
                const newStatus = data.isFOC ? 'foc-checkedin' : 'checked-in';
                
                await this.db.collection('reservations').doc(reservationId).update({
                    status: newStatus,
                    checkinTime: checkinTime,
                    checkinDateTime: now.toISOString(),
                    checkinBy: this.currentUser.username,
                    checkinDate: new Date().toISOString().split('T')[0]
                });
                
                alert('Guest checked in successfully!');
                
                // Refresh all data
                this.loadCheckinData();
                this.loadCheckoutData();
                this.loadFlightOptionsForCheckin();
                this.loadFlightOptionsForCheckout();
                this.loadCustomerOptionsForCheckin();
                this.loadCustomerOptionsForCheckout();
                this.updateStats();
                this.loadOverviewData();
            }
        } catch (error) {
            console.error('Error checking in guest:', error);
            alert('Error checking in guest. Please try again.');
        }
    }

    async loadCheckoutData() {
        const dateInput = document.getElementById('checkoutDateFilter');
        const flightSelect = document.getElementById('checkoutFlightFilter');
        const customerSelect = document.getElementById('checkoutCustomerFilter');
        const statusSelect = document.getElementById('checkoutStatusFilter');
        const tableBody = document.getElementById('checkoutTable');
        
        if (!tableBody) return;
        
        const date = dateInput ? dateInput.value : '';
        const flightFilter = flightSelect ? flightSelect.value : '';
        const customerFilter = customerSelect ? customerSelect.value : '';
        const statusFilter = statusSelect ? statusSelect.value : '';
        
        try {
            let query = this.db.collection('reservations');
            
            // Apply status filter
            if (statusFilter) {
                query = query.where('status', '==', statusFilter);
            } else {
                query = query.where('status', 'in', ['checked-in', 'checked-out', 'foc-checkedin', 'foc-checkedout']);
            }
            
            const snapshot = await query.get();
            tableBody.innerHTML = '';
            
            if (snapshot.empty) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            No checked-in/out guests available
                        </td>
                    </tr>
                `;
                return;
            }
            
            let hasData = false;
            
            snapshot.forEach(doc => {
                const data = doc.data();
                
                // Apply additional filters
                if (date && data.checkinDate !== date) return;
                if (flightFilter && data.flightHotel !== flightFilter) return;
                if (customerFilter && data.customer !== customerFilter) return;
                
                hasData = true;
                
                let statusBadge;
                if (data.status === 'checked-out') {
                    statusBadge = '<span class="status-badge status-checkedout">Checked-Out</span>';
                } else if (data.status === 'foc-checkedout') {
                    statusBadge = '<span class="status-badge status-foc">FOC Checked-Out</span>';
                } else if (data.status === 'foc-checkedin') {
                    statusBadge = '<span class="status-badge status-foc">FOC Checked-In</span>';
                } else {
                    statusBadge = '<span class="status-badge status-checkedin">Checked-In</span>';
                }
                
                const checkoutTime = data.checkoutTime ? `<br><small>${data.checkoutTime}</small>` : '';
                
                const isFoc = data.status.includes('foc');
                const isCheckoutEnabled = data.status === 'checked-in' || data.status === 'foc-checkedin';
                
                const row = `
                    <tr>
                        <td>${data.guestName}</td>
                        <td>${data.customer}</td>
                        <td>${data.flightHotel}</td>
                        <td>${data.eta}${checkoutTime}</td>
                        <td>${data.direction}</td>
                        <td>${data.checkinTime || 'N/A'}</td>
                        <td>${statusBadge} ${isFoc ? '<i class="fas fa-gift text-foc ms-1" title="FOC"></i>' : ''}</td>
                        <td>
                            <div class="action-buttons">
                                ${isCheckoutEnabled ? `
                                <button class="btn btn-sm btn-warning" onclick="app.checkoutGuest('${doc.id}')">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                                ` : ''}
                                <button class="btn btn-sm btn-info" onclick="app.openEditModal('${doc.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="app.deleteReservation('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            
            if (!hasData) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            No guests match the selected filters
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Error loading check-out data:', error);
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        Error loading data. Please try again.
                    </td>
                </tr>
            `;
        }
    }

    async checkoutGuest(reservationId) {
        if (!confirm('Are you sure you want to check out this guest?')) {
            return;
        }
        
        const now = new Date();
        const checkoutTime = now.toLocaleTimeString('en-US', { 
            hour12: true, 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        try {
            const doc = await this.db.collection('reservations').doc(reservationId).get();
            if (doc.exists) {
                const data = doc.data();
                const newStatus = data.isFOC ? 'foc-checkedout' : 'checked-out';
                
                await this.db.collection('reservations').doc(reservationId).update({
                    status: newStatus,
                    checkoutTime: checkoutTime,
                    checkoutDateTime: now.toISOString(),
                    checkoutBy: this.currentUser.username,
                    checkoutDate: new Date().toISOString().split('T')[0]
                });
                
                alert('Guest checked out successfully!');
                
                // Refresh all data
                this.loadCheckoutData();
                this.loadReportOptions();
                this.loadFlightOptionsForCheckout();
                this.loadCustomerOptionsForCheckout();
                this.updateStats();
                this.loadOverviewData();
            }
        } catch (error) {
            console.error('Error checking out guest:', error);
            alert('Error checking out guest. Please try again.');
        }
    }

    async loadReportOptions() {
        try {
            const snapshot = await this.db.collection('reservations').get();
            
            const flights = [...new Set(snapshot.docs.map(doc => doc.data().flightHotel))];
            const customers = [...new Set(snapshot.docs.map(doc => doc.data().customer))];
            
            // Flight filter
            const flightSelect = document.getElementById('reportFlightFilter');
            if (flightSelect) {
                const currentValue = flightSelect.value;
                flightSelect.innerHTML = '<option value="">All Flights/Hotels</option>';
                flights.forEach(flight => {
                    if (flight) {
                        const option = document.createElement('option');
                        option.value = flight;
                        option.textContent = flight;
                        flightSelect.appendChild(option);
                    }
                });
                if (flights.includes(currentValue)) {
                    flightSelect.value = currentValue;
                }
            }
            
            // Customer filter
            const customerSelect = document.getElementById('reportCustomerFilter');
            if (customerSelect) {
                const currentValue = customerSelect.value;
                customerSelect.innerHTML = '<option value="">All Customers</option>';
                customers.forEach(customer => {
                    if (customer) {
                        const option = document.createElement('option');
                        option.value = customer;
                        option.textContent = customer;
                        customerSelect.appendChild(option);
                    }
                });
                if (customers.includes(currentValue)) {
                    customerSelect.value = currentValue;
                }
            }
        } catch (error) {
            console.error('Error loading report options:', error);
        }
    }

    clearCheckinFilters() {
        document.getElementById('checkinDateFilter').value = '';
        document.getElementById('checkinFlightFilter').value = '';
        document.getElementById('checkinCustomerFilter').value = '';
        document.getElementById('checkinStatusFilter').value = 'reserved';
        this.loadCheckinData();
    }

    clearCheckoutFilters() {
        document.getElementById('checkoutDateFilter').value = '';
        document.getElementById('checkoutFlightFilter').value = '';
        document.getElementById('checkoutCustomerFilter').value = '';
        document.getElementById('checkoutStatusFilter').value = 'checked-in';
        this.loadCheckoutData();
    }

    clearReportFilters() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('reportFromDate').value = today;
        document.getElementById('reportToDate').value = today;
        document.getElementById('reportFlightFilter').value = '';
        document.getElementById('reportCustomerFilter').value = '';
    }

    async generateReport() {
        const fromDateInput = document.getElementById('reportFromDate');
        const toDateInput = document.getElementById('reportToDate');
        const flightSelect = document.getElementById('reportFlightFilter');
        const customerSelect = document.getElementById('reportCustomerFilter');
        
        if (!fromDateInput || !toDateInput) return;
        
        const fromDate = fromDateInput.value;
        const toDate = toDateInput.value;
        const flightFilter = flightSelect ? flightSelect.value : '';
        const customerFilter = customerSelect ? customerSelect.value : '';
        
        if (fromDate && toDate && fromDate > toDate) {
            alert('From date cannot be after To date');
            return;
        }
        
        try {
            const snapshot = await this.db.collection('reservations').get();
            const reservations = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                
                // Apply date filter
                if (fromDate && toDate) {
                    const checkDate = data.checkoutDate || data.checkinDate || data.reservationDate;
                    if (!checkDate) return;
                    
                    if (checkDate < fromDate || checkDate > toDate) {
                        return;
                    }
                }
                
                // Apply flight filter
                if (flightFilter && data.flightHotel !== flightFilter) return;
                
                // Apply customer filter
                if (customerFilter && data.customer !== customerFilter) return;
                
                reservations.push({ id, ...data });
            });
            
            if (reservations.length === 0) {
                alert('No reservations found for the selected criteria.');
                return;
            }
            
            this.displayReport(reservations, fromDate, toDate);
        } catch (error) {
            console.error('Error generating report:', error);
            alert('Error generating report. Please try again.');
        }
    }

    async generateFOCReport() {
        const fromDateInput = document.getElementById('reportFromDate');
        const toDateInput = document.getElementById('reportToDate');
        const flightSelect = document.getElementById('reportFlightFilter');
        const customerSelect = document.getElementById('reportCustomerFilter');
        
        if (!fromDateInput || !toDateInput) return;
        
        const fromDate = fromDateInput.value;
        const toDate = toDateInput.value;
        const flightFilter = flightSelect ? flightSelect.value : '';
        const customerFilter = customerSelect ? customerSelect.value : '';
        
        if (fromDate && toDate && fromDate > toDate) {
            alert('From date cannot be after To date');
            return;
        }
        
        try {
            const snapshot = await this.db.collection('reservations').get();
            const reservations = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                
                // Only FOC guests
                if (!data.isFOC) return;
                
                // Apply date filter
                if (fromDate && toDate) {
                    const checkDate = data.checkoutDate || data.checkinDate || data.reservationDate;
                    if (!checkDate) return;
                    
                    if (checkDate < fromDate || checkDate > toDate) {
                        return;
                    }
                }
                
                // Apply flight filter
                if (flightFilter && data.flightHotel !== flightFilter) return;
                
                // Apply customer filter
                if (customerFilter && data.customer !== customerFilter) return;
                
                reservations.push({ id, ...data });
            });
            
            if (reservations.length === 0) {
                alert('No FOC reservations found for the selected criteria.');
                return;
            }
            
            this.displayReport(reservations, fromDate, toDate, true);
        } catch (error) {
            console.error('Error generating FOC report:', error);
            alert('Error generating FOC report. Please try again.');
        }
    }

    async generateNoShowReport() {
        const fromDateInput = document.getElementById('reportFromDate');
        const toDateInput = document.getElementById('reportToDate');
        const flightSelect = document.getElementById('reportFlightFilter');
        const customerSelect = document.getElementById('reportCustomerFilter');
        
        if (!fromDateInput || !toDateInput) return;
        
        const fromDate = fromDateInput.value;
        const toDate = toDateInput.value;
        const flightFilter = flightSelect ? flightSelect.value : '';
        const customerFilter = customerSelect ? customerSelect.value : '';
        
        if (fromDate && toDate && fromDate > toDate) {
            alert('From date cannot be after To date');
            return;
        }
        
        try {
            const snapshot = await this.db.collection('reservations').get();
            const reservations = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                
                // Only No-Show guests
                if (!['noshow', 'foc-noshow'].includes(data.status)) return;
                
                // Apply date filter
                if (fromDate && toDate) {
                    const checkDate = data.noshowDate || data.reservationDate;
                    if (!checkDate) return;
                    
                    if (checkDate < fromDate || checkDate > toDate) {
                        return;
                    }
                }
                
                // Apply flight filter
                if (flightFilter && data.flightHotel !== flightFilter) return;
                
                // Apply customer filter
                if (customerFilter && data.customer !== customerFilter) return;
                
                reservations.push({ id, ...data });
            });
            
            if (reservations.length === 0) {
                alert('No No-Show reservations found for the selected criteria.');
                return;
            }
            
            this.displayReport(reservations, fromDate, toDate, false, true);
        } catch (error) {
            console.error('Error generating No-Show report:', error);
            alert('Error generating No-Show report. Please try again.');
        }
    }

    displayReport(reservations, fromDate, toDate, isFOCReport = false, isNoShowReport = false) {
        const printWindow = window.open('', '_blank');
        
        const currentDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // Group by customer
        const reservationsByCustomer = {};
        reservations.forEach(res => {
            if (!reservationsByCustomer[res.customer]) {
                reservationsByCustomer[res.customer] = [];
            }
            reservationsByCustomer[res.customer].push(res);
        });
        
        // Calculate statistics
        let totalFOC = 0;
        let totalRegular = 0;
        let totalCheckedIn = 0;
        let totalCheckedOut = 0;
        let totalNoShow = 0;
        let totalReserved = 0;
        
        reservations.forEach(res => {
            if (res.isFOC) totalFOC++;
            else totalRegular++;
            
            if (res.status.includes('checked-in')) totalCheckedIn++;
            if (res.status.includes('checked-out')) totalCheckedOut++;
            if (res.status.includes('noshow')) totalNoShow++;
            if (res.status.includes('reserved')) totalReserved++;
        });
        
        let reportHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Guest Report - Vilu Lounge</title>
                <style>
                    @media print {
                        @page {
                            size: A4 landscape;
                            margin: 10mm;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10px;
                            line-height: 1.2;
                            color: #000;
                            margin: 0;
                            padding: 0;
                        }
                        .report-container {
                            width: 100%;
                        }
                        .header {
                            margin-bottom: 10px;
                            padding-bottom: 10px;
                            border-bottom: 2px solid #000;
                        }
                        .company-info {
                            text-align: left;
                            margin-bottom: 10px;
                        }
                        .company-name {
                            font-size: 18px;
                            font-weight: bold;
                            margin: 0 0 3px 0;
                            color: #000;
                        }
                        .company-address {
                            font-size: 9px;
                            margin: 0 0 1px 0;
                            line-height: 1.1;
                        }
                        .report-title {
                            text-align: center;
                            font-size: 14px;
                            font-weight: bold;
                            margin: 10px 0;
                            text-transform: uppercase;
                        }
                        .report-details {
                            margin: 10px 0;
                            padding: 5px;
                            background: #f5f5f5;
                            border: 1px solid #ddd;
                        }
                        .detail-row {
                            display: flex;
                            margin-bottom: 3px;
                        }
                        .detail-label {
                            font-weight: bold;
                            width: 120px;
                        }
                        .detail-value {
                            flex: 1;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 5px 0;
                            page-break-inside: avoid;
                            font-size: 9px;
                        }
                        th {
                            background-color: #f0f0f0;
                            color: #000;
                            padding: 4px 3px;
                            text-align: left;
                            border: 1px solid #000;
                            font-weight: bold;
                            white-space: nowrap;
                        }
                        td {
                            padding: 3px 3px;
                            border: 1px solid #000;
                            vertical-align: top;
                        }
                        .customer-section {
                            margin-bottom: 15px;
                            page-break-inside: avoid;
                        }
                        .customer-name {
                            background-color: #e0e0e0;
                            padding: 4px 8px;
                            font-weight: bold;
                            margin-bottom: 5px;
                            font-size: 10px;
                            border-left: 3px solid #000;
                        }
                        .footer {
                            margin-top: 20px;
                            page-break-before: avoid;
                            padding-top: 10px;
                            border-top: 1px solid #000;
                        }
                        .signature-section {
                            width: 45%;
                            display: inline-block;
                            vertical-align: top;
                            margin-bottom: 20px;
                        }
                        .signature-line {
                            margin-top: 25px;
                            border-top: 1px solid #000;
                            width: 150px;
                            padding-top: 3px;
                            font-size: 9px;
                        }
                        .no-print {
                            display: none !important;
                        }
                        .print-only {
                            display: block !important;
                        }
                        thead { 
                            display: table-header-group; 
                        }
                        tfoot { 
                            display: table-footer-group; 
                        }
                        tr { 
                            page-break-inside: avoid; 
                        }
                    }
                    @media screen {
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 12px;
                            padding: 20px;
                            background: #f5f5f5;
                        }
                        .report-container {
                            max-width: 297mm;
                            margin: 0 auto;
                            background: white;
                            padding: 20px;
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        }
                        .header {
                            margin-bottom: 20px;
                            padding-bottom: 15px;
                            border-bottom: 2px solid #000;
                        }
                        .company-info {
                            text-align: left;
                            font-size: 12px;
                            line-height: 1.3;
                            margin-bottom: 15px;
                        }
                        .company-name {
                            font-size: 22px;
                            font-weight: bold;
                            margin: 0 0 5px 0;
                            color: #2c5282;
                        }
                        .company-address {
                            font-size: 10px;
                            margin: 0 0 2px 0;
                            line-height: 1.2;
                        }
                        .report-title {
                            text-align: center;
                            font-size: 18px;
                            font-weight: bold;
                            margin: 15px 0;
                            text-transform: uppercase;
                            color: #2c5282;
                        }
                        .report-details {
                            margin: 15px 0;
                            padding: 10px;
                            background: #f8f9fa;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                        }
                        .detail-row {
                            display: flex;
                            margin-bottom: 5px;
                        }
                        .detail-label {
                            font-weight: bold;
                            width: 150px;
                        }
                        .detail-value {
                            flex: 1;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 10px 0;
                            font-size: 11px;
                        }
                        th {
                            background-color: #f8f9fa;
                            color: #000;
                            padding: 6px 8px;
                            text-align: left;
                            border: 1px solid #000;
                            font-weight: bold;
                            white-space: nowrap;
                        }
                        td {
                            padding: 5px 8px;
                            border: 1px solid #000;
                            vertical-align: top;
                        }
                        .customer-section {
                            margin-bottom: 20px;
                        }
                        .customer-name {
                            background-color: #e9ecef;
                            padding: 8px 12px;
                            font-weight: bold;
                            margin-bottom: 10px;
                            font-size: 12px;
                            border-left: 4px solid #3498db;
                            border-radius: 4px 0 0 4px;
                        }
                        .footer {
                            margin-top: 30px;
                            padding-top: 20px;
                            border-top: 2px solid #000;
                        }
                        .signature-section {
                            width: 45%;
                            display: inline-block;
                            vertical-align: top;
                            margin-bottom: 30px;
                        }
                        .signature-line {
                            margin-top: 30px;
                            border-top: 1px solid #000;
                            width: 200px;
                            padding-top: 5px;
                        }
                        .print-buttons {
                            text-align: center;
                            margin-top: 20px;
                            padding: 20px;
                            background: #f8f9fa;
                            border-radius: 5px;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="report-container">
                    <!-- Header -->
                    <div class="header">
                        <div class="logo-address-section">
                            <img src="macl.png" alt="MACL Logo" class="company-logo">
                            <div class="company-info">
                                <div class="company-name">Vilu Business Lounge</div>
                                <div class="company-address">Seaplane Terminal</div>
                                <div class="company-address">Velana International Airport</div>
                                <div class="company-address">Hulhule: 22000</div>
                                <div class="company-address">Republic of Maldives</div>
                                <div class="company-address">T: 3337117 / 3331773 | M: 7288007</div>
                                <div class="company-address">W: www.macl.aero / E: vilu.lounge@macl.aero</div>
                            </div>
                        </div>
                        
                        <div class="report-title">
                            ${isFOCReport ? 'FOC GUEST REPORT' : isNoShowReport ? 'NO-SHOW GUEST REPORT' : 'GUEST REPORT'}
                        </div>
                        
                        <div class="report-details">
                            <div class="detail-row">
                                <div class="detail-label">Date:</div>
                                <div class="detail-value">${currentDate}</div>
                            </div>
                            ${fromDate && toDate ? `
                            <div class="detail-row">
                                <div class="detail-label">Period:</div>
                                <div class="detail-value">${fromDate} to ${toDate}</div>
                            </div>
                            ` : ''}
                            <div class="detail-row">
                                <div class="detail-label">Total Records:</div>
                                <div class="detail-value">${reservations.length}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Total FOC:</div>
                                <div class="detail-value">${totalFOC}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Total Regular:</div>
                                <div class="detail-value">${totalRegular}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Report Content -->
        `;
        
        Object.entries(reservationsByCustomer).forEach(([customer, customerReservations]) => {
            reportHTML += `
                <div class="customer-section">
                    <div class="customer-name">Customer: ${customer} (${customerReservations.length} records)</div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Guest Name</th>
                                <th>Flight/Hotel</th>
                                <th>Direction</th>
                                <th>Nationality</th>
                                <th>Reservation Date</th>
                                <th>ETA</th>
                                <th>Check-In</th>
                                <th>Check-Out</th>
                                <th>Status</th>
                                <th>Guest Type</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            customerReservations.forEach(res => {
                reportHTML += `
                    <tr>
                        <td>${res.guestName}</td>
                        <td>${res.flightHotel}</td>
                        <td>${res.direction}</td>
                        <td>${res.nationality}</td>
                        <td>${res.reservationDate}</td>
                        <td>${res.eta}</td>
                        <td>${res.checkinTime || '-'}</td>
                        <td>${res.checkoutTime || '-'}</td>
                        <td>${res.status}</td>
                        <td>${res.isFOC ? 'FOC' : 'Regular'}</td>
                    </tr>
                `;
            });
            
            reportHTML += `
                        </tbody>
                    </table>
                </div>
            `;
        });
        
        reportHTML += `
                    <!-- Footer Signatures -->
                    <div class="footer">
                        <div class="signature-section">
                            <div class="detail-row">
                                <div class="detail-label">Prepared by:</div>
                                <div class="detail-value">${this.currentUser.name}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">RC No:</div>
                                <div class="detail-value">${this.currentUser.RCNo}</div>
                            </div>
                            <div class="signature-line">Signature</div>
                        </div>
                        
                        <div class="signature-section" style="float: right;">
                            <div class="detail-row">
                                <div class="detail-label">Checked by:</div>
                                <div class="detail-value">_____________________</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">RC No:</div>
                                <div class="detail-value">_____________________</div>
                            </div>
                            <div class="signature-line">Signature</div>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    
                    <!-- Print Buttons (only for screen) -->
                    <div class="print-buttons no-print">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                            Print Report
                        </button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Close Window
                        </button>
                    </div>
                </div>
            </body>
            </html>
        `;
        
        printWindow.document.write(reportHTML);
        printWindow.document.close();
        printWindow.focus();
    }

    async loadOverviewData() {
        try {
            const today = new Date().toISOString().split('T')[0];
            
            // Get all reservations for today
            const snapshot = await this.db.collection('reservations')
                .where('reservationDate', '==', today)
                .get();
            
            let reservedList = [];
            let checkedinList = [];
            let checkedoutList = [];
            let focList = [];
            let noshowList = [];
            
            let overviewReserved = 0;
            let overviewCheckedIn = 0;
            let overviewCheckedOut = 0;
            let overviewFOC = 0;
            let overviewNoShow = 0;
            let overviewCancelled = 0;
            let overviewTotalToday = 0;
            let overviewActiveNow = 0;
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                
                overviewTotalToday++;
                
                // Check if it's FOC
                if (data.isFOC) {
                    overviewFOC++;
                    // FOC guests go to their respective lists based on status
                    if (data.status.includes('reserved')) {
                        reservedList.push({ id, ...data });
                    } else if (data.status.includes('checked-in')) {
                        overviewCheckedIn++;
                        overviewActiveNow++;
                        checkedinList.push({ id, ...data });
                    } else if (data.status.includes('checked-out')) {
                        overviewCheckedOut++;
                        checkedoutList.push({ id, ...data });
                    } else if (data.status.includes('noshow')) {
                        overviewNoShow++;
                        noshowList.push({ id, ...data });
                    }
                } else {
                    // Regular guests
                    if (data.status.includes('reserved')) {
                        overviewReserved++;
                        reservedList.push({ id, ...data });
                    } else if (data.status.includes('checked-in')) {
                        overviewCheckedIn++;
                        overviewActiveNow++;
                        checkedinList.push({ id, ...data });
                    } else if (data.status.includes('checked-out')) {
                        overviewCheckedOut++;
                        checkedoutList.push({ id, ...data });
                    } else if (data.status.includes('noshow')) {
                        overviewNoShow++;
                        noshowList.push({ id, ...data });
                    } else if (data.status === 'cancelled') {
                        overviewCancelled++;
                    }
                }
            });
            
            console.log('Overview data loaded:', {
                reserved: overviewReserved,
                checkedIn: overviewCheckedIn,
                checkedOut: overviewCheckedOut,
                foc: overviewFOC,
                noShow: overviewNoShow,
                activeNow: overviewActiveNow
            });
            
            // Update overview counts
            document.getElementById('overviewReserved').textContent = overviewReserved;
            document.getElementById('overviewCheckedIn').textContent = overviewCheckedIn;
            document.getElementById('overviewCheckedOut').textContent = overviewCheckedOut;
            document.getElementById('overviewFOC').textContent = overviewFOC;
            document.getElementById('overviewNoShow').textContent = overviewNoShow;
            document.getElementById('overviewCancelled').textContent = overviewCancelled;
            document.getElementById('overviewTotalToday').textContent = overviewTotalToday;
            document.getElementById('overviewActiveNow').textContent = overviewActiveNow;
            
            // Display lists with sorting (most recent first)
            this.displayOverviewList('overviewReservedList', reservedList, 'reserved');
            this.displayOverviewList('overviewCheckedInList', checkedinList, 'checkedin');
            this.displayOverviewList('overviewCheckedOutList', checkedoutList, 'checkedout');
            this.displayOverviewList('overviewFOCList', focList, 'foc');
            this.displayOverviewList('overviewNoShowList', noshowList, 'noshow');
            
        } catch (error) {
            console.error('Error loading overview data:', error);
        }
    }

    displayOverviewList(elementId, list, type) {
        const element = document.getElementById(elementId);
        const countElement = document.getElementById(`${type}Count`);
        
        if (!element) return;
        
        // Update count badge
        if (countElement) {
            countElement.textContent = `${list.length} ${list.length === 1 ? 'guest' : 'guests'}`;
        }
        
        if (list.length === 0) {
            element.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted py-4">
                        No ${type.replace(/([A-Z])/g, ' $1').toLowerCase()} passengers
                    </td>
                </tr>
            `;
            return;
        }
        
        // Sort list based on type
        list.sort((a, b) => {
            if (type === 'checkedin' || type === 'checkedout') {
                // Sort by check-in/check-out time (newest first)
                const timeA = type === 'checkedin' ? a.checkinTime : a.checkoutTime;
                const timeB = type === 'checkedin' ? b.checkinTime : b.checkoutTime;
                return new Date(`1970-01-01T${timeB}`) - new Date(`1970-01-01T${timeA}`);
            } else if (type === 'reserved' || type === 'noshow') {
                // Sort by ETA
                return new Date(`1970-01-01T${b.eta}`) - new Date(`1970-01-01T${a.eta}`);
            }
            return 0;
        });
        
        let html = '';
        
        // Limit to 15 entries for each list
        const displayList = list.slice(0, 15);
        
        for (let i = 0; i < displayList.length; i++) {
            const item = displayList[i];
            
            let timeInfo = '';
            let flightInfo = item.flightHotel || '';
            
            if (type === 'reserved') {
                timeInfo = item.eta || 'N/A';
            } else if (type === 'checkedin') {
                timeInfo = item.checkinTime || 'N/A';
            } else if (type === 'checkedout') {
                timeInfo = item.checkoutTime || 'N/A';
            } else if (type === 'foc') {
                if (item.status.includes('checked-in')) {
                    timeInfo = item.checkinTime || 'Checked-In';
                } else if (item.status.includes('checked-out')) {
                    timeInfo = item.checkoutTime || 'Checked-Out';
                } else if (item.status.includes('reserved')) {
                    timeInfo = item.eta || 'Reserved';
                } else if (item.status.includes('noshow')) {
                    timeInfo = 'No-Show';
                } else {
                    timeInfo = item.status || 'FOC';
                }
            } else if (type === 'noshow') {
                timeInfo = item.eta || 'N/A';
            }
            
            // Truncate long names/flights for display
            const guestName = item.guestName.length > 15 ? 
                item.guestName.substring(0, 15) + '...' : item.guestName;
            
            const flightDisplay = flightInfo.length > 12 ? 
                flightInfo.substring(0, 12) + '...' : flightInfo;
            
            html += `
                <tr onclick="app.showReservationDetails('${item.id}')" style="cursor: pointer;" title="Click to view details">
                    <td><strong>${guestName}</strong></td>
                    <td>${flightDisplay}</td>
                    <td>${timeInfo}</td>
                </tr>
            `;
        }
        
        // Add "View All" link if there are more items
        if (list.length > 15) {
            html += `
                <tr>
                    <td colspan="3" class="text-center">
                        <small class="text-primary" style="cursor: pointer;" onclick="app.showAllGuests('${type}')">
                            View all ${list.length} guests...
                        </small>
                    </td>
                </tr>
            `;
        }
        
        element.innerHTML = html;
    }

    async showAllGuests(type) {
        try {
            const today = new Date().toISOString().split('T')[0];
            const snapshot = await this.db.collection('reservations')
                .where('reservationDate', '==', today)
                .get();
            
            let guests = [];
            let title = '';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                
                let shouldInclude = false;
                
                switch(type) {
                    case 'reserved':
                        shouldInclude = data.status.includes('reserved') && !data.isFOC;
                        title = 'Reserved Guests';
                        break;
                    case 'checkedin':
                        shouldInclude = data.status.includes('checked-in');
                        title = 'Checked-In Guests';
                        break;
                    case 'checkedout':
                        shouldInclude = data.status.includes('checked-out');
                        title = 'Checked-Out Guests';
                        break;
                    case 'foc':
                        shouldInclude = data.isFOC;
                        title = 'FOC Guests';
                        break;
                    case 'noshow':
                        shouldInclude = data.status.includes('noshow');
                        title = 'No-Show Guests';
                        break;
                }
                
                if (shouldInclude) {
                    guests.push({ id, ...data });
                }
            });
            
            this.displayAllGuestsModal(guests, title);
            
        } catch (error) {
            console.error('Error loading all guests:', error);
        }
    }

    displayAllGuestsModal(guests, title) {
        let modalHtml = `
            <div class="modal fade" id="allGuestsModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title} (${guests.length})</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Guest Name</th>
                                            <th>Customer</th>
                                            <th>Flight/Hotel</th>
                                            <th>ETA</th>
                                            <th>Check-In Time</th>
                                            <th>Check-Out Time</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        guests.forEach(guest => {
            modalHtml += `
                <tr onclick="app.showReservationDetails('${guest.id}')" style="cursor: pointer;">
                    <td>${guest.guestName}</td>
                    <td>${guest.customer}</td>
                    <td>${guest.flightHotel}</td>
                    <td>${guest.eta}</td>
                    <td>${guest.checkinTime || '-'}</td>
                    <td>${guest.checkoutTime || '-'}</td>
                    <td>
                        <span class="badge ${guest.status.includes('reserved') ? 'bg-warning' : 
                          guest.status.includes('checked-in') ? 'bg-success' : 
                          guest.status.includes('checked-out') ? 'bg-info' : 
                          guest.status.includes('foc') ? 'bg-foc' : 
                          guest.status.includes('noshow') ? 'bg-secondary' : 'bg-danger'}">
                            ${guest.status}
                        </span>
                    </td>
                </tr>
            `;
        });
        
        modalHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('allGuestsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('allGuestsModal'));
        modal.show();
    }

    async showReservationDetails(reservationId) {
        try {
            const doc = await this.db.collection('reservations').doc(reservationId).get();
            if (!doc.exists) {
                alert('Reservation not found!');
                return;
            }
            
            const reservation = doc.data();
            
            // Create modal for details
            const modalHtml = `
                <div class="modal fade" id="reservationDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Reservation Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Guest Name:</strong></label>
                                            <p>${reservation.guestName}</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Customer:</strong></label>
                                            <p>${reservation.customer}</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Flight/Hotel:</strong></label>
                                            <p>${reservation.flightHotel}</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label"><strong>ETA:</strong></label>
                                            <p>${reservation.eta}</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Direction:</strong></label>
                                            <p>${reservation.direction}</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Nationality:</strong></label>
                                            <p>${reservation.nationality}</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Reservation Date:</strong></label>
                                            <p>${reservation.reservationDate}</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label"><strong>Status:</strong></label>
                                            <span class="badge bg-${reservation.status.includes('foc') ? 'foc' : 
                                                reservation.status === 'reserved' ? 'warning' : 
                                                reservation.status === 'checked-in' ? 'success' : 
                                                reservation.status === 'checked-out' ? 'info' : 
                                                reservation.status === 'noshow' ? 'secondary' : 'danger'}">${reservation.status}</span>
                                            ${reservation.isFOC ? '<span class="badge bg-foc ms-2">FOC</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <label class="form-label"><strong>Created:</strong></label>
                                    <p>${new Date(reservation.createdAt).toLocaleString()}</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-danger" onclick="app.deleteReservation('${reservationId}')">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('reservationDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('reservationDetailsModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error loading reservation details:', error);
            alert('Error loading reservation details.');
        }
    }

    async deleteReservation(reservationId) {
        if (!confirm('Are you sure you want to delete this reservation? This action cannot be undone.')) {
            return;
        }
        
        try {
            await this.db.collection('reservations').doc(reservationId).delete();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('reservationDetailsModal'));
            if (modal) {
                modal.hide();
            }
            
            alert('Reservation deleted successfully!');
            
            // Refresh other data
            this.loadCheckinData();
            this.loadCheckoutData();
            this.updateStats();
            this.loadOverviewData();
            
        } catch (error) {
            console.error('Error deleting reservation:', error);
            alert('Error deleting reservation. Please try again.');
        }
    }

    async updateStats() {
        try {
            const today = new Date().toISOString().split('T')[0];
            
            // Get all reservations for today
            const snapshot = await this.db.collection('reservations')
                .where('reservationDate', '==', today)
                .get();
            
            let reserved = 0;
            let checkedin = 0;
            let checkedout = 0;
            let foc = 0;
            let noshow = 0;
            let cancelled = 0;
            
            snapshot.forEach(doc => {
                const data = doc.data();
                
                if (data.status.includes('reserved') && !data.status.includes('foc')) reserved++;
                if (data.status.includes('checked-in') && !data.status.includes('foc')) checkedin++;
                if (data.status.includes('checked-out') && !data.status.includes('foc')) checkedout++;
                if (data.isFOC) foc++;
                if (data.status.includes('noshow')) noshow++;
                if (data.status === 'cancelled') cancelled++;
            });
            
            // Update stats display
            document.getElementById('statReservations').textContent = reserved;
            document.getElementById('statCheckins').textContent = checkedin;
            document.getElementById('statCheckouts').textContent = checkedout;
            document.getElementById('statFOC').textContent = foc;
            document.getElementById('statNoshow').textContent = noshow;
            document.getElementById('statCancelled').textContent = cancelled;
            
            // Show quick stats section
            document.getElementById('quickStats').classList.remove('d-none');
            
        } catch (error) {
            console.error('Error updating stats:', error);
        }
    }

    // Excel Upload Functions - VILU COMPATIBLE VERSION
    handleExcelUpload(event) {
        const file = event.target.files[0];
        if (file) {
            this.readExcelFile(file);
        }
    }

    readExcelFile(file) {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first worksheet
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                
                if (jsonData.length === 0) {
                    alert('Excel file is empty or has no valid data.');
                    return;
                }
                
                console.log('Excel data loaded (raw):', jsonData);
                
                // Process VILU format specifically
                const processedData = this.processViluExcelFormat(jsonData);
                this.excelData = processedData;
                this.displayExcelPreview(processedData);
            } catch (error) {
                console.error('Error reading Excel file:', error);
                alert('Error reading Excel file. Please make sure it\'s a valid Excel file.');
            }
        };
        
        reader.onerror = () => {
            alert('Error reading file. Please try again.');
        };
        
        reader.readAsArrayBuffer(file);
    }

    // IMPROVED TIME PARSING FUNCTION
    parseTime(timeValue) {
        if (!timeValue && timeValue !== 0) return '00:00';
        
        // Convert to string and trim
        let timeStr = timeValue.toString().trim();
        
        // Handle Excel numeric time (fraction of day)
        if (!isNaN(timeValue) && timeValue < 1) {
            // Excel stores times as fractions (0.5 = 12:00)
            const totalSeconds = timeValue * 24 * 60 * 60;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        // Remove "Hrs" or "hrs" from time string
        timeStr = timeStr.replace(/hrs?/gi, '').trim();
        
        // Handle numeric values like 1130, 930, 1430
        if (!isNaN(timeStr) && timeStr.length >= 3 && timeStr.length <= 4) {
            const num = parseInt(timeStr);
            let hours, minutes;
            
            if (timeStr.length === 3) {
                hours = Math.floor(num / 100);
                minutes = num % 100;
            } else {
                hours = Math.floor(num / 100);
                minutes = num % 100;
            }
            
            // Ensure valid hours and minutes
            if (hours >= 0 && hours <= 24 && minutes >= 0 && minutes <= 59) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
        }
        
        // Handle various string formats
        // Remove spaces and convert to uppercase
        timeStr = timeStr.replace(/\s+/g, '').toUpperCase();
        
        // Try to match patterns like:
        // 11:30, 11:30AM, 11:30 PM, 1130, 1130AM, 11.30, 11.30AM
        const patterns = [
            /^(\d{1,2})[:.](\d{2})\s*(AM|PM)?$/i,      // 11:30, 11:30AM, 11.30
            /^(\d{3,4})\s*(AM|PM)?$/i,                 // 1130, 1130AM
            /^(\d{1,2})\s*(AM|PM)?$/i                  // 11, 11AM
        ];
        
        for (const pattern of patterns) {
            const match = timeStr.match(pattern);
            if (match) {
                let hours = parseInt(match[1]);
                let minutes = match[2] ? parseInt(match[2]) : 0;
                const period = match[3] ? match[3].toUpperCase() : '';
                
                // Handle 12-hour format
                if (period === 'PM' && hours < 12) hours += 12;
                if (period === 'AM' && hours === 12) hours = 0;
                
                // Handle 24-hour format for times like 1330
                if (!period && hours < 24 && match[1].length >= 3) {
                    if (match[1].length === 3) {
                        hours = Math.floor(hours / 10);
                        minutes = hours % 10 * 10 + minutes;
                    } else if (match[1].length === 4) {
                        minutes = hours % 100;
                        hours = Math.floor(hours / 100);
                    }
                }
                
                // Validate hours and minutes
                if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                }
            }
        }
        
        // Try to parse as Date object
        const date = new Date(timeValue);
        if (!isNaN(date.getTime())) {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        console.warn('Could not parse time:', timeValue);
        return '00:00';
    }

    // IMPROVED DATE PARSING FUNCTION
    parseDate(dateValue) {
        if (!dateValue) return new Date().toISOString().split('T')[0];
        
        // Convert to string
        let dateStr = dateValue.toString().trim();
        
        // Handle Excel serial date (number)
        if (!isNaN(dateValue) && dateValue > 25569) {
            // Excel date (days since 1900)
            const excelDate = new Date((dateValue - 25569) * 86400 * 1000);
            return excelDate.toISOString().split('T')[0];
        }
        
        // Handle date-time strings like "2026-01-25 00:00:00"
        if (dateStr.includes(' ')) {
            dateStr = dateStr.split(' ')[0];
        }
        
        // Try common date formats
        const dateFormats = [
            /^(\d{4})-(\d{1,2})-(\d{1,2})$/,      // YYYY-MM-DD
            /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,    // MM/DD/YYYY or DD/MM/YYYY
            /^(\d{1,2})-(\d{1,2})-(\d{4})$/,      // DD-MM-YYYY
            /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/,    // DD.MM.YYYY
            /^(\d{4})(\d{2})(\d{2})$/,            // YYYYMMDD
            /^(\d{1,2})\/(\d{1,2})\/(\d{2})$/,    // MM/DD/YY
        ];
        
        for (const format of dateFormats) {
            const match = dateStr.match(format);
            if (match) {
                let year, month, day;
                
                if (format.source.includes('YYYY') || format.source.includes('YY')) {
                    // Format with explicit year
                    if (format.source.startsWith('^\\d{4}')) {
                        // YYYY-MM-DD or YYYYMMDD
                        year = parseInt(match[1]);
                        month = parseInt(match[2]) - 1;
                        day = parseInt(match[3]);
                    } else {
                        // Other formats
                        if (match[3].length === 4) {
                            year = parseInt(match[3]);
                            month = parseInt(match[1]) - 1;
                            day = parseInt(match[2]);
                        } else {
                            // 2-digit year
                            year = 2000 + parseInt(match[3]);
                            month = parseInt(match[1]) - 1;
                            day = parseInt(match[2]);
                        }
                    }
                    
                    const date = new Date(year, month, day);
                    if (!isNaN(date.getTime())) {
                        return date.toISOString().split('T')[0];
                    }
                }
            }
        }
        
        // Try JavaScript Date parsing as last resort
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
            return date.toISOString().split('T')[0];
        }
        
        console.warn('Could not parse date:', dateValue);
        return new Date().toISOString().split('T')[0];
    }

    // VILU EXCEL SPECIFIC PROCESSING - FIXED VERSION
    processViluExcelFormat(data) {
        console.log('Processing VILU Excel format with raw data:', data);
        
        const reservations = [];
        const today = new Date().toISOString().split('T')[0];
        
        let contactPerson = '';
        let guestSectionStart = -1;
        
        // First pass: Find customer information and guest section
        for (let i = 0; i < data.length; i++) {
            const row = data[i];
            
            // Skip empty rows
            if (!row || row.length === 0) continue;
            
            // Look for "Contact Person:" in row
            for (let j = 0; j < row.length; j++) {
                const cell = row[j];
                if (typeof cell === 'string') {
                    const cellLower = cell.toLowerCase().trim();
                    
                    // Find contact person - look for "Contact Person:" in any cell
                    if (cellLower === 'contact person:' || cellLower.includes('contact person')) {
                        // Contact person value is usually in the same row, next cell or same cell
                        // Try to extract from the cell itself if it contains ":"
                        if (cell.includes(':')) {
                            const parts = cell.split(':');
                            if (parts.length > 1) {
                                contactPerson = parts[1].trim();
                                if (!contactPerson) {
                                    // Check next cell in same row
                                    for (let k = j + 1; k < row.length; k++) {
                                        if (row[k] && row[k].toString().trim() !== '') {
                                            contactPerson = row[k].toString().trim();
                                            break;
                                        }
                                    }
                                }
                            }
                        } else {
                            // Check next cells for contact person value
                            for (let k = j + 1; k < row.length; k++) {
                                if (row[k] && row[k].toString().trim() !== '') {
                                    contactPerson = row[k].toString().trim();
                                    break;
                                }
                            }
                        }
                        console.log('Found contact person:', contactPerson, 'at row', i, 'col', j);
                    }
                    
                    // Find guest information section - look for "Guest Name" header
                    if (cellLower === 'guest name' && guestSectionStart === -1) {
                        guestSectionStart = i;
                        console.log('Guest section header found at row:', i, 'cell:', j);
                        // Check the next row for column headers
                        if (i + 1 < data.length) {
                            const nextRow = data[i + 1];
                            console.log('Next row (column headers):', nextRow);
                        }
                    }
                }
            }
        }
        
        // Use contact person as customer
        const customerName = contactPerson || 'Unknown Customer';
        
        console.log('Using customer:', customerName);
        console.log('Guest section starts at row:', guestSectionStart);
        
        // Second pass: Process guest rows
        if (guestSectionStart !== -1) {
            // Start from 2 rows after the header (header row + column labels row)
            const dataStartRow = guestSectionStart + 2;
            
            console.log('Processing guest data from row:', dataStartRow);
            
            for (let i = dataStartRow; i < data.length; i++) {
                const row = data[i];
                
                // Skip empty rows or rows with no guest name
                if (!row || row.length < 1) continue;
                
                const guestName = row[0]; // Guest Name is first column
                
                // Skip if no guest name or if it's empty
                if (!guestName || guestName.toString().trim() === '') {
                    continue;
                }
                
                console.log('Processing guest row', i, ':', row);
                
                // VILU Excel column mapping based on the provided sample:
                // 0: Guest Name
                // 1-5: Empty or other data
                // 6: Passport No
                // 7-8: Empty
                // 9: Country (Nationality)
                // 10-11: Empty
                // 12: Flight No (Arrival)
                // 13: Flight Time (Arrival)
                // 14: Flight Date (Arrival)
                // 15: Flight No (Departure)
                // 16: Flight Time (Departure)
                // 17: Flight Date (Departure)
                
                // Determine direction and extract flight info
                let direction = 'Arrival';
                let flightHotel = '';
                let rawTime = '';
                let rawDate = '';
                let nationality = '';
                
                // Check if we have departure flight info
                const hasDepartureInfo = row[15] && row[15].toString().trim() !== '';
                
                if (hasDepartureInfo) {
                    // This is a departure
                    direction = 'Departure';
                    flightHotel = row[15] ? row[15].toString().trim() : '';
                    rawTime = row[16] ? row[16].toString().trim() : '';
                    rawDate = row[17] ? row[17].toString().trim() : '';
                } else {
                    // This is an arrival (default)
                    direction = 'Arrival';
                    flightHotel = row[12] ? row[12].toString().trim() : '';
                    rawTime = row[13] ? row[13].toString().trim() : '';
                    rawDate = row[14] ? row[14].toString().trim() : '';
                }
                
                // Get nationality from column 9 (Country)
                nationality = row[9] ? row[9].toString().trim() : '';
                // If Country is empty, set nationality to empty (not 'Unknown')
                
                // Parse date and time
                const parsedDate = this.parseDate(rawDate || today);
                const parsedTime = this.parseTime(rawTime || '00:00');
                
                // Create reservation object
                const reservation = {
                    customer: customerName,
                    reservationDate: parsedDate,
                    flightHotel: flightHotel || 'Unknown Flight',
                    eta: parsedTime,
                    direction: direction,
                    guestName: guestName.toString().trim(),
                    nationality: nationality, // Empty if Country was empty
                    remarks: `Imported from VILU Excel - ${direction}: ${flightHotel || 'No flight info'}`,
                    status: 'reserved',
                    isFOC: false,
                    createdAt: new Date().toISOString(),
                    createdBy: this.currentUser.username,
                    source: 'vilu_excel_import'
                };
                
                console.log('Created reservation:', reservation);
                
                // Validate the reservation
                if (this.validateReservation(reservation)) {
                    reservations.push(reservation);
                } else {
                    console.log('Invalid reservation skipped:', reservation);
                }
            }
        }
        
        console.log(`Found ${reservations.length} reservations in VILU format`);
        return reservations;
    }

    validateReservation(reservation) {
        // Check required fields
        const requiredFields = ['customer', 'guestName', 'flightHotel'];
        
        for (const field of requiredFields) {
            if (!reservation[field] || reservation[field].toString().trim() === '') {
                console.log(`Missing required field: ${field}`, reservation);
                return false;
            }
        }
        
        // Validate date format (YYYY-MM-DD)
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (!dateRegex.test(reservation.reservationDate)) {
            console.log('Invalid date format:', reservation.reservationDate);
            return false;
        }
        
        // Validate time format (HH:MM)
        const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
        if (!timeRegex.test(reservation.eta)) {
            console.log('Invalid time format:', reservation.eta);
            return false;
        }
        
        return true;
    }

    displayExcelPreview(data) {
        const previewContainer = document.getElementById('excelPreview');
        const previewHeader = document.getElementById('excelPreviewHeader');
        const previewBody = document.getElementById('excelPreviewBody');
        const previewCount = document.getElementById('previewCount');
        
        if (!previewContainer || !previewHeader || !previewBody) return;
        
        // Clear previous preview
        previewHeader.innerHTML = '';
        previewBody.innerHTML = '';
        
        if (data.length > 0) {
            // Create header row for preview
            const headers = [
                'Guest Name', 'Customer', 'Flight/Hotel', 'ETA', 
                'Direction', 'Nationality', 'Reservation Date', 'Status'
            ];
            
            // Create header row
            let headerHtml = '<tr>';
            headers.forEach(header => {
                headerHtml += `<th>${header}</th>`;
            });
            headerHtml += '</tr>';
            previewHeader.innerHTML = headerHtml;
            
            // Create data rows
            let validCount = 0;
            const previewLimit = Math.min(10, data.length);
            
            for (let i = 0; i < previewLimit; i++) {
                const reservation = data[i];
                const isValid = this.validateReservation(reservation);
                
                let rowHtml = '<tr>';
                
                // Guest Name
                rowHtml += `<td><strong>${reservation.guestName || ''}</strong></td>`;
                
                // Customer
                rowHtml += `<td>${reservation.customer || ''}</td>`;
                
                // Flight/Hotel
                rowHtml += `<td>${reservation.flightHotel || ''}</td>`;
                
                // ETA
                rowHtml += `<td>${reservation.eta || ''}</td>`;
                
                // Direction
                rowHtml += `<td>${reservation.direction || 'Arrival'}</td>`;
                
                // Nationality
                rowHtml += `<td>${reservation.nationality || ''}</td>`;
                
                // Reservation Date
                rowHtml += `<td>${reservation.reservationDate || ''}</td>`;
                
                // Validation Status
                rowHtml += `<td style="background-color: ${isValid ? '#d4edda' : '#f8d7da'}">
                    ${isValid ? ' Valid' : ' Invalid'}
                    <br><small>${!reservation.flightHotel || reservation.flightHotel === 'Unknown Flight' ? 'No flight' : ''}</small>
                </td>`;
                
                rowHtml += '</tr>';
                previewBody.innerHTML += rowHtml;
                
                if (isValid) validCount++;
            }
            
            // Add summary row
            previewBody.innerHTML += `
                <tr>
                    <td colspan="8" style="background-color: #e9ecef; font-weight: bold;">
                        Summary: ${validCount} valid / ${previewLimit} shown (Total: ${data.length} reservations)
                        ${validCount < data.length ? `<br><small>${data.length - validCount} invalid due to missing data</small>` : ''}
                    </td>
                </tr>
            `;
            
            previewCount.textContent = data.length;
            previewContainer.classList.remove('d-none');
            
            // Show sample of what will be uploaded
            if (data.length > 0) {
                const sample = data[0];
                const issues = [];
                if (!sample.customer || sample.customer === 'Unknown Customer') issues.push('Customer');
                if (!sample.flightHotel || sample.flightHotel === 'Unknown Flight') issues.push('Flight');
                if (sample.eta === '00:00') issues.push('ETA');
                
                let message = `VILU Excel detected! Found ${data.length} guest entries.\n\nSample entry:\n- Guest: ${sample.guestName}\n- Customer: ${sample.customer}\n- Flight: ${sample.flightHotel}\n- ETA: ${sample.eta}\n- Date: ${sample.reservationDate}\n- Direction: ${sample.direction}\n- Nationality: ${sample.nationality || '(empty)'}`;
                
                if (issues.length > 0) {
                    message += `\n\n Issues detected in sample: ${issues.join(', ')}`;
                    message += `\nPlease check the Excel format matches VILU template.`;
                }
                
                alert(message);
            }
        }
    }

    async uploadExcelData() {
        if (this.excelData.length === 0) {
            alert('No data to upload. Please select an Excel file first.');
            return;
        }

        // Filter valid reservations
        const reservations = this.excelData.filter(res => this.validateReservation(res));
        
        if (reservations.length === 0) {
            alert('No valid reservations found to upload.');
            return;
        }

        if (!confirm(`Are you sure you want to upload ${reservations.length} reservations?`)) {
            return;
        }

        let successCount = 0;
        let errorCount = 0;
        let skippedRows = [];

        // Show processing message
        alert(`Processing ${reservations.length} records... Please wait.`);

        // Process each reservation
        for (let i = 0; i < reservations.length; i++) {
            const reservation = reservations[i];
            try {
                // Add to Firebase
                await this.db.collection('reservations').add(reservation);
                successCount++;
                
                // Add to autocomplete sets
                if (reservation.customer) this.customers.add(reservation.customer);
                if (reservation.flightHotel) this.flightHotels.add(reservation.flightHotel);
                
            } catch (error) {
                console.error(`Error uploading reservation ${i + 1}:`, reservation, error);
                skippedRows.push({ 
                    index: i + 1, 
                    reason: error.message, 
                    guest: reservation.guestName 
                });
                errorCount++;
            }
        }

        // Show detailed results
        let resultMessage = `Upload completed!\n\nSuccess: ${successCount}\nFailed: ${errorCount}`;
        
        if (skippedRows.length > 0) {
            resultMessage += `\n\nSkipped Reservations (first 5):`;
            skippedRows.slice(0, 5).forEach(skip => {
                resultMessage += `\n#${skip.index} (${skip.guest}): ${skip.reason}`;
            });
            if (skippedRows.length > 5) {
                resultMessage += `\n... and ${skippedRows.length - 5} more`;
            }
        }
        
        alert(resultMessage);
        
        // Clear preview and refresh data
        this.clearExcelPreview();
        this.loadCheckinData();
        this.loadCheckoutData();
        this.loadFlightOptionsForCheckin();
        this.loadFlightOptionsForCheckout();
        this.loadCustomerOptionsForCheckin();
        this.loadCustomerOptionsForCheckout();
        this.loadReportOptions();
        this.updateStats();
        this.loadOverviewData();
    }

    clearExcelPreview() {
        const previewContainer = document.getElementById('excelPreview');
        const fileInput = document.getElementById('excelFileInput');
        
        if (previewContainer) previewContainer.classList.add('d-none');
        if (fileInput) fileInput.value = '';
        this.excelData = [];
    }

    downloadExcelTemplate() {
        // Create VILU Business Lounge template based on the provided format
        const viluTemplate = [
            ['VILU Business Lounge', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Seaplane Terminal', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Maldives Airports Company Limited', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Velana International Airport', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Hulhule 2200', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Republic of Maldives', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Booking Number:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['VILU BUSINESS LOUNGE SERVICE APPLICATION FORM', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['1- Service Applicant:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Name of Service Applicant:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Contact Person:', 'AIRLINE COMPANY CONTACT', '', '', '', '', 'Telephone/Mobile', '', '', 'Fax', '', '', 'Email', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Billing Address:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Contact Person', '', '', '', '', '', 'Telephone/Mobile', '', '', 'Fax', '', '', 'Email', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['2- Guest Information (if required more space please attach sheets in this format)', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Guest Name', '', '', '', '', '', 'Passport No:', '', '', 'Country', '', '', 'Arrival', '', '', 'Departure', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', 'Flight No', 'Flight Time', 'Flight Date', 'Flight No', 'Flight Time', 'Flight Date'],
            ['Haruka Yazaki', '', '', '', '', '', 'AB123456', '', '', 'Japan', '', '', 'Somerset', '07:15 Hrs', '2026-01-25', '', '', ''],
            ['Hayato Atagi', '', '', '', '', '', 'CD789012', '', '', 'Japan', '', '', 'Somerset', '07:15 Hrs', '2026-01-25', '', '', ''],
            ['Frank Johnsen', '', '', '', '', '', 'EF345678', '', '', 'Norway', '', '', 'EK656', '07:35 Hrs', '2026-01-25', '', '', ''],
            ['Ana-Maria Mereuta Johnsen', '', '', '', '', '', 'GH456789', '', '', 'Norway', '', '', 'EK656', '07:35 Hrs', '2026-01-25', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['4- Flight Details  (Please Tick ( ) required service below)', '', '', '', '', '', '5-  Preference (Please Tick ( ) below)', '', '', '', '', '', '', '', '', '', '', ''],
            ['Arrival', '', '', 'Departure', '', '', 'Gluten Free', '', 'Lactose Free', '', '', 'Vegan', '', '', 'Nut Allergy', '', '', ''],
            ['Airline:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Flight No.:', '', '', '', '', '', '6- Special Assistance (Please Tick ( ) the required service)', '', '', '', '', '', '', '', '', '', ''],
            ['Time:', '', '', '', '', '', 'Wheel Chair', '', '', 'Stretcher', '', '', '', 'Ambulance', '', '', '', ''],
            ['Date:', '', '', '', '', '', '7- If any special name preferred for "Name Board" please write below in capital letters', '', '', '', '', '', '', '', '', '', ''],
            ['Origin/Destination:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['I have read the terms and conditions for VILU Business Lounge (seaplane terminal)  service and agreed to abide by', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['8- Applicant Signatory:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Name', '', '', '', '', '', 'Designation', '', '', 'Date', '', '', 'Time', '', '', 'Stamp & Signature', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['9-  Authorized Signatory of MACL for VILU Business Lounge (seaplane terminal)', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Name', '', '', '', '', '', 'Designation', '', '', 'Date', '', '', 'Time', '', '', 'Stamp & Signature', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Important Information:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Reservation of VILU Business lounge (seaplane Terminal) for the following day shall be made, before 1900hrs of every day, and all late bookings must be notified  02 hours prior to the movement time.(Applications for early morning flights during non working hours will be counted from lounge opening time).VILU Business Lounge will be open from 0500am to 0900pm. For reservations the hotline is +(960)    and VILU Business lounge service application form" can be emailed to :   email:vilu.lounge@macl.aero', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            ['Telephone + (960) 7288007            Fax: + (960)  3331640               e-mail: vilu.lounge@macl.aero       website: www.macl.aero', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
        ];
        
        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(viluTemplate);
        
        // Set column widths for better readability
        const wscols = [];
        for (let i = 0; i < 18; i++) {
            wscols.push({ wch: 15 });
        }
        ws['!cols'] = wscols;
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'VILU Template');
        XLSX.writeFile(wb, 'VILU_Business_Lounge_Template.xlsx');
        
        alert('VILU Business Lounge template downloaded. Fill in rows 22-25 with guest information and set Contact Person in row 13.');
    }

    async exportToExcel() {
        const fromDateInput = document.getElementById('reportFromDate');
        const toDateInput = document.getElementById('reportToDate');
        const flightSelect = document.getElementById('reportFlightFilter');
        const customerSelect = document.getElementById('reportCustomerFilter');
        
        if (!fromDateInput || !toDateInput) return;
        
        const fromDate = fromDateInput.value;
        const toDate = toDateInput.value;
        const flightFilter = flightSelect ? flightSelect.value : '';
        const customerFilter = customerSelect ? customerSelect.value : '';
        
        if (fromDate && toDate && fromDate > toDate) {
            alert('From date cannot be after To date');
            return;
        }
        
        // Show loading
        alert('Generating Excel file... Please wait.');
        
        // Fetch data and export
        this.fetchDataForExport(fromDate, toDate, flightFilter, customerFilter);
    }

    async fetchDataForExport(fromDate, toDate, flightFilter, customerFilter) {
        try {
            const snapshot = await this.db.collection('reservations').get();
            const reservations = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                
                // Apply filters
                if (fromDate && toDate) {
                    const checkDate = data.checkoutDate || data.checkinDate || data.reservationDate;
                    if (!checkDate) return;
                    
                    if (checkDate < fromDate || checkDate > toDate) {
                        return;
                    }
                }
                
                if (flightFilter && data.flightHotel !== flightFilter) return;
                if (customerFilter && data.customer !== customerFilter) return;
                
                reservations.push(data);
            });
            
            if (reservations.length === 0) {
                alert('No data found for export.');
                return;
            }
            
            this.exportDataToExcel(reservations);
        } catch (error) {
            console.error('Error fetching data for export:', error);
            alert('Error generating Excel file.');
        }
    }

    exportDataToExcel(data) {
        // Prepare data for Excel
        const excelData = data.map(item => ({
            'Customer': item.customer,
            'Reservation Date': item.reservationDate,
            'Flight/Hotel': item.flightHotel,
            'ETA': item.eta,
            'Direction': item.direction,
            'Guest Name': item.guestName,
            'Nationality': item.nationality,
            'Status': item.status,
            'Guest Type': item.isFOC ? 'FOC' : 'Regular',
            'Check-In Time': item.checkinTime || '',
            'Check-Out Time': item.checkoutTime || '',
            'No-Show Time': item.noshowTime || '',
            'Remarks': item.remarks || '',
            'Created By': item.createdBy,
            'Created At': new Date(item.createdAt).toLocaleString()
        }));
        
        // Create worksheet
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Reservations');
        
        // Generate filename with date
        const dateStr = new Date().toISOString().split('T')[0];
        const filename = `Vilu_Lounge_Report_${dateStr}.xlsx`;
        
        // Download file
        XLSX.writeFile(wb, filename);
    }
}

// Initialize application
const app = new ReservationSystem();
    </script>
</body>
</html>
